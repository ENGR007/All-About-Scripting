<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --toolbar-height: 64px;
    --bg: #fdfcf7;
    --line-color: #e0d7c5;
    --border: #c0b090;
    --accent: #3367d6;
    --accent-soft: #e3ecff;
    --danger: #c0392b;
    --text-main: #333;
    --highlight-yellow: #fff59d;
    --sidebar-width: 220px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f0efe9;
    color: var(--text-main);
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  /* Full app wrapper */
  #app {
    display: flex;
    flex: 1;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
  }

  /* LEFT: Page list (Feature 6: B ‚Äì richer page list) */
  #pageSidebar {
    width: var(--sidebar-width);
    border-right: 1px solid #d3c8b5;
    background: #faf7f0;
    display: flex;
    flex-direction: column;
  }

  #pageSidebarHeader {
    padding: 8px 10px;
    border-bottom: 1px solid #e1d7c4;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    background: #f5efe2;
  }

  #pageSidebarHeader span {
    font-weight: 600;
  }

  #pageList {
    flex: 1;
    overflow-y: auto;
    padding: 6px 4px 8px;
  }

  .pageListItem {
    padding: 6px 8px;
    margin: 2px 4px;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .pageListItem span.title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .pageListItem small {
    opacity: 0.7;
    margin-left: 6px;
  }

  .pageListItem.active {
    background: var(--accent-soft);
    border: 1px solid var(--accent);
  }

  .pageListItem:not(.active):hover {
    background: rgba(0,0,0,0.04);
  }

  /* RIGHT: Main area */
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  /* Toolbar (top) */
  #toolbarWrapper {
    position: relative;
    z-index: 5;
  }

  #toolbar {
    height: var(--toolbar-height);
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-bottom: 1px solid #d3c8b5;
    background: linear-gradient(to bottom, #fdfbf6, #f5eee1);
  }

  #toolbar.hidden {
    transform: translateY(-100%);
    transition: transform 0.2s ease-out;
  }

  #toolbarHandle {
    height: 6px;
    background: rgba(0,0,0,0.04);
    border-bottom: 1px solid #d3c8b5;
    text-align: center;
    font-size: 0.7rem;
    line-height: 6px;
    cursor: pointer;
    user-select: none;
  }

  #toolbarHandle span {
    opacity: 0.5;
  }

  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 6px;
    border-right: 1px solid #e2d7c4;
    padding-right: 8px;
  }

  .toolbar-group:last-child {
    border-right: none;
  }

  button, input, select {
    font-family: inherit;
    font-size: 0.85rem;
  }

  button {
    border-radius: 999px;
    border: 1px solid #c7b99e;
    background: #fff;
    padding: 4px 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  button.active {
    border-color: var(--accent);
    background: var(--accent-soft);
  }

  button.danger {
    border-color: var(--danger);
    color: var(--danger);
  }

  button.small {
    padding: 2px 6px;
    font-size: 0.75rem;
  }

  button:hover {
    background: #fbf7ee;
  }

  #penSize {
    width: 80px;
  }

  #searchInput {
    width: 160px;
    padding: 3px 6px;
    border-radius: 999px;
    border: 1px solid #ccbda2;
  }

  #pageInfo {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-left: 4px;
  }

  #autosaveHint {
    font-size: 0.75rem;
    opacity: 0.6;
    margin-left: 6px;
  }

  /* Notebook area */
  #notebookWrapper {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: stretch;
    padding: 12px;
    background: radial-gradient(circle at top, #fdfbf5, #e9e2d2);
  }

  #notebook {
    position: relative;
    width: 100%;
    max-width: 900px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--bg);
    box-shadow:
      0 16px 32px rgba(0,0,0,0.16),
      0 0 0 1px rgba(255,255,255,0.7) inset;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Page header (per-page meta) */
  #pageHeader {
    padding: 6px 12px 6px;
    border-bottom: 1px solid #e0d4c0;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    background: linear-gradient(to right, #fdfbf7, #f7efe3);
    font-size: 0.8rem;
  }

  #pageTitleInput, #pageTagsInput {
    border-radius: 999px;
    border: 1px solid #d3c4a9;
    padding: 3px 10px;
    font-size: 0.8rem;
    min-width: 130px;
  }

  #pageHeader label {
    opacity: 0.8;
    margin-right: 2px;
  }

  #pageNotesInput {
    flex: 1;
    min-width: 160px;
    border-radius: 999px;
    border: 1px dashed #ccbda5;
    padding: 3px 10px;
    font-size: 0.8rem;
  }

  /* Canvas container with lined background */
  #pageCanvasWrapper {
    position: relative;
    flex: 1;
    margin: 8px 10px 10px;
    border-radius: 8px;
    overflow: hidden;
    background:
      repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent 26px,
        var(--line-color) 26px,
        var(--line-color) 27px
      );
  }

  #pageCanvas {
    display: block;
    width: 100%;
    height: 100%;
    cursor: crosshair;
  }

  /* Search results (Feature 3: B ‚Äì richer search) */
  #searchResults {
    position: absolute;
    right: 14px;
    top: calc(var(--toolbar-height) + 16px);
    max-height: 260px;
    width: 260px;
    background: rgba(253, 251, 246, 0.98);
    border-radius: 10px;
    border: 1px solid #d6c8b4;
    box-shadow: 0 12px 24px rgba(0,0,0,0.18);
    font-size: 0.8rem;
    overflow: hidden;
    display: none;
    z-index: 6;
  }

  #searchResultsHeader {
    padding: 6px 10px;
    border-bottom: 1px solid #e0d4c0;
    background: #f6efe2;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #searchResultsList {
    max-height: 210px;
    overflow-y: auto;
  }

  .searchResultItem {
    padding: 6px 10px;
    border-bottom: 1px solid #f0e5d2;
    cursor: pointer;
  }

  .searchResultItem:last-child {
    border-bottom: none;
  }

  .searchResultItem:hover {
    background: #f3ebde;
  }

  .searchResultItem strong {
    font-weight: 600;
  }

  /* Fullscreen mode */
  .fullscreen #app {
    max-width: none;
  }

  .fullscreen #notebookWrapper {
    padding: 4px;
  }

  .fullscreen #notebook {
    max-width: none;
    border-radius: 0;
  }

  .fullscreen #toolbarHandle {
    background: rgba(0,0,0,0.25);
    color: #fff;
    border-bottom-color: rgba(255,255,255,0.3);
  }

  .fullscreen #toolbarHandle span {
    opacity: 0.9;
  }

  /* Export / import controls (Feature 8: C ‚Äì file + text import) */
  #exportImportPanel {
    position: absolute;
    left: 50%;
    top: 52%;
    transform: translate(-50%, -50%);
    width: min(480px, 96vw);
    max-height: 70vh;
    background: #fffaf1;
    border-radius: 12px;
    border: 1px solid #d6c8b4;
    box-shadow: 0 18px 36px rgba(0,0,0,0.26);
    padding: 12px;
    font-size: 0.85rem;
    display: none;
    flex-direction: column;
    z-index: 20;
  }

  #exportImportPanel h3 {
    margin: 0 0 4px;
  }

  #exportImportPanel small {
    opacity: 0.7;
  }

  #exportArea {
    width: 100%;
    height: 80px;
    margin-top: 6px;
    font-family: monospace;
    font-size: 0.75rem;
    border-radius: 6px;
    border: 1px solid #d1c4aa;
    padding: 6px;
    background: #fffdf7;
  }

  #importFileInput {
    margin: 6px 0;
  }

  #exportImportButtons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 8px;
  }

  /* Small screens */
  @media (max-width: 900px) {
    #pageSidebar {
      display: none;
    }
    #toolbar {
      flex-wrap: wrap;
      height: auto;
      padding-bottom: 8px;
    }
    #searchResults {
      right: 6px;
      top: 90px;
      width: 230px;
    }
  }

  @media (max-width: 640px) {
    #pageHeader {
      flex-direction: column;
      align-items: stretch;
    }
    #pageTitleInput, #pageTagsInput, #pageNotesInput {
      width: 100%;
    }
  }
</style>
</head>
<body>
<div id="app">
  <!-- Sidebar: page list -->
  <aside id="pageSidebar">
    <div id="pageSidebarHeader">
      <span>Pages</span>
      <button id="addPageFromSidebar" class="small" title="Add new page">+ New</button>
    </div>
    <div id="pageList"></div>
  </aside>

  <!-- Main area -->
  <div id="main">
    <div id="toolbarWrapper">
      <div id="toolbar">
        <div class="toolbar-group">
          <button id="penToolBtn" class="active" title="Pen">‚úèÔ∏è Pen</button>
          <button id="highlighterToolBtn" title="Highlight">üñç Highlight</button>
          <button id="eraserToolBtn" title="Eraser">üßΩ Eraser</button>
        </div>

        <div class="toolbar-group">
          <button class="color-btn active" data-color="#000000" title="Black">‚ö´</button>
          <button class="color-btn" data-color="#0c4ab8" title="Blue">üîµ</button>
          <button class="color-btn" data-color="#c62828" title="Red">üî¥</button>
          <button class="color-btn" data-color="#fff59d" title="Highlight">‚ú® Highlight</button>
          <label style="font-size:0.75rem;">Size
            <input type="range" id="penSize" min="1" max="24" value="3">
          </label>
        </div>

        <div class="toolbar-group">
          <button id="undoBtn" title="Undo">‚Æ® Undo</button>
          <button id="redoBtn" title="Redo">‚Æ™ Redo</button>
          <button id="clearPageBtn" class="small danger" title="Clear current page">Clear Page</button>
        </div>

        <div class="toolbar-group">
          <button id="prevPageBtn" title="Previous page">‚óÄ</button>
          <button id="nextPageBtn" title="Next page">‚ñ∂</button>
          <span id="pageInfo">Page 1 / 1</span>
          <button id="addPageBtn" class="small" title="Add new page">+ Page</button>
        </div>

        <div class="toolbar-group">
          <input id="searchInput" type="text" placeholder="Search notes..." />
          <button id="searchBtn" class="small">Search</button>
          <span id="autosaveHint">Autosave: On (this browser)</span>
        </div>

        <div class="toolbar-group">
          <button id="exportImportBtn" class="small">Export / Import</button>
          <button id="fullscreenBtn" class="small" title="Toggle full screen">‚õ∂ Full</button>
        </div>
      </div>
      <div id="toolbarHandle">
        <span>Tap/click here to show/hide toolbar in full screen</span>
      </div>
    </div>

    <div id="notebookWrapper">
      <div id="notebook">
        <div id="pageHeader">
          <div>
            <label for="pageTitleInput">Title:</label>
            <input id="pageTitleInput" type="text" placeholder="Page title (for search)"/>
          </div>
          <div>
            <label for="pageTagsInput">Tags:</label>
            <input id="pageTagsInput" type="text" placeholder="e.g. work, ideas, meeting"/>
          </div>
          <input id="pageNotesInput" type="text" placeholder="Optional text notes for this page (searchable)" />
        </div>
        <div id="pageCanvasWrapper">
          <canvas id="pageCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Search results panel -->
    <div id="searchResults">
      <div id="searchResultsHeader">
        <span>Search results</span>
        <button id="closeSearchBtn" class="small">‚úï</button>
      </div>
      <div id="searchResultsList"></div>
    </div>

    <!-- Export / Import panel -->
    <div id="exportImportPanel">
      <h3>Export / Import Notebook</h3>
      <small>
        You can download your notebook as a JSON file, or copy/paste the JSON below to backup/restore.
      </small>

      <h4>Export</h4>
      <button id="downloadExportBtn" class="small">‚¨á Download JSON</button>
      <textarea id="exportArea" readonly></textarea>

      <h4>Import</h4>
      <small>Import will replace the current notebook. Only use trusted JSON you exported.</small>
      <input type="file" id="importFileInput" accept="application/json">
      <textarea id="importTextArea" placeholder="Or paste JSON here..." style="width:100%;height:80px;margin-top:4px;font-family:monospace;font-size:0.75rem;border-radius:6px;border:1px solid #d1c4aa;padding:6px;background:#fffdf7;"></textarea>

      <div id="exportImportButtons">
        <button id="importFromTextBtn" class="small">Import from Text</button>
        <button id="importFromFileBtn" class="small">Import from File</button>
        <button id="closeExportImportBtn" class="small">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const STORAGE_KEY = "browserNotebook_v1";

  const canvas = document.getElementById("pageCanvas");
  const ctx = canvas.getContext("2d");
  const notebookWrapper = document.getElementById("pageCanvasWrapper");

  // Toolbar elements
  const penToolBtn = document.getElementById("penToolBtn");
  const highlighterToolBtn = document.getElementById("highlighterToolBtn");
  const eraserToolBtn = document.getElementById("eraserToolBtn");
  const colorBtns = document.querySelectorAll(".color-btn");
  const penSizeInput = document.getElementById("penSize");
  const undoBtn = document.getElementById("undoBtn");
  const redoBtn = document.getElementById("redoBtn");
  const clearPageBtn = document.getElementById("clearPageBtn");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const addPageBtn = document.getElementById("addPageBtn");
  const addPageFromSidebarBtn = document.getElementById("addPageFromSidebar");
  const pageInfoSpan = document.getElementById("pageInfo");
  const fullscreenBtn = document.getElementById("fullscreenBtn");
  const toolbar = document.getElementById("toolbar");
  const toolbarHandle = document.getElementById("toolbarHandle");

  // Sidebar and search
  const pageListEl = document.getElementById("pageList");
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const searchResults = document.getElementById("searchResults");
  const searchResultsList = document.getElementById("searchResultsList");
  const closeSearchBtn = document.getElementById("closeSearchBtn");

  // Page meta
  const pageTitleInput = document.getElementById("pageTitleInput");
  const pageTagsInput = document.getElementById("pageTagsInput");
  const pageNotesInput = document.getElementById("pageNotesInput");

  // Export / Import
  const exportImportBtn = document.getElementById("exportImportBtn");
  const exportImportPanel = document.getElementById("exportImportPanel");
  const exportArea = document.getElementById("exportArea");
  const downloadExportBtn = document.getElementById("downloadExportBtn");
  const closeExportImportBtn = document.getElementById("closeExportImportBtn");
  const importFileInput = document.getElementById("importFileInput");
  const importTextArea = document.getElementById("importTextArea");
  const importFromFileBtn = document.getElementById("importFromFileBtn");
  const importFromTextBtn = document.getElementById("importFromTextBtn");

  // State
  let notebook = {
    pages: [],
    currentPageIndex: 0
  };

  // Each page: { id, title, tags, notesText, strokes: [], undoStack: [], redoStack: [] }
  // stroke: { color, size, points:[{x,y}], isEraser, isHighlight }

  let currentTool = "pen"; // pen | highlighter | eraser
  let currentColor = "#000000";
  let isDrawing = false;
  let currentStroke = null;

  // ========= INIT =========
  function init() {
    loadFromStorage();
    if (!notebook.pages || notebook.pages.length === 0) {
      notebook.pages = [createEmptyPage(1)];
      notebook.currentPageIndex = 0;
    }
    resizeCanvas();
    attachEvents();
    renderCurrentPage();
    renderPageList();
    updatePageInfo();
  }

  function createEmptyPage(id) {
    return {
      id,
      title: "",
      tags: "",
      notesText: "",
      strokes: [],
      undoStack: [],
      redoStack: []
    };
  }

  function resizeCanvas() {
    const rect = notebookWrapper.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + "px";
    canvas.style.height = rect.height + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    redrawPage();
  }

  window.addEventListener("resize", () => {
    resizeCanvas();
  });

  // ========= STORAGE =========
  function saveToStorage() {
    try {
      const data = JSON.stringify(notebook);
      localStorage.setItem(STORAGE_KEY, data);
    } catch (err) {
      console.error("Error saving notebook:", err);
    }
  }

  function loadFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && Array.isArray(parsed.pages)) {
        notebook = parsed;
      }
    } catch (err) {
      console.error("Error loading notebook:", err);
    }
  }

  // ========= PAGE RENDERING =========
  function getCurrentPage() {
    return notebook.pages[notebook.currentPageIndex];
  }

  function redrawPage() {
    const page = getCurrentPage();
    if (!page) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // Draw strokes
    for (const s of page.strokes) {
      drawStroke(s);
    }
  }

  function drawStroke(stroke) {
    if (!stroke.points || stroke.points.length === 0) return;
    ctx.save();
    if (stroke.isEraser) {
      ctx.globalCompositeOperation = "destination-out";
      ctx.lineWidth = stroke.size;
      ctx.strokeStyle = "rgba(0,0,0,1)";
    } else if (stroke.isHighlight) {
      ctx.globalCompositeOperation = "multiply";
      ctx.lineWidth = stroke.size;
      ctx.strokeStyle = stroke.color || "#fff59d";
    } else {
      ctx.globalCompositeOperation = "source-over";
      ctx.lineWidth = stroke.size;
      ctx.strokeStyle = stroke.color || "#000";
    }
    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    ctx.beginPath();
    const pts = stroke.points;
    ctx.moveTo(pts[0].x, pts[0].y);
    for (let i = 1; i < pts.length; i++) {
      ctx.lineTo(pts[i].x, pts[i].y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function renderCurrentPage() {
    const page = getCurrentPage();
    if (!page) return;
    pageTitleInput.value = page.title || "";
    pageTagsInput.value = page.tags || "";
    pageNotesInput.value = page.notesText || "";
    redrawPage();
  }

  function updatePageInfo() {
    const total = notebook.pages.length || 1;
    const current = notebook.currentPageIndex + 1;
    pageInfoSpan.textContent = `Page ${current} / ${total}`;
  }

  function renderPageList() {
    pageListEl.innerHTML = "";
    notebook.pages.forEach((page, index) => {
      const div = document.createElement("div");
      div.className = "pageListItem" + (index === notebook.currentPageIndex ? " active" : "");
      const title = page.title?.trim() || `Page ${index + 1}`;
      const firstWord = page.notesText?.trim().split(/\s+/)[0] || "";
      div.innerHTML = `<span class="title">${title}</span><small>#${page.id}${firstWord ? " ¬∑ " + firstWord : ""}</small>`;
      div.addEventListener("click", () => {
        notebook.currentPageIndex = index;
        renderCurrentPage();
        renderPageList();
        updatePageInfo();
        saveToStorage();
      });
      pageListEl.appendChild(div);
    });
  }

  // ========= DRAWING HANDLING =========
  function getCanvasPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  }

  function startStroke(evt) {
    evt.preventDefault();
    const page = getCurrentPage();
    if (!page) return;
    isDrawing = true;
    const pos = getCanvasPos(evt);
    currentStroke = {
      color: currentColor,
      size: parseInt(penSizeInput.value, 10) || 3,
      points: [pos],
      isEraser: currentTool === "eraser",
      isHighlight: currentTool === "highlighter"
    };
    // new stroke => clear redo stack
    page.redoStack = [];
    page.strokes.push(currentStroke);
    page.undoStack.push({ type: "add", stroke: currentStroke });
    drawStroke(currentStroke);
  }

  function moveStroke(evt) {
    if (!isDrawing || !currentStroke) return;
    evt.preventDefault();
    const pos = getCanvasPos(evt);
    currentStroke.points.push(pos);
    redrawPage();
  }

  function endStroke(evt) {
    if (!isDrawing) return;
    evt.preventDefault();
    isDrawing = false;
    currentStroke = null;
    saveToStorage();
  }

  canvas.addEventListener("mousedown", startStroke);
  canvas.addEventListener("mousemove", moveStroke);
  canvas.addEventListener("mouseup", endStroke);
  canvas.addEventListener("mouseleave", endStroke);
  canvas.addEventListener("touchstart", startStroke, { passive: false });
  canvas.addEventListener("touchmove", moveStroke, { passive: false });
  canvas.addEventListener("touchend", endStroke, { passive: false });
  canvas.addEventListener("touchcancel", endStroke, { passive: false });

  // ========= UNDO / REDO =========
  function undo() {
    const page = getCurrentPage();
    if (!page || page.strokes.length === 0) return;
    const stroke = page.strokes.pop();
    page.redoStack.push(stroke);
    redrawPage();
    saveToStorage();
  }

  function redo() {
    const page = getCurrentPage();
    if (!page || page.redoStack.length === 0) return;
    const stroke = page.redoStack.pop();
    page.strokes.push(stroke);
    redrawPage();
    saveToStorage();
  }

  // ========= PAGE ACTIONS =========
  function addPage() {
    const newId = notebook.pages.length
      ? Math.max(...notebook.pages.map(p => p.id)) + 1
      : 1;
    notebook.pages.push(createEmptyPage(newId));
    notebook.currentPageIndex = notebook.pages.length - 1;
    renderCurrentPage();
    renderPageList();
    updatePageInfo();
    saveToStorage();
  }

  function goToPrevPage() {
    if (notebook.currentPageIndex > 0) {
      notebook.currentPageIndex--;
      renderCurrentPage();
      renderPageList();
      updatePageInfo();
      saveToStorage();
    }
  }

  function goToNextPage() {
    if (notebook.currentPageIndex < notebook.pages.length - 1) {
      notebook.currentPageIndex++;
      renderCurrentPage();
      renderPageList();
      updatePageInfo();
      saveToStorage();
    }
  }

  function clearPage() {
    if (!confirm("Clear all handwriting on this page?")) return;
    const page = getCurrentPage();
    if (!page) return;
    page.strokes = [];
    page.undoStack = [];
    page.redoStack = [];
    redrawPage();
    saveToStorage();
  }

  // ========= TOOLS & COLORS =========
  function setTool(tool) {
    currentTool = tool; // "pen" | "highlighter" | "eraser"
    penToolBtn.classList.toggle("active", tool === "pen");
    highlighterToolBtn.classList.toggle("active", tool === "highlighter");
    eraserToolBtn.classList.toggle("active", tool === "eraser");
  }

  function setColor(color) {
    currentColor = color;
    colorBtns.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.color === color);
    });
    if (currentTool === "highlighter") {
      // keep highlight mode but update base color
      currentTool = "highlighter";
    } else if (currentTool === "eraser") {
      // eraser doesn't use color
    } else {
      currentTool = "pen";
    }
  }

  // ========= SEARCH (Feature 3: B ‚Äì results panel) =========
  function searchPages() {
    const query = searchInput.value.trim().toLowerCase();
    if (!query) {
      searchResults.style.display = "none";
      return;
    }
    const results = [];
    notebook.pages.forEach((page, index) => {
      const haystack = [
        page.title || "",
        page.tags || "",
        page.notesText || ""
      ].join(" ").toLowerCase();
      if (haystack.includes(query)) {
        results.push({ page, index });
      }
    });

    searchResultsList.innerHTML = "";
    if (results.length === 0) {
      const div = document.createElement("div");
      div.className = "searchResultItem";
      div.textContent = "No matches.";
      searchResultsList.appendChild(div);
    } else {
      results.forEach(result => {
        const div = document.createElement("div");
        div.className = "searchResultItem";
        const title = result.page.title?.trim() || `Page ${result.index + 1}`;
        const snippet = (result.page.notesText || "").split(/\s+/).slice(0, 12).join(" ");
        div.innerHTML = `<strong>Page ${result.index + 1}:</strong> ${title}<br><small>${snippet}</small>`;
        div.addEventListener("click", () => {
          notebook.currentPageIndex = result.index;
          renderCurrentPage();
          renderPageList();
          updatePageInfo();
          searchResults.style.display = "none";
          saveToStorage();
        });
        searchResultsList.appendChild(div);
      });
    }
    searchResults.style.display = "block";
  }

  // ========= EXPORT / IMPORT (Feature 8: C) =========
  function openExportImportPanel() {
    const json = JSON.stringify(notebook, null, 2);
    exportArea.value = json;
    exportImportPanel.style.display = "flex";
  }

  function closeExportImportPanel() {
    exportImportPanel.style.display = "none";
  }

  function downloadJSON() {
    const blob = new Blob([JSON.stringify(notebook, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    a.href = url;
    a.download = `notebook-export-${timestamp}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function applyImportedNotebook(obj) {
    if (!obj || !Array.isArray(obj.pages)) {
      alert("Invalid notebook JSON.");
      return;
    }
    notebook = obj;
    if (!notebook.pages.length) {
      notebook.pages = [createEmptyPage(1)];
      notebook.currentPageIndex = 0;
    } else if (notebook.currentPageIndex == null || notebook.currentPageIndex >= notebook.pages.length) {
      notebook.currentPageIndex = 0;
    }
    renderCurrentPage();
    renderPageList();
    updatePageInfo();
    saveToStorage();
    alert("Notebook imported successfully.");
  }

  function importFromFile() {
    const file = importFileInput.files[0];
    if (!file) {
      alert("Select a JSON file first.");
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const obj = JSON.parse(e.target.result);
        applyImportedNotebook(obj);
      } catch (err) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  }

  function importFromText() {
    const text = importTextArea.value.trim();
    if (!text) {
      alert("Paste notebook JSON first.");
      return;
    }
    try {
      const obj = JSON.parse(text);
      applyImportedNotebook(obj);
    } catch (err) {
      alert("Invalid JSON text.");
    }
  }

  // ========= FULLSCREEN & TOOLBAR HANDLE =========
  function toggleFullscreenMode() {
    document.body.classList.toggle("fullscreen");
  }

  function toggleToolbarVisibility() {
    toolbar.classList.toggle("hidden");
  }

  // ========= EVENT BINDINGS =========
  function attachEvents() {
    penToolBtn.addEventListener("click", () => setTool("pen"));
    highlighterToolBtn.addEventListener("click", () => setTool("highlighter"));
    eraserToolBtn.addEventListener("click", () => setTool("eraser"));

    colorBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const color = btn.dataset.color;
        setColor(color);
        if (color === "#fff59d") {
          setTool("highlighter");
        } else if (currentTool === "highlighter") {
          setTool("pen");
        }
      });
    });

    undoBtn.addEventListener("click", undo);
    redoBtn.addEventListener("click", redo);
    clearPageBtn.addEventListener("click", clearPage);

    prevPageBtn.addEventListener("click", goToPrevPage);
    nextPageBtn.addEventListener("click", goToNextPage);
    addPageBtn.addEventListener("click", addPage);
    addPageFromSidebarBtn.addEventListener("click", addPage);

    // Page meta inputs autosave
    function updatePageMeta() {
      const page = getCurrentPage();
      if (!page) return;
      page.title = pageTitleInput.value;
      page.tags = pageTagsInput.value;
      page.notesText = pageNotesInput.value;
      renderPageList();
      saveToStorage();
    }
    pageTitleInput.addEventListener("input", updatePageMeta);
    pageTagsInput.addEventListener("input", updatePageMeta);
    pageNotesInput.addEventListener("input", updatePageMeta);

    // Search
    searchBtn.addEventListener("click", searchPages);
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchPages();
    });
    closeSearchBtn.addEventListener("click", () => {
      searchResults.style.display = "none";
    });

    // Export / Import
    exportImportBtn.addEventListener("click", openExportImportPanel);
    closeExportImportBtn.addEventListener("click", closeExportImportPanel);
    downloadExportBtn.addEventListener("click", downloadJSON);
    importFromFileBtn.addEventListener("click", importFromFile);
    importFromTextBtn.addEventListener("click", importFromText);

    // Fullscreen
    fullscreenBtn.addEventListener("click", toggleFullscreenMode);

    // Toolbar handle (for full screen)
    toolbarHandle.addEventListener("click", toggleToolbarVisibility);
  }

  // Kick off
  init();
})();
</script>
</body>
</html>