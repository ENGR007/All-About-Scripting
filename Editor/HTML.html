<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Local GitHub ‚Äì Code & Commits</title>

<!-- CodeMirror (syntax highlighting) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>

<!-- JSZip for exporting project as ZIP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- js-beautify for auto-formatting HTML/CSS/JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.11/beautify-html.min.js"></script>

<style>
:root {
    --bg: #0d1117;
    --bg-soft: #161b22;
    --border: #30363d;
    --fg: #c9d1d9;
    --muted: #8b949e;
    --accent: #238636;
    --accent-hover: #2ea043;
    --danger: #f85149;
}

/* Light theme overrides */
:root[data-theme="light"] {
    --bg: #f5f5f5;
    --bg-soft: #ffffff;
    --border: #d0d7de;
    --fg: #24292f;
    --muted: #57606a;
    --accent: #238636;
    --accent-hover: #2ea043;
    --danger: #d1242f;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#topbar {
    background: #010409;
    border-bottom: 1px solid var(--border);
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
:root[data-theme="light"] #topbar {
    background: #ffffff;
}

#topbar-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

#app-title {
    font-weight: 600;
}

.badge {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 999px;
    border: 1px solid var(--border);
    color: var(--muted);
}

.small-label {
    font-size: 11px;
    color: var(--muted);
}

button {
    border-radius: 4px;
    border: 1px solid var(--border);
    background: #21262d;
    color: var(--fg);
    padding: 6px 10px;
    font-size: 13px;
    cursor: pointer;
}
button:hover {
    background: #30363d;
}
:root[data-theme="light"] button {
    background: #f6f8fa;
}
:root[data-theme="light"] button:hover {
    background: #e9eef2;
}
button.primary {
    background: var(--accent);
    border-color: var(--accent-hover);
}
button.primary:hover {
    background: var(--accent-hover);
}
button.danger {
    background: transparent;
    border-color: var(--danger);
    color: var(--danger);
}
button.full {
    width: 100%;
}

#container {
    height: calc(100vh - 48px);
}

/* HOME VIEW (file list only) */
#homeView {
    height: 100%;
    padding: 12px;
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
}

#homeHeaderButtons {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
}

#fileList {
    margin-top: 10px;
}

.file-row {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid transparent;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.file-row:hover {
    border-color: var(--border);
    background: var(--bg-soft);
}
.file-name {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

/* FILE VIEW (full screen) */
#fileView {
    height: 100%;
    display: none; /* hidden by default */
    flex-direction: column;
}

/* HEADER in file view */
#fileHeader {
    position: relative;
    padding: 8px 10px 6px 10px;
    border-bottom: 1px solid var(--border);
    text-align: center;
}

#fileHeader .small-label {
    display: inline-block;
    margin-bottom: 2px;
}

#fileHeaderName {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    font-weight: 500;
}

#closeFileBtn {
    position: absolute;
    right: 10px;
    top: 8px;
    padding: 4px 8px;
}

/* Buttons row (view/edit mode) */
#fileHeaderButtonsRow {
    margin-top: 6px;
    display: flex;
    justify-content: center;
}

.button-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
}

#fileMain {
    flex: 1;
    display: flex;
    min-height: 0;
}

/* Editor panel in file view */
#editorPanel {
    flex: 1;
    background: var(--bg-soft);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
}

#editorBox {
    flex: 1;
    width: 100%;
    height: 100%;
}

.CodeMirror {
    height: 100%;
    font-size: 13px;
}

/* Commits pane */
#commitsPane {
    width: 280px;
    background: #0d1117;
    border-left: 1px solid var(--border);
    padding: 10px;
    overflow-y: auto;
}
:root[data-theme="light"] #commitsPane {
    background: #f6f8fa;
}

.commit-item {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid transparent;
    margin-bottom: 6px;
    font-size: 12px;
}
.commit-item:hover {
    border-color: var(--border);
    background: #161b22;
    cursor: pointer;
}
:root[data-theme="light"] .commit-item:hover {
    background: #e9eef2;
}
.commit-msg {
    font-weight: 500;
}
.commit-meta {
    color: var(--muted);
    font-size: 11px;
}

#commitDetail {
    margin-top: 10px;
    border-top: 1px solid var(--border);
    padding-top: 8px;
}
.diff-container {
    display: flex;
    gap: 6px;
}
.diff-block {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.diff-block label {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
}
.diff-block textarea {
    width: 100%;
    height: 120px;
    font-size: 11px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--bg-soft);
    color: var(--fg);
    resize: vertical;
}

/* Responsive: stack editor + commits on small screens */
@media (max-width: 900px) {
    #fileMain { flex-direction: column; }
    #commitsPane {
        width: 100%;
        height: 200px;
        border-left: none;
        border-top: 1px solid var(--border);
    }
}
</style>
</head>
<body>

<div id="topbar">
    <div id="topbar-left">
        <span id="app-title">üìÅ Local GitHub</span>
        <span class="badge">Browser-only repo</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
        <span class="small-label">
            Use Download / ZIP and upload to Google Drive manually.
        </span>
        <button id="themeToggle" onclick="toggleTheme()">üåô</button>
    </div>
</div>

<div id="container">
    <!-- HOME VIEW: only list of files -->
    <div id="homeView">
        <div id="homeHeaderButtons">
            <button class="full primary" onclick="createFile()">‚ûï New File</button>
            <button class="full" onclick="exportZip()">üì¶ Export ZIP (files)</button>
            <button class="full" onclick="exportBackup()">üß© Backup All (files + commits)</button>
            <button class="full" onclick="startImportBackup()">‚¨ÜÔ∏è Import Backup</button>
        </div>
        <div class="small-label">FILES</div>
        <div id="fileList"></div>
    </div>

    <!-- FILE VIEW: full screen editor + commits -->
    <div id="fileView">
        <div id="fileHeader">
            <div class="small-label">FILE</div>
            <button id="closeFileBtn" onclick="closeFile()">‚úñ</button>
            <div id="fileHeaderName">(none)</div>

            <div id="fileHeaderButtonsRow">
                <!-- VIEW MODE BUTTONS -->
                <div id="viewButtons" class="button-row">
                    <button onclick="renameFile()">‚úèÔ∏è Rename</button>
                    <button class="danger" onclick="deleteFile()">üóë Delete</button>
                    <button onclick="openInBrowser()">üåê Open</button>
                    <button onclick="downloadFile()">‚¨áÔ∏è Download</button>
                    <button onclick="enterEditMode()">‚úçÔ∏è Edit</button>
                </div>

                <!-- EDIT MODE BUTTONS -->
                <div id="editButtons" class="button-row" style="display:none;">
                    <button onclick="undoEdit()">‚Ü©Ô∏è Undo</button>
                    <button onclick="redoEdit()">‚Ü™Ô∏è Redo</button>
                    <button onclick="searchInEditor()">üîç Search</button>
                    <button onclick="clearAllInEditor()">üßπ Clear All</button>
                    <button onclick="autoFormat()">‚ú® Format</button>
                    <button onclick="cancelEdit()">‚úñÔ∏è Cancel</button>
                    <button class="primary" onclick="saveAndCommit()">üíæ Commit</button>
                </div>
            </div>
        </div>

        <div id="fileMain">
            <div id="editorPanel">
                <textarea id="editorBox"></textarea>
            </div>
            <div id="commitsPane">
                <div class="small-label">COMMITS</div>
                <div id="commitList" style="margin-top:6px;"></div>
                <div id="commitDetail"></div>
            </div>
        </div>
    </div>
</div>

<!-- hidden file input for importing backup -->
<input type="file" id="importBackupInput" accept="application/json" style="display:none" onchange="handleImportBackup(event)">

<script>
const FILES_KEY = "vc_files";
const COMMITS_KEY = "vc_commits";

let currentFileName = null;
let cmEditor = null;
let isEditing = false;
let lastSearchTerm = "";
let lastSearchPos = 0;

// ----- Storage helpers -----
function getFilesMap() {
    return JSON.parse(localStorage.getItem(FILES_KEY) || "{}");
}
function setFilesMap(obj) {
    localStorage.setItem(FILES_KEY, JSON.stringify(obj));
}
function getCommitsMap() {
    return JSON.parse(localStorage.getItem(COMMITS_KEY) || "{}");
}
function setCommitsMap(obj) {
    localStorage.setItem(COMMITS_KEY, JSON.stringify(obj));
}

// ----- Theme toggle -----
function applyTheme() {
    const theme = document.documentElement.dataset.theme || "dark";
    const toggleBtn = document.getElementById("themeToggle");
    if (theme === "light") {
        toggleBtn.textContent = "üåô";
        if (cmEditor) cmEditor.setOption("theme", "default");
    } else {
        toggleBtn.textContent = "‚òÄÔ∏è";
        if (cmEditor) cmEditor.setOption("theme", "material-darker");
    }
}
function toggleTheme() {
    const current = document.documentElement.dataset.theme;
    const next = current === "light" ? "dark" : "light";
    document.documentElement.dataset.theme = next;
    localStorage.setItem("vc_theme", next);
    applyTheme();
}

// ----- View switching -----
function showHomeView() {
    document.getElementById("homeView").style.display = "flex";
    document.getElementById("fileView").style.display = "none";
    currentFileName = null;
    if (cmEditor) {
        cmEditor.setValue("");
        cmEditor.setOption("readOnly", true);
    }
    isEditing = false;
}
function showFileView() {
    document.getElementById("homeView").style.display = "none";
    document.getElementById("fileView").style.display = "flex";
}
function closeFile() {
    document.getElementById("commitList").innerHTML = "";
    document.getElementById("commitDetail").innerHTML = "";
    showHomeView();
}

// ----- Editing mode -----
function setEditingMode(on) {
    isEditing = on;
    if (cmEditor) cmEditor.setOption("readOnly", !on);
    document.getElementById("viewButtons").style.display = on ? "none" : "flex";
    document.getElementById("editButtons").style.display = on ? "flex" : "none";
}
function enterEditMode() {
    if (!currentFileName) {
        alert("Open a file first.");
        return;
    }
    setEditingMode(true);
}
function cancelEdit() {
    if (!currentFileName || !cmEditor) {
        setEditingMode(false);
        return;
    }
    const files = getFilesMap();
    const saved = files[currentFileName] ?? "";
    cmEditor.setValue(saved);
    setEditingMode(false);
}

// ----- CodeMirror setup -----
function setupEditor() {
    const textarea = document.getElementById("editorBox");
    cmEditor = CodeMirror.fromTextArea(textarea, {
        lineNumbers: true,
        mode: "text/plain",
        theme: "material-darker",
        readOnly: true
    });
    cmEditor.on("change", function() {
        if (isEditing) autoSaveDraft();
    });
}

// choose mode based on extension
function setEditorModeByFilename(name) {
    if (!cmEditor) return;
    let mode = "text/plain";
    if (name.endsWith(".html") || name.endsWith(".htm")) mode = "htmlmixed";
    else if (name.endsWith(".js")) mode = "javascript";
    else if (name.endsWith(".css")) mode = "css";
    else if (name.endsWith(".py")) mode = "python";
    else if (name.endsWith(".json")) mode = "javascript";
    cmEditor.setOption("mode", mode);
}

// ----- Files list -----
function loadFilesList() {
    const container = document.getElementById("fileList");
    container.innerHTML = "";
    const files = getFilesMap();
    const names = Object.keys(files).sort();

    if (names.length === 0) {
        const empty = document.createElement("div");
        empty.textContent = "No files yet.";
        empty.style.color = "#6e7681";
        empty.style.fontSize = "12px";
        container.appendChild(empty);
        return;
    }

    names.forEach(name => {
        const row = document.createElement("div");
        row.className = "file-row";
        row.onclick = () => openFile(name);

        const left = document.createElement("div");
        left.className = "file-name";
        left.textContent = name;

        const right = document.createElement("div");
        right.className = "small-label";
        right.textContent = "Open";

        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
    });
}

// ----- Create file -----
function createFile() {
    const name = prompt("New filename (e.g. index.html, main.py):");
    if (!name) return;

    const files = getFilesMap();
    if (files[name] !== undefined) {
        alert("A file with that name already exists.");
        return;
    }
    files[name] = "";
    setFilesMap(files);

    const commits = getCommitsMap();
    commits[name] = [];
    setCommitsMap(commits);

    loadFilesList();
    openFile(name);
    setEditingMode(true); // new file starts in edit mode
}

// ----- Rename file -----
function renameFile() {
    if (!currentFileName) {
        alert("No file selected.");
        return;
    }
    const newName = prompt("Rename file to:", currentFileName);
    if (!newName || newName === currentFileName) return;

    const files = getFilesMap();
    if (files[newName] !== undefined) {
        alert("A file with that name already exists.");
        return;
    }

    files[newName] = files[currentFileName];
    delete files[currentFileName];
    setFilesMap(files);

    const commits = getCommitsMap();
    if (commits[currentFileName]) {
        commits[newName] = commits[currentFileName];
        delete commits[currentFileName];
    }
    setCommitsMap(commits);

    currentFileName = newName;
    document.getElementById("fileHeaderName").textContent = currentFileName;
    setEditorModeByFilename(currentFileName);
    loadFilesList();
    loadCommits(currentFileName);
}

// ----- Delete file -----
function deleteFile() {
    if (!currentFileName) {
        alert("No file selected.");
        return;
    }
    if (!confirm("Delete file '" + currentFileName + "' and its commits?")) return;

    const files = getFilesMap();
    delete files[currentFileName];
    setFilesMap(files);

    const commits = getCommitsMap();
    delete commits[currentFileName];
    setCommitsMap(commits);

    loadFilesList();
    closeFile();
}

// ----- Open file -----
function openFile(name) {
    currentFileName = name;
    document.getElementById("fileHeaderName").textContent = name;

    const files = getFilesMap();
    const content = files[name] ?? "";

    if (cmEditor) {
        cmEditor.setValue(content);
        setEditorModeByFilename(name);
    }

    setEditingMode(false);
    lastSearchTerm = "";
    lastSearchPos = 0;

    loadCommits(name);
    document.getElementById("commitDetail").innerHTML = "";
    showFileView();
}

// ----- Auto-save draft -----
function autoSaveDraft() {
    if (!currentFileName || !cmEditor) return;
    const files = getFilesMap();
    files[currentFileName] = cmEditor.getValue();
    setFilesMap(files);
}

// ----- Save & Commit -----
function saveAndCommit() {
    if (!currentFileName || !cmEditor) {
        alert("No file open.");
        return;
    }

    const content = cmEditor.getValue();
    const msg = prompt("Commit message:", "Update " + currentFileName);
    if (msg === null) return;

    const files = getFilesMap();
    files[currentFileName] = content;
    setFilesMap(files);

    const commits = getCommitsMap();
    if (!commits[currentFileName]) commits[currentFileName] = [];
    commits[currentFileName].push({
        id: Date.now(),
        message: msg || "Update",
        content: content,
        date: new Date().toLocaleString()
    });
    setCommitsMap(commits);

    loadCommits(currentFileName);
    setEditingMode(false);
    alert("Saved & committed!");
}

// ----- Commits -----
function loadCommits(fileName) {
    const listDiv = document.getElementById("commitList");
    listDiv.innerHTML = "";
    const commitsMap = getCommitsMap();
    const list = commitsMap[fileName] || [];

    if (list.length === 0) {
        listDiv.innerHTML = "<div style='color:#6e7681;font-size:12px;'>No commits yet.</div>";
        return;
    }

    list.slice().reverse().forEach(commit => {
        const item = document.createElement("div");
        item.className = "commit-item";
        item.innerHTML = `
            <div class="commit-msg">${commit.message}</div>
            <div class="commit-meta">${commit.date}</div>
        `;
        item.onclick = () => showCommitDetail(fileName, commit);
        listDiv.appendChild(item);
    });
}

// Show diff + rollback button
function showCommitDetail(fileName, commit) {
    const detailDiv = document.getElementById("commitDetail");
    const files = getFilesMap();
    const currentContent = files[fileName] ?? "";

    detailDiv.innerHTML = `
        <div class="small-label" style="margin-bottom:4px;">
            Commit: ${commit.message} ‚Ä¢ ${commit.date}
        </div>
        <div class="diff-container">
            <div class="diff-block">
                <label>Commit version</label>
                <textarea readonly>${commit.content}</textarea>
            </div>
            <div class="diff-block">
                <label>Current file</label>
                <textarea readonly>${currentContent}</textarea>
            </div>
        </div>
        <div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end;">
            <button onclick="rollbackCommit('${fileName.replace(/'/g, "\\'")}', ${commit.id})">‚è™ Rollback to this</button>
        </div>
    `;
}

// ----- Rollback to commit -----
function rollbackCommit(fileName, commitId) {
    const commitsMap = getCommitsMap();
    const list = commitsMap[fileName] || [];
    const commit = list.find(c => c.id === commitId);
    if (!commit) {
        alert("Commit not found.");
        return;
    }
    if (!confirm("Rollback '" + fileName + "' to this commit?")) return;

    const files = getFilesMap();
    files[fileName] = commit.content;
    setFilesMap(files);

    if (currentFileName === fileName && cmEditor) {
        cmEditor.setValue(commit.content);
    }
    setEditingMode(false);
    alert("Rolled back to selected commit.");
}

// ----- Download file -----
function downloadFile() {
    if (!currentFileName || !cmEditor) {
        alert("No file to download.");
        return;
    }
    const content = cmEditor.getValue();
    const blob = new Blob([content], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = currentFileName;
    a.click();
    URL.revokeObjectURL(url);
}

// ----- Open in browser -----
function openInBrowser() {
    if (!currentFileName || !cmEditor) {
        alert("Open a file first.");
        return;
    }
    const content = cmEditor.getValue();
    const isHtml = currentFileName.endsWith(".html") || currentFileName.endsWith(".htm");
    const type = isHtml ? "text/html" : "text/plain";
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
}

// ----- Auto-format -----
function autoFormat() {
    if (!isEditing || !currentFileName || !cmEditor) {
        alert("Enter edit mode first.");
        return;
    }
    const name = currentFileName.toLowerCase();
    let content = cmEditor.getValue();
    let formatted = content;

    try {
        if (name.endsWith(".html") || name.endsWith(".htm")) {
            formatted = window.html_beautify(content, {
                indent_size: 2,
                wrap_line_length: 120
            });
        } else if (name.endsWith(".css")) {
            formatted = window.css_beautify(content, {
                indent_size: 2
            });
        } else if (name.endsWith(".js") || name.endsWith(".json")) {
            formatted = window.js_beautify(content, {
                indent_size: 2,
                wrap_line_length: 120,
                space_in_empty_paren: false
            });
        } else if (name.endsWith(".py")) {
            formatted = smartPythonFormat(content);
        } else {
            alert("Auto-format not configured for this file type.");
            return;
        }
        cmEditor.setValue(formatted);
        autoSaveDraft();
    } catch (e) {
        console.error(e);
        alert("Error while formatting code.");
    }
}

// Smarter Python indentation formatter
function smartPythonFormat(code) {
    const TAB = "    ";
    const lines = code.replace(/\t/g, TAB).split("\n");
    let indentLevel = 0;
    const result = [];
    const dedentKeywords = /^(elif\b|else:|except\b|finally:)/;

    for (let raw of lines) {
        const stripped = raw.trim();
        if (stripped === "") {
            result.push("");
            continue;
        }
        if (dedentKeywords.test(stripped) && indentLevel > 0) {
            indentLevel -= 1;
        }
        result.push(TAB.repeat(indentLevel) + stripped);
        const isCommentOnly = stripped.startsWith("#");
        if (!isCommentOnly && stripped.endsWith(":")) {
            indentLevel += 1;
        }
    }
    return result.join("\n");
}

// ----- Undo / Redo / Search / Clear All -----
function undoEdit() {
    if (!isEditing || !cmEditor) return;
    cmEditor.undo();
}
function redoEdit() {
    if (!isEditing || !cmEditor) return;
    cmEditor.redo();
}
function searchInEditor() {
    if (!isEditing || !cmEditor) {
        alert("Enter edit mode first.");
        return;
    }
    const term = prompt("Search for:", lastSearchTerm || "");
    if (!term) return;

    const content = cmEditor.getValue();
    const startIndex = lastSearchTerm === term ? lastSearchPos : 0;
    const index = content.indexOf(term, startIndex);

    if (index === -1) {
        alert("Not found.");
        lastSearchTerm = "";
        lastSearchPos = 0;
        return;
    }

    const doc = cmEditor.getDoc();
    const from = doc.posFromIndex(index);
    const to = doc.posFromIndex(index + term.length);
    doc.setSelection(from, to);
    cmEditor.scrollIntoView({ from, to });

    lastSearchTerm = term;
    lastSearchPos = index + term.length;
}
function clearAllInEditor() {
    if (!isEditing || !cmEditor) {
        alert("Enter edit mode first.");
        return;
    }
    if (!confirm("Clear all code in this file?")) return;
    cmEditor.setValue("");
    autoSaveDraft();
    cmEditor.focus();
}

// ----- Export project as ZIP (files only) -----
function exportZip() {
    const files = getFilesMap();
    const names = Object.keys(files);
    if (names.length === 0) {
        alert("No files to export.");
        return;
    }
    const zip = new JSZip();
    names.forEach(name => {
        zip.file(name, files[name]);
    });
    zip.generateAsync({ type: "blob" }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "project-files.zip";
        a.click();
        URL.revokeObjectURL(url);
    });
}

// ----- Backup / Restore (files + commits + theme) -----
function exportBackup() {
    const data = {
        version: 1,
        files: getFilesMap(),
        commits: getCommitsMap(),
        theme: document.documentElement.dataset.theme || "dark"
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "local-github-backup.json";
    a.click();
    URL.revokeObjectURL(url);
}

function startImportBackup() {
    const input = document.getElementById("importBackupInput");
    if (input) input.click();
}

function handleImportBackup(event) {
    const file = event.target.files && event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (!data || typeof data !== "object") throw new Error("Invalid JSON");
            if (!data.files || !data.commits) {
                alert("Backup file missing files/commits data.");
                return;
            }
            if (!confirm("Importing backup will REPLACE your current files and commits. Continue?")) {
                return;
            }
            setFilesMap(data.files || {});
            setCommitsMap(data.commits || {});
            if (data.theme) {
                document.documentElement.dataset.theme = data.theme;
                localStorage.setItem("vc_theme", data.theme);
                applyTheme();
            }
            loadFilesList();
            showHomeView();
            alert("Backup imported successfully.");
        } catch (err) {
            console.error(err);
            alert("Could not import backup: invalid file.");
        } finally {
            event.target.value = "";
        }
    };
    reader.readAsText(file);
}

// ----- Init -----
setupEditor();
document.documentElement.dataset.theme = localStorage.getItem("vc_theme") || "dark";
applyTheme();
loadFilesList();
showHomeView();
</script>
</body>
</html>