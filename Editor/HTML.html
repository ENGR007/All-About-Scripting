<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Local GitHub ‚Äì Mini Version Control</title>
<style>
body { font-family: Arial; margin: 0; }
#topbar {
    background: #24292e;
    color: white;
    padding: 12px;
    display: flex;
    justify-content: space-between;
}
#container { display: flex; height: 100vh; }
#sidebar {
    width: 220px;
    background: #f6f8fa;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    padding: 10px;
}
#editor {
    flex: 1;
    display: flex;
    flex-direction: column;
}
textarea {
    flex: 1;
    width: 100%;
    border: none;
    outline: none;
    padding: 12px;
    font-family: monospace;
    font-size: 14px;
}
button { margin: 5px 0; width: 100%; }
#commitsPane {
    background: white;
    border-left: 1px solid #ccc;
    width: 250px;
    overflow-y: auto;
}
.commit-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.commit-item:hover { background: #f0f0f0; cursor: pointer; }
</style>
</head>

<body>

<div id="topbar">
    <div>üìÅ Local GitHub</div>
    <button onclick="pickFolder()">Choose Folder</button>
</div>

<div id="container">
    <div id="sidebar">
        <button onclick="createFile()">‚ûï New File</button>
        <h4>Files</h4>
        <div id="fileList"></div>
    </div>

    <div id="editor">
        <h3 id="currentFileName"></h3>
        <textarea id="editorBox" oninput="autoSaveDraft()"></textarea>
        <button onclick="saveAndCommit()">üíæ Save & Commit</button>
    </div>

    <div id="commitsPane">
        <h3>Commits</h3>
        <div id="commitList"></div>
    </div>
</div>

<script>
// --- GLOBAL ---
let folderHandle = null;
let currentFileHandle = null;
let currentFilePath = "";

// ---------- PICK FOLDER ----------
async function pickFolder() {
    folderHandle = await window.showDirectoryPicker();
    loadFiles();
}

// ---------- LOAD FILE TREE ----------
async function loadFiles() {
    const fileList = document.getElementById("fileList");
    fileList.innerHTML = "";

    for await (const entry of folderHandle.values()) {
        if (entry.kind === "file") {
            let div = document.createElement("div");
            div.textContent = entry.name;
            div.style.padding = "6px";
            div.onclick = () => openFile(entry);
            fileList.appendChild(div);
        }
    }
}

// ---------- CREATE FILE ----------
async function createFile() {
    const name = prompt("Filename (e.g. test.py)");
    if (!name) return;

    const newFile = await folderHandle.getFileHandle(name, { create: true });
    await writeFile(newFile, "");  // blank file
    loadFiles();
}

// ---------- OPEN FILE ----------
async function openFile(fileHandle) {
    currentFileHandle = fileHandle;
    currentFilePath = fileHandle.name;

    const file = await fileHandle.getFile();
    const text = await file.text();

    document.getElementById("editorBox").value = text;
    document.getElementById("currentFileName").textContent = currentFilePath;

    loadCommits(currentFilePath);
}

// ---------- SAVE TO DISK ----------
async function writeFile(fileHandle, content) {
    const writable = await fileHandle.createWritable();
    await writable.write(content);
    await writable.close();
}

// ---------- SAVE + COMMIT ----------
async function saveAndCommit() {
    if (!currentFileHandle) return;

    const content = document.getElementById("editorBox").value;

    await writeFile(currentFileHandle, content);

    const msg = prompt("Commit message:");
    saveCommit(currentFilePath, msg, content);

    loadCommits(currentFilePath);
    alert("Saved & committed!");
}

// ---------- COMMIT STORAGE (IndexedDB-ish using localStorage) ----------
function saveCommit(fileId, message, content) {
    let commits = JSON.parse(localStorage.getItem("commits") || "{}");
    if (!commits[fileId]) commits[fileId] = [];

    commits[fileId].push({
        id: Date.now(),
        message: message || "Update",
        content: content,
        date: new Date().toLocaleString()
    });

    localStorage.setItem("commits", JSON.stringify(commits));
}

// ---------- LOAD COMMITS ----------
function loadCommits(fileId) {
    const commitList = document.getElementById("commitList");
    commitList.innerHTML = "";

    const commits = JSON.parse(localStorage.getItem("commits") || "{}")[fileId] || [];

    commits.forEach(c => {
        const div = document.createElement("div");
        div.className = "commit-item";
        div.innerHTML = `<strong>${c.message}</strong><br>${c.date}`;
        div.onclick = () => showCommitOptions(fileId, c);
        commitList.appendChild(div);
    });
}

// ---------- COMMIT OPTIONS ----------
function showCommitOptions(fileId, commit) {
    if (confirm("Rollback to this version?")) {
        document.getElementById("editorBox").value = commit.content;
    }
}
</script>

</body>
</html>