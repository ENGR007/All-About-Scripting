<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Photo Editor - Heal & Tools</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: #111;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* TOP BAR */
  .topbar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    background: #111;
    border-bottom: 1px solid #222;
    font-size: 20px;
  }

  .topbar button {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 4px;
  }

  .topbar button:hover {
    opacity: 0.8;
  }

  /* MAIN CANVAS AREA */
  .editor-area {
    flex: 1;
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  #canvas {
    max-width: 100%;
    max-height: 100%;
    background: #fff;
    touch-action: none; /* allow drawing on touch */
  }

  /* BOTTOM TOOL PANEL */
  .panel {
    background: #000;
    border-top: 1px solid #222;
    padding: 10px 16px 8px;
  }

  .slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #sliderLabel {
    min-width: 130px;
    font-size: 13px;
    color: #ccc;
  }

  #toolSlider {
    flex: 1;
  }

  .heal-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }

  .heal-buttons button {
    background: #1a1a1a;
    border: 1px solid #444;
    padding: 7px 13px;
    border-radius: 999px;
    color: #ddd;
    cursor: pointer;
    font-size: 13px;
  }

  .heal-buttons button.active {
    background: #4d8aff;
    border-color: #4d8aff;
    color: #fff;
  }

  .instruction {
    margin-top: 10px;
    color: #aaa;
    font-size: 12px;
    line-height: 1.4;
  }

  /* BOTTOM MAIN FEATURE BAR (HEAL) */
  .bottom-nav {
    background: #080808;
    border-top: 1px solid #222;
    padding: 8px 16px 10px;
    font-size: 14px;
    display: flex;
    justify-content: center;
  }

  .bottom-nav span {
    font-weight: 600;
  }

  /* Small inline ‚Äútoast‚Äù message */
  .toast {
    position: absolute;
    left: 50%;
    bottom: 80px;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
</style>
</head>
<body>

<!-- TOP RIGHT ICONS -->
<div class="topbar">
  <button id="autoEnhanceBtn" title="Auto Enhance">‚ú®</button>
  <button id="uploadBtn"      title="Upload Image">üì§</button>
  <button id="downloadBtn"    title="Download Image">‚¨áÔ∏è</button>
</div>

<!-- MAIN EDIT AREA -->
<div class="editor-area">
  <canvas id="canvas"></canvas>
  <div id="toast" class="toast"></div>
</div>

<!-- HEAL TOOL PANEL -->
<div class="panel">
  <!-- Shared slider + dynamic label -->
  <div class="slider-row">
    <div id="sliderLabel">Heal Strength: 50%</div>
    <input id="toolSlider" type="range" min="0" max="100" value="50" />
  </div>

  <!-- Tools row: Heal, Remove, Patch, Clone, Remove Object, Eraser -->
  <div class="heal-buttons">
    <button data-tool="heal"        class="active">Heal</button>
    <button data-tool="remove">Remove</button>
    <button data-tool="patch">Patch</button>
    <button data-tool="clone">Clone</button>
    <button data-tool="removeObject">Remove Object</button>
    <button data-tool="erase">Eraser</button>
  </div>

  <div class="instruction">
    1) Tap a tool (Heal, Remove, Patch, Clone, Remove Object, Eraser).<br>
    2) Use the slider to adjust size / strength / blend for that tool.<br>
    3) For <b>Clone</b> and <b>Patch</b>, first tap sets the source area, then drag to apply.<br>
    Note: This is a lightweight browser version, not full Photoshop, but all tools really edit pixels.
  </div>
</div>

<!-- MAIN FEATURE BAR -->
<div class="bottom-nav">
  <span>Main feature: Heal (other tools will grow here later)</span>
</div>

<script>
  const canvas = document.getElementById("canvas");
  const ctx     = canvas.getContext("2d");
  const uploadBtn      = document.getElementById("uploadBtn");
  const downloadBtn    = document.getElementById("downloadBtn");
  const autoEnhanceBtn = document.getElementById("autoEnhanceBtn");
  const slider         = document.getElementById("toolSlider");
  const sliderLabel    = document.getElementById("sliderLabel");
  const toast          = document.getElementById("toast");

  // Set initial canvas size
  function resizeCanvas() {
    const h = window.innerHeight - 120; // approx top+bottom
    canvas.width  = window.innerWidth;
    canvas.height = h > 200 ? h : 200;
    // Fill white background initially
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  // Current tool state
  let currentTool = "heal";
  let sliderValue = 50;

  let isDrawing = false;
  let cloneSource = null;
  let patchSource = null;

  // For pointer handling
  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left) * (canvas.width / rect.width),
      y: (evt.clientY - rect.top)  * (canvas.height / rect.height)
    };
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.opacity = 1;
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => {
      toast.style.opacity = 0;
    }, 1500);
  }

  // ---- TOOLS + SLIDER LABEL ----
  function updateSliderLabel() {
    const v = sliderValue;
    let text;
    switch (currentTool) {
      case "heal":
        text = `Heal Strength: ${v}%`;
        break;
      case "remove":
        text = `Remove Strength: ${v}%`;
        break;
      case "patch":
        text = `Patch Blend: ${v}%`;
        break;
      case "clone":
        text = `Clone Softness: ${v}%`;
        break;
      case "removeObject":
        text = `AI Removal Strength: ${v}%`;
        break;
      case "erase":
        text = `Eraser Opacity: ${v}%`;
        break;
      default:
        text = `Level: ${v}%`;
    }
    sliderLabel.textContent = text;
  }

  slider.addEventListener("input", (e) => {
    sliderValue = parseInt(e.target.value, 10);
    updateSliderLabel();
  });

  // tool buttons
  document.querySelectorAll(".heal-buttons button").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".heal-buttons button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentTool = btn.dataset.tool;
      // Reset special sources when switching tools
      if (currentTool !== "clone") cloneSource = null;
      if (currentTool !== "patch") patchSource = null;
      updateSliderLabel();
    });
  });

  // ---- IMAGE UPLOAD ----
  uploadBtn.addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        // Resize canvas to fit image as best as possible
        const maxW = window.innerWidth;
        const maxH = window.innerHeight - 120;
        let w = img.width, h = img.height;
        const scale = Math.min(maxW / w, maxH / h, 1);
        w *= scale; h *= scale;

        canvas.width  = w;
        canvas.height = h;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);
      };
      img.src = URL.createObjectURL(file);
    };
    input.click();
  });

  // ---- DOWNLOAD ----
  downloadBtn.addEventListener("click", () => {
    const a = document.createElement("a");
    a.download = "edited_photo.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
  });

  // ---- AUTO ENHANCE (simple brightness + contrast) ----
  autoEnhanceBtn.addEventListener("click", () => {
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imgData.data;
    const brightness = 10;   // +10
    const contrast = 1.1;    // +10%

    for (let i = 0; i < data.length; i += 4) {
      // apply contrast
      data[i]   = contrast * (data[i]   - 128) + 128 + brightness; // R
      data[i+1] = contrast * (data[i+1] - 128) + 128 + brightness; // G
      data[i+2] = contrast * (data[i+2] - 128) + 128 + brightness; // B
    }
    ctx.putImageData(imgData, 0, 0);
    showToast("Auto Enhance applied");
  });

  // ---- BRUSH HELPERS ----

  function clamp(v, min, max) {
    return Math.max(min, Math.min(max, v));
  }

  function sampleAverageColor(x, y, radius) {
    radius = Math.max(2, radius | 0);
    const x0 = clamp(x - radius, 0, canvas.width - 1);
    const y0 = clamp(y - radius, 0, canvas.height - 1);
    const w  = clamp(radius * 2, 1, canvas.width - x0);
    const h  = clamp(radius * 2, 1, canvas.height - y0);

    const imgData = ctx.getImageData(x0, y0, w, h);
    const d = imgData.data;
    let r = 0, g = 0, b = 0, count = 0;
    for (let i = 0; i < d.length; i += 4) {
      r += d[i];
      g += d[i+1];
      b += d[i+2];
      count++;
    }
    if (count === 0) return { r: 255, g: 255, b: 255 };
    return { r: r / count, g: g / count, b: b / count };
  }

  // soft round brush filling
  function drawSoftBrush(x, y, radius, color, alpha) {
    ctx.save();
    const grd = ctx.createRadialGradient(x, y, 0, x, y, radius);
    const c0 = `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`;
    const c1 = `rgba(${color.r}, ${color.g}, ${color.b}, 0)`;
    grd.addColorStop(0, c0);
    grd.addColorStop(1, c1);
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  // simple "AI remove" = average from surrounding, strong heal
  function applyRemoveObject(x, y, strength) {
    const baseRadius = 12;
    const radius = baseRadius + strength * 0.6; // 12‚Äì72
    const sampled = sampleAverageColor(x, y, radius * 1.3);
    const alpha   = 0.6 + 0.4 * strength / 100; // 0.6‚Äì1.0
    drawSoftBrush(x, y, radius, sampled, alpha);
  }

  // heal / remove = softer local smoothing
  function applyHealOrRemove(x, y, strength, isRemove) {
    const baseRadius = 10;
    const radius = baseRadius + strength * 0.5; // 10‚Äì60
    const sampled = sampleAverageColor(x, y, radius * 1.1);
    let alphaBase = isRemove ? 0.7 : 0.4;
    const alpha   = alphaBase + 0.3 * strength / 100;
    drawSoftBrush(x, y, radius, sampled, alpha);
  }

  function applyClone(x, y, strength) {
    if (!cloneSource) return;
    const baseRadius = 12;
    const radius = baseRadius + strength * 0.5;
    const r = radius;

    const sx = clamp(cloneSource.x - r, 0, canvas.width - 1);
    const sy = clamp(cloneSource.y - r, 0, canvas.height - 1);
    const w  = clamp(r * 2, 1, canvas.width  - sx);
    const h  = clamp(r * 2, 1, canvas.height - sy);

    const dx = clamp(x - r, 0, canvas.width - w);
    const dy = clamp(y - r, 0, canvas.height - h);

    ctx.save();
    const softness = 0.3 + 0.7 * strength / 100; // 0.3‚Äì1.0
    ctx.globalAlpha = softness;
    ctx.drawImage(canvas, sx, sy, w, h, dx, dy, w, h);
    ctx.restore();
  }

  function applyPatch(x, y, strength) {
    if (!patchSource) return;
    const baseRadius = 20;
    const radius = baseRadius + strength * 0.4;
    const r = radius;

    const sx = clamp(patchSource.x - r, 0, canvas.width - 1);
    const sy = clamp(patchSource.y - r, 0, canvas.height - 1);
    const w  = clamp(r * 2, 1, canvas.width  - sx);
    const h  = clamp(r * 2, 1, canvas.height - sy);

    const dx = clamp(x - r, 0, canvas.width - w);
    const dy = clamp(y - r, 0, canvas.height - h);

    ctx.save();
    const blend = 0.5 + 0.5 * strength / 100; // 0.5‚Äì1.0
    ctx.globalAlpha = blend;
    ctx.drawImage(canvas, sx, sy, w, h, dx, dy, w, h);
    ctx.restore();
  }

  function applyErase(x, y, strength) {
    const baseRadius = 10;
    const radius = baseRadius + strength * 0.6;
    const alpha = strength / 100; // 0‚Äì1

    // erase toward white background
    const color = { r: 255, g: 255, b: 255 };
    drawSoftBrush(x, y, radius, color, alpha);
  }

  // ---- POINTER EVENTS ----
  canvas.addEventListener("pointerdown", (e) => {
    const pos = getPos(e);

    // First tap for clone/patch sets source
    if (currentTool === "clone" && !cloneSource) {
      cloneSource = { x: pos.x, y: pos.y };
      showToast("Clone source set. Now drag to copy.");
      return;
    }
    if (currentTool === "patch" && !patchSource) {
      patchSource = { x: pos.x, y: pos.y };
      showToast("Patch source set. Drag to apply.");
      return;
    }

    isDrawing = true;
    applyToolStroke(pos.x, pos.y);
  });

  canvas.addEventListener("pointermove", (e) => {
    if (!isDrawing) return;
    const pos = getPos(e);
    applyToolStroke(pos.x, pos.y);
  });

  function endDraw() {
    isDrawing = false;
  }
  canvas.addEventListener("pointerup", endDraw);
  canvas.addEventListener("pointerleave", endDraw);
  canvas.addEventListener("pointercancel", endDraw);

  function applyToolStroke(x, y) {
    const strength = sliderValue;

    switch (currentTool) {
      case "heal":
        applyHealOrRemove(x, y, strength, false);
        break;
      case "remove":
        applyHealOrRemove(x, y, strength, true);
        break;
      case "patch":
        applyPatch(x, y, strength);
        break;
      case "clone":
        applyClone(x, y, strength);
        break;
      case "removeObject":
        applyRemoveObject(x, y, strength);
        break;
      case "erase":
        applyErase(x, y, strength);
        break;
    }
  }

  // initial label
  updateSliderLabel();
</script>

</body>
</html>