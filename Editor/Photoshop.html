<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Photo Editor - Mobile Heal & Tools</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: #111;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    display: flex;
    flex-direction: column;
    height: 100dvh;          /* mobile-safe full height */
    overflow: hidden;        /* no scrolling */
  }

  /* TOP BAR */
  .topbar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 16px;
    padding: 8px 16px;
    background: #111;
    border-bottom: 1px solid #222;
    font-size: 20px;
    flex: 0 0 auto;
  }

  .topbar button {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 4px;
  }

  .topbar button:hover { opacity: 0.8; }

  /* MAIN CANVAS AREA */
  .editor-area {
    flex: 1 1 auto;
    min-height: 0;           /* flex fix */
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
  }

  #canvas {
    width: 100%;             /* visually fill area */
    height: 100%;
    background: #fff;
    touch-action: none;
    display: block;
  }

  /* Source circle overlay (for Clone / Patch) */
  .source-circle {
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid #4d8aff;
    box-shadow: 0 0 6px rgba(0,0,0,0.6);
    pointer-events: none;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.15s;
  }

  .source-circle.patch {
    border-color: #ffb84d;
  }

  /* BOTTOM TOOL PANEL */
  .panel {
    background: #000;
    border-top: 1px solid #222;
    padding: 8px 16px 6px;
    flex: 0 0 auto;
  }

  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  #sliderLabel {
    min-width: 130px;
    font-size: 12px;
    color: #ccc;
  }

  #toolSlider { flex: 1; }

  .heal-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .heal-buttons button {
    background: #1a1a1a;
    border: 1px solid #444;
    padding: 6px 11px;
    border-radius: 999px;
    color: #ddd;
    cursor: pointer;
    font-size: 12px;
  }

  .heal-buttons button.active {
    background: #4d8aff;
    border-color: #4d8aff;
    color: #fff;
  }

  .instruction {
    margin-top: 6px;
    color: #aaa;
    font-size: 11px;
    line-height: 1.4;
  }

  /* BOTTOM MAIN FEATURE BAR (HEAL) */
  .bottom-nav {
    background: #080808;
    border-top: 1px solid #222;
    padding: 6px 16px 8px;
    font-size: 13px;
    display: flex;
    justify-content: center;
    flex: 0 0 auto;
  }

  .bottom-nav span { font-weight: 600; }

  /* Toast message */
  .toast {
    position: absolute;
    left: 50%;
    bottom: 70px;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
</style>
</head>
<body>

<!-- TOP RIGHT ICONS -->
<div class="topbar">
  <button id="autoEnhanceBtn" title="Auto Enhance">‚ú®</button>
  <button id="uploadBtn"      title="Upload Image">üì§</button>
  <button id="downloadBtn"    title="Download Image">‚¨áÔ∏è</button>
</div>

<!-- MAIN EDIT AREA -->
<div class="editor-area">
  <canvas id="canvas"></canvas>
  <div id="sourceCircle" class="source-circle"></div>
  <div id="toast" class="toast"></div>
</div>

<!-- HEAL TOOL PANEL -->
<div class="panel">
  <div class="slider-row">
    <div id="sliderLabel">Heal Strength: 50%</div>
    <input id="toolSlider" type="range" min="0" max="100" value="50" />
  </div>

  <div class="heal-buttons">
    <button data-tool="heal" class="active">Heal</button>
    <button data-tool="remove">Remove</button>
    <button data-tool="patch">Patch</button>
    <button data-tool="clone">Clone</button>
    <button data-tool="removeObject">Remove Object</button>
    <button data-tool="erase">Eraser</button>
  </div>

  <div class="instruction">
    ‚Ä¢ <b>Heal</b> & <b>Remove</b>: just drag over blemishes (auto-source like PS Express).<br>
    ‚Ä¢ <b>Clone</b> / <b>Patch</b>: tap once to set the source circle, then drag to apply.<br>
    ‚Ä¢ Tap the tool button again to reset its source. The slider changes meaning per tool.
  </div>
</div>

<div class="bottom-nav">
  <span>Main feature: Heal (other tabs can be added later)</span>
</div>

<script>
  const canvas      = document.getElementById("canvas");
  const ctx         = canvas.getContext("2d");
  const editorArea  = document.querySelector(".editor-area");
  const sourceCircle = document.getElementById("sourceCircle");
  const toast       = document.getElementById("toast");

  const uploadBtn      = document.getElementById("uploadBtn");
  const downloadBtn    = document.getElementById("downloadBtn");
  const autoEnhanceBtn = document.getElementById("autoEnhanceBtn");
  const slider         = document.getElementById("toolSlider");
  const sliderLabel    = document.getElementById("sliderLabel");

  let currentTool = "heal";
  let sliderValue = 50;

  let isDrawing   = false;
  let cloneSource = null;   // {x,y} in canvas coords
  let patchSource = null;
  let baseImage   = null;

  /* -------- Layout: fit canvas to middle area -------- */
  function fitCanvasToEditor(redraw = true) {
    const rect = editorArea.getBoundingClientRect();
    const w = Math.max(1, rect.width);
    const h = Math.max(1, rect.height);
    canvas.width  = w;
    canvas.height = h;

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, w, h);

    if (redraw && baseImage) drawImageFit();
  }

  function drawImageFit() {
    if (!baseImage) return;
    const iw = baseImage.width;
    const ih = baseImage.height;
    const cw = canvas.width;
    const ch = canvas.height;

    const scale = Math.min(cw / iw, ch / ih);
    const w = iw * scale;
    const h = ih * scale;
    const x = (cw - w) / 2;
    const y = (ch - h) / 2;

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, cw, ch);
    ctx.drawImage(baseImage, x, y, w, h);
  }

  window.addEventListener("resize", () => fitCanvasToEditor(true));
  fitCanvasToEditor(false);

  /* -------- Slider + label -------- */
  function updateSliderLabel() {
    const v = sliderValue;
    let text;
    switch (currentTool) {
      case "heal":         text = `Heal Strength: ${v}%`; break;
      case "remove":       text = `Remove Strength: ${v}%`; break;
      case "patch":        text = `Patch Blend: ${v}%`; break;
      case "clone":        text = `Clone Softness: ${v}%`; break;
      case "removeObject": text = `AI Removal Strength: ${v}%`; break;
      case "erase":        text = `Eraser Opacity: ${v}%`; break;
      default:             text = `Level: ${v}%`;
    }
    sliderLabel.textContent = text;
  }

  slider.addEventListener("input", e => {
    sliderValue = parseInt(e.target.value, 10);
    updateSliderLabel();
  });
  updateSliderLabel();

  /* -------- Tool buttons (tap again = reset source) -------- */
  document.querySelectorAll(".heal-buttons button").forEach(btn => {
    btn.addEventListener("click", () => {
      const selectedTool = btn.dataset.tool;

      if (selectedTool === currentTool && (selectedTool === "clone" || selectedTool === "patch")) {
        // reset source on re-tap
        if (selectedTool === "clone") cloneSource = null;
        if (selectedTool === "patch") patchSource = null;
        hideSourceCircle();
        showToast("Source reset. Tap on photo to set new source.");
        return;
      }

      document.querySelectorAll(".heal-buttons button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentTool = selectedTool;

      if (currentTool !== "clone") cloneSource = null;
      if (currentTool !== "patch") patchSource = null;
      if (currentTool !== "clone" && currentTool !== "patch") hideSourceCircle();

      updateSliderLabel();
    });
  });

  /* -------- Toast helper -------- */
  function showToast(msg) {
    toast.textContent = msg;
    toast.style.opacity = 1;
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => toast.style.opacity = 0, 1500);
  }

  /* -------- Source circle helpers -------- */
  function showSourceCircleAt(tool, canvasX, canvasY) {
    const rect = editorArea.getBoundingClientRect();
    const scaleX = rect.width / canvas.width;
    const scaleY = rect.height / canvas.height;
    const cx = rect.left + canvasX * scaleX;
    const cy = rect.top  + canvasY * scaleY;

    sourceCircle.style.left = `${cx - rect.left}px`;
    sourceCircle.style.top  = `${cy - rect.top}px`;

    sourceCircle.classList.toggle("patch", tool === "patch");

    // size approx = brush radius
    const radius = 20 + sliderValue * 0.4;
    const cssR = radius * scaleX;
    sourceCircle.style.width  = `${cssR * 2}px`;
    sourceCircle.style.height = `${cssR * 2}px`;

    sourceCircle.style.opacity = 1;
  }

  function hideSourceCircle() {
    sourceCircle.style.opacity = 0;
  }

  /* -------- Upload / Download / Auto Enhance -------- */
  uploadBtn.addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        baseImage = img;
        fitCanvasToEditor(true);
      };
      img.src = URL.createObjectURL(file);
    };
    input.click();
  });

  downloadBtn.addEventListener("click", () => {
    const a = document.createElement("a");
    a.download = "edited_photo.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
  });

  autoEnhanceBtn.addEventListener("click", () => {
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const d = imgData.data;
    const brightness = 10;
    const contrast = 1.1;
    for (let i = 0; i < d.length; i += 4) {
      d[i]   = contrast * (d[i]   - 128) + 128 + brightness;
      d[i+1] = contrast * (d[i+1] - 128) + 128 + brightness;
      d[i+2] = contrast * (d[i+2] - 128) + 128 + brightness;
    }
    ctx.putImageData(imgData, 0, 0);
    showToast("Auto Enhance applied");
  });

  /* -------- Drawing helpers -------- */
  function clamp(v, min, max) {
    return Math.max(min, Math.min(max, v));
  }

  function getCanvasPos(evt) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: (evt.clientX - rect.left) * (canvas.width / rect.width),
      y: (evt.clientY - rect.top)  * (canvas.height / rect.height)
    };
  }

  function sampleAverageColor(x, y, radius) {
    radius = Math.max(2, radius | 0);
    const x0 = clamp(x - radius, 0, canvas.width - 1);
    const y0 = clamp(y - radius, 0, canvas.height - 1);
    const w  = clamp(radius * 2, 1, canvas.width  - x0);
    const h  = clamp(radius * 2, 1, canvas.height - y0);

    const imgData = ctx.getImageData(x0, y0, w, h);
    const d = imgData.data;
    let r = 0, g = 0, b = 0, count = 0;
    for (let i = 0; i < d.length; i += 4) {
      r += d[i]; g += d[i+1]; b += d[i+2]; count++;
    }
    if (!count) return { r: 255, g: 255, b: 255 };
    return { r: r / count, g: g / count, b: b / count };
  }

  function drawSoftBrush(x, y, radius, color, alpha) {
    ctx.save();
    const g = ctx.createRadialGradient(x, y, 0, x, y, radius);
    const c0 = `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`;
    const c1 = `rgba(${color.r}, ${color.g}, ${color.b}, 0)`;
    g.addColorStop(0, c0);
    g.addColorStop(1, c1);
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  function applyRemoveObject(x, y, strength) {
    const baseRadius = 12;
    const radius = baseRadius + strength * 0.6;
    const sampled = sampleAverageColor(x, y, radius * 1.3);
    const alpha = 0.6 + 0.4 * strength / 100;
    drawSoftBrush(x, y, radius, sampled, alpha);
  }

  function applyHealOrRemove(x, y, strength, isRemove) {
    const baseRadius = 10;
    const radius = baseRadius + strength * 0.5;
    const sampled = sampleAverageColor(x, y, radius * 1.1);
    let alphaBase = isRemove ? 0.7 : 0.4;
    const alpha = alphaBase + 0.3 * strength / 100;
    drawSoftBrush(x, y, radius, sampled, alpha);
  }

  function applyClone(x, y, strength) {
    if (!cloneSource) {
      showToast("Tap once to set Clone source.");
      return;
    }
    const baseRadius = 12;
    const radius = baseRadius + strength * 0.5;
    const r = radius;

    const sx = clamp(cloneSource.x - r, 0, canvas.width - 1);
    const sy = clamp(cloneSource.y - r, 0, canvas.height - 1);
    const w  = clamp(r * 2, 1, canvas.width  - sx);
    const h  = clamp(r * 2, 1, canvas.height - sy);

    const dx = clamp(x - r, 0, canvas.width - w);
    const dy = clamp(y - r, 0, canvas.height - h);

    ctx.save();
    const softness = 0.3 + 0.7 * strength / 100;
    ctx.globalAlpha = softness;
    ctx.drawImage(canvas, sx, sy, w, h, dx, dy, w, h);
    ctx.restore();
  }

  function applyPatch(x, y, strength) {
    if (!patchSource) {
      showToast("Tap once to set Patch source.");
      return;
    }
    const baseRadius = 20;
    const radius = baseRadius + strength * 0.4;
    const r = radius;

    const sx = clamp(patchSource.x - r, 0, canvas.width - 1);
    const sy = clamp(patchSource.y - r, 0, canvas.height - 1);
    const w  = clamp(r * 2, 1, canvas.width  - sx);
    const h  = clamp(r * 2, 1, canvas.height - sy);

    const dx = clamp(x - r, 0, canvas.width - w);
    const dy = clamp(y - r, 0, canvas.height - h);

    ctx.save();
    const blend = 0.5 + 0.5 * strength / 100;
    ctx.globalAlpha = blend;
    ctx.drawImage(canvas, sx, sy, w, h, dx, dy, w, h);
    ctx.restore();
  }

  function applyErase(x, y, strength) {
    const baseRadius = 10;
    const radius = baseRadius + strength * 0.6;
    const alpha  = strength / 100;
    const color  = { r: 255, g: 255, b: 255 };
    drawSoftBrush(x, y, radius, color, alpha);
  }

  function applyToolStroke(x, y) {
    const s = sliderValue;
    switch (currentTool) {
      case "heal":         applyHealOrRemove(x, y, s, false); break;
      case "remove":       applyHealOrRemove(x, y, s, true);  break;
      case "patch":        applyPatch(x, y, s);               break;
      case "clone":        applyClone(x, y, s);               break;
      case "removeObject": applyRemoveObject(x, y, s);        break;
      case "erase":        applyErase(x, y, s);               break;
    }
  }

  /* -------- Pointer events (mobile friendly) -------- */
  canvas.addEventListener("pointerdown", e => {
    const pos = getCanvasPos(e);

    if (currentTool === "clone" && !cloneSource) {
      cloneSource = pos;
      showSourceCircleAt("clone", pos.x, pos.y);
      showToast("Clone source set. Drag to apply.");
      return;
    }

    if (currentTool === "patch" && !patchSource) {
      patchSource = pos;
      showSourceCircleAt("patch", pos.x, pos.y);
      showToast("Patch source set. Drag to apply.");
      return;
    }

    isDrawing = true;
    applyToolStroke(pos.x, pos.y);
  });

  canvas.addEventListener("pointermove", e => {
    if (!isDrawing) return;
    const pos = getCanvasPos(e);
    applyToolStroke(pos.x, pos.y);
  });

  function endDraw() {
    isDrawing = false;
  }
  canvas.addEventListener("pointerup", endDraw);
  canvas.addEventListener("pointerleave", endDraw);
  canvas.addEventListener("pointercancel", endDraw);
</script>

</body>
</html>