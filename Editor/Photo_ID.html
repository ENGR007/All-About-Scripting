<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ID / Passport Photo Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1020;
      --card: #141b2f;
      --accent: #ffb84d;
      --accent-strong: #ff9f1c;
      --border: #26324d;
      --text: #f5f7ff;
      --soft: #a7b3d9;
      --danger: #ff4d6a;
      --success: #5bd38a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #222a4a 0, #050814 55%, #02030a 100%);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 16px;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 1.6rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--soft);
      margin-bottom: 18px;
    }

    .shell {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .panel {
      background: var(--card);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px;
      flex: 1 1 260px;
      min-width: 0;
    }

    .panel h2 {
      font-size: 1rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
    }

    .panel h2 span.tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    button,
    select,
    input[type="number"],
    input[type="file"] {
      font: inherit;
      border-radius: 7px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      background: #1d2740;
      color: var(--text);
      outline: none;
    }

    button {
      cursor: pointer;
      border-color: transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1020;
      font-weight: 600;
      white-space: nowrap;
    }

    button.secondary {
      background: #1d2740;
      color: var(--soft);
      border-color: var(--border);
      font-weight: 500;
    }

    button.danger {
      background: var(--danger);
      color: #fff;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    select,
    input[type="number"],
    input[type="file"] {
      background: #101628;
      border-color: var(--border);
      color: var(--soft);
    }

    label {
      font-size: 0.82rem;
      color: var(--soft);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--soft);
      margin-top: 4px;
    }

    video,
    canvas {
      width: 100%;
      max-height: 380px;
      border-radius: 8px;
      background: #000;
      border: 1px solid #212a46;
    }

    .sliders {
      margin-top: 8px;
      display: grid;
      gap: 6px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slider-row span {
      flex: 0 0 80px;
      font-size: 0.8rem;
      color: var(--soft);
    }

    .slider-row input[type="range"] {
      flex: 1;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.74rem;
      color: var(--soft);
    }

    .sizes-list {
      display: grid;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--soft);
      margin-top: 6px;
    }

    .sizes-list span.label {
      font-weight: 600;
      color: var(--accent);
    }

    .status {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--soft);
    }

    .status span.ok {
      color: var(--success);
      font-weight: 600;
    }

    .status span.err {
      color: var(--danger);
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .shell {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ID / Passport Photo Maker</h1>
    <div class="subtitle">
      Take a photo or upload one, clean the background to pure white, enhance, choose a standard size, then download.
    </div>

    <div class="shell">
      <!-- LEFT: CAMERA / SOURCE -->
      <div class="panel">
        <h2>
          Source
          <span class="tag">Camera / Upload</span>
        </h2>

        <div class="controls-row">
          <button id="startCameraBtn">Start Camera</button>
          <button id="captureBtn" disabled>Capture Photo</button>
        </div>

        <video id="video" autoplay playsinline></video>

        <div class="controls-row" style="margin-top:8px;">
          <label for="fileInput">Or upload a photo:</label>
          <input
            type="file"
            id="fileInput"
            accept="image/*"
            capture="environment"
          />
        </div>

        <div class="hint">
          Tip: Use a well-lit photo with a simple background for best “magic white” results.
        </div>
      </div>

      <!-- CENTER: EDITOR -->
      <div class="panel">
        <h2>
          Editor
          <span class="tag">Magic White & Enhance</span>
        </h2>

        <canvas id="editCanvas" width="480" height="640"></canvas>

        <!-- Magic background -->
        <div style="margin-top:8px;">
          <div class="controls-row">
            <label class="pill">
              <input type="checkbox" id="magicToggle" />
              Enable magic white background (click on background)
            </label>
          </div>

          <div class="slider-row">
            <span>Magic tolerance</span>
            <input type="range" id="toleranceSlider" min="5" max="80" value="30" />
          </div>

          <div class="hint">
            1. Check the box, 2. click on a background area in the photo, 3. adjust tolerance if needed.
          </div>
        </div>

        <!-- Enhancements -->
        <div style="margin-top:10px;">
          <div class="controls-row">
            <button id="quickEnhanceBtn" class="secondary">Quick Enhance</button>
            <button id="resetBtn" class="secondary">Reset to Original</button>
          </div>

          <div class="sliders">
            <div class="slider-row">
              <span>Brightness</span>
              <input type="range" id="brightnessSlider" min="-80" max="80" value="0" />
            </div>
            <div class="slider-row">
              <span>Contrast</span>
              <input type="range" id="contrastSlider" min="-80" max="80" value="0" />
            </div>
            <div class="slider-row">
              <span>Saturation</span>
              <input type="range" id="saturationSlider" min="-80" max="80" value="0" />
            </div>
          </div>

          <div class="controls-row" style="margin-top:6px;">
            <button id="applyAdjustBtn" class="secondary">Apply Adjustments</button>
            <button id="clearAdjustBtn" class="secondary">Clear Sliders</button>
          </div>

          <div class="hint">
            Use <b>Quick Enhance</b> for a one-click improvement, or fine-tune with sliders then click <b>Apply Adjustments</b>.
          </div>
        </div>
      </div>

      <!-- RIGHT: SIZES & EXPORT -->
      <div class="panel">
        <h2>
          Output
          <span class="tag">Sizes & Export</span>
        </h2>

        <div class="controls-row">
          <label for="sizePreset">Size preset:</label>
          <select id="sizePreset">
            <option value="original">Same as current canvas</option>
            <option value="passport">Passport 35×45 mm (~413×531px @ 300 dpi)</option>
            <option value="us2x2">US 2×2 inch (600×600px @ 300 dpi)</option>
            <option value="inch1x1">1×1 inch (300×300px)</option>
            <option value="custom">Custom (pixels)</option>
          </select>
        </div>

        <div class="controls-row" id="customSizeRow" style="display:none;">
          <label>Custom (px):</label>
          <input type="number" id="customWidth" placeholder="Width" min="50" max="3000" style="width:90px;" />
          <input type="number" id="customHeight" placeholder="Height" min="50" max="3000" style="width:90px;" />
        </div>

        <div class="sizes-list">
          <span class="label">Common sizes (at 300 dpi):</span>
          <span>• Passport 35×45 mm → ~413×531 px</span>
          <span>• 2×2 in (US visa/ID) → 600×600 px</span>
          <span>• 1×1 in → 300×300 px</span>
        </div>

        <div class="controls-row" style="margin-top:14px;">
          <button id="downloadBtn">Download Final JPEG</button>
        </div>

        <div class="status" id="statusMsg">
          Waiting for image…
        </div>

        <div class="hint" style="margin-top:10px;">
          Export uses a “cover” fit: your edited photo is scaled and centered into the chosen size (some cropping may occur).
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- DOM ELEMENTS ---
    const video = document.getElementById("video");
    const startCameraBtn = document.getElementById("startCameraBtn");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");

    const canvas = document.getElementById("editCanvas");
    const ctx = canvas.getContext("2d");

    const magicToggle = document.getElementById("magicToggle");
    const toleranceSlider = document.getElementById("toleranceSlider");

    const quickEnhanceBtn = document.getElementById("quickEnhanceBtn");
    const resetBtn = document.getElementById("resetBtn");
    const brightnessSlider = document.getElementById("brightnessSlider");
    const contrastSlider = document.getElementById("contrastSlider");
    const saturationSlider = document.getElementById("saturationSlider");
    const applyAdjustBtn = document.getElementById("applyAdjustBtn");
    const clearAdjustBtn = document.getElementById("clearAdjustBtn");

    const sizePreset = document.getElementById("sizePreset");
    const customSizeRow = document.getElementById("customSizeRow");
    const customWidth = document.getElementById("customWidth");
    const customHeight = document.getElementById("customHeight");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusMsg = document.getElementById("statusMsg");

    // --- STATE ---
    let stream = null;
    let hasImage = false;
    let originalImageData = null; // full original pixels
    let originalWidth = canvas.width;
    let originalHeight = canvas.height;

    // --- CAMERA HANDLING ---
    async function startCamera() {
      try {
        if (stream) {
          // Already running
          return;
        }
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false,
        });
        video.srcObject = stream;
        captureBtn.disabled = false;
        setStatus("Camera ready. Click <b>Capture Photo</b>.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Cannot access camera. Check permissions or use file upload.", "err");
      }
    }

    function capturePhoto() {
      if (!video.videoWidth || !video.videoHeight) {
        setStatus("Camera not ready yet. Wait a second then try again.", "err");
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      onNewImage();
      setStatus("Photo captured. You can now use magic white and enhancements.", "ok");
    }

    // --- FILE UPLOAD HANDLING ---
    function handleFileUpload(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          // Fit image into canvas, keeping aspect ratio
          const maxSide = 900;
          let w = img.width;
          let h = img.height;
          const scale = Math.min(maxSide / w, maxSide / h, 1);
          w = Math.round(w * scale);
          h = Math.round(h * scale);

          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          onNewImage();
          setStatus("Photo loaded. Use magic white and enhancements.", "ok");
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // --- COMMON: NEW IMAGE ARRIVED ---
    function onNewImage() {
      hasImage = true;
      originalWidth = canvas.width;
      originalHeight = canvas.height;
      originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      resetSlidersOnly();
    }

    // --- STATUS DISPLAY ---
    function setStatus(message, type) {
      if (!statusMsg) return;
      if (type === "ok") {
        statusMsg.innerHTML = `<span class="ok">✔</span> ${message}`;
      } else if (type === "err") {
        statusMsg.innerHTML = `<span class="err">⚠</span> ${message}`;
      } else {
        statusMsg.textContent = message;
      }
    }

    // --- MAGIC WHITE BACKGROUND (CLICK) ---
    canvas.addEventListener("click", function (e) {
      if (!hasImage || !magicToggle.checked) return;

      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX);
      const y = Math.floor((e.clientY - rect.top) * scaleY);

      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const idx = (y * canvas.width + x) * 4;
      const baseR = data[idx];
      const baseG = data[idx + 1];
      const baseB = data[idx + 2];
      const tolerance = parseInt(toleranceSlider.value, 10) || 30;

      const maxDist = tolerance * 3; // simple Manhattan distance threshold

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        const dist =
          Math.abs(r - baseR) + Math.abs(g - baseG) + Math.abs(b - baseB);

        if (dist < maxDist) {
          // Turn this pixel to pure white
          data[i] = 255;
          data[i + 1] = 255;
          data[i + 2] = 255;
        }
      }

      ctx.putImageData(imageData, 0, 0);
      setStatus("Magic white applied. If it ate too much, undo via Reset or use lower tolerance.", "ok");
    });

    // --- ENHANCEMENT HELPERS ---
    function resetToOriginal() {
      if (!hasImage || !originalImageData) return;
      canvas.width = originalWidth;
      canvas.height = originalHeight;
      ctx.putImageData(originalImageData, 0, 0);
      resetSlidersOnly();
      setStatus("Reset to original image.", "ok");
    }

    function resetSlidersOnly() {
      brightnessSlider.value = 0;
      contrastSlider.value = 0;
      saturationSlider.value = 0;
    }

    function applyQuickEnhance() {
      if (!hasImage) {
        setStatus("No image to enhance. Capture or upload first.", "err");
        return;
      }
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      // Simple “make it better”:
      // slightly brighter + mild contrast boost
      const brightnessOffset = 10;
      const contrastFactor = 1.06; // small

      for (let i = 0; i < data.length; i += 4) {
        for (let c = 0; c < 3; c++) {
          let v = data[i + c];
          v = v * contrastFactor + brightnessOffset;
          if (v < 0) v = 0;
          if (v > 255) v = 255;
          data[i + c] = v;
        }
      }

      ctx.putImageData(imageData, 0, 0);
      setStatus("Quick Enhance applied.", "ok");
    }

    function applyAdjustments() {
      if (!hasImage) {
        setStatus("No image to adjust. Capture or upload first.", "err");
        return;
      }
      const b = parseInt(brightnessSlider.value, 10) || 0;
      const c = parseInt(contrastSlider.value, 10) || 0;
      const s = parseInt(saturationSlider.value, 10) || 0;

      if (!originalImageData) {
        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        originalWidth = canvas.width;
        originalHeight = canvas.height;
      }

      // Start from current canvas pixels (not from original) so you can stack actions
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      // Convert slider values to factors
      const brightnessOffset = b;             // -80 .. 80
      const contrastFactor = 1 + c / 100;     // 0.2 .. 1.8
      const satFactor = 1 + s / 100;          // 0.2 .. 1.8

      for (let i = 0; i < data.length; i += 4) {
        let r = data[i];
        let g = data[i + 1];
        let b_ = data[i + 2];

        // Apply brightness & contrast in RGB
        r = r * contrastFactor + brightnessOffset;
        g = g * contrastFactor + brightnessOffset;
        b_ = b_ * contrastFactor + brightnessOffset;

        // Clamp
        r = r < 0 ? 0 : r > 255 ? 255 : r;
        g = g < 0 ? 0 : g > 255 ? 255 : g;
        b_ = b_ < 0 ? 0 : b_ > 255 ? 255 : b_;

        // Convert to HSL-ish to change saturation (simple method)
        const avg = (r + g + b_) / 3;
        r = avg + (r - avg) * satFactor;
        g = avg + (g - avg) * satFactor;
        b_ = avg + (b_ - avg) * satFactor;

        // Clamp again
        r = r < 0 ? 0 : r > 255 ? 255 : r;
        g = g < 0 ? 0 : g > 255 ? 255 : g;
        b_ = b_ < 0 ? 0 : b_ > 255 ? 255 : b_;

        data[i] = r;
        data[i + 1] = g;
        data[i + 2] = b_;
      }

      ctx.putImageData(imageData, 0, 0);
      setStatus("Adjustments applied.", "ok");
    }

    // --- SIZE PRESET HANDLING ---
    sizePreset.addEventListener("change", () => {
      if (sizePreset.value === "custom") {
        customSizeRow.style.display = "flex";
      } else {
        customSizeRow.style.display = "none";
      }
    });

    // --- EXPORT / DOWNLOAD ---
    function downloadFinal() {
      if (!hasImage) {
        setStatus("No image to download. Capture or upload first.", "err");
        return;
      }

      let targetW, targetH;
      switch (sizePreset.value) {
        case "passport":
          targetW = 413;
          targetH = 531;
          break;
        case "us2x2":
          targetW = 600;
          targetH = 600;
          break;
        case "inch1x1":
          targetW = 300;
          targetH = 300;
          break;
        case "custom":
          targetW = parseInt(customWidth.value, 10);
          targetH = parseInt(customHeight.value, 10);
          if (!targetW || !targetH || targetW <= 0 || targetH <= 0) {
            setStatus("Enter a valid custom width and height in pixels.", "err");
            return;
          }
          break;
        case "original":
        default:
          targetW = canvas.width;
          targetH = canvas.height;
          break;
      }

      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = targetW;
      exportCanvas.height = targetH;
      const exCtx = exportCanvas.getContext("2d");

      // Fill with white just in case
      exCtx.fillStyle = "#ffffff";
      exCtx.fillRect(0, 0, targetW, targetH);

      // “Cover” fit: scale so the photo fills, may crop
      const srcW = canvas.width;
      const srcH = canvas.height;
      const scale = Math.max(targetW / srcW, targetH / srcH);
      const drawW = srcW * scale;
      const drawH = srcH * scale;
      const dx = (targetW - drawW) / 2;
      const dy = (targetH - drawH) / 2;

      exCtx.drawImage(canvas, dx, dy, drawW, drawH);

      const dataURL = exportCanvas.toDataURL("image/jpeg", 0.95);
      const link = document.createElement("a");
      link.href = dataURL;
      link.download = "id_photo_" + sizePreset.value + ".jpg";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      setStatus("JPEG downloaded. You can now print it at the chosen size (300 dpi).", "ok");
    }

    // --- EVENT WIRING ---
    startCameraBtn.addEventListener("click", startCamera);
    captureBtn.addEventListener("click", capturePhoto);
    fileInput.addEventListener("change", handleFileUpload);

    quickEnhanceBtn.addEventListener("click", applyQuickEnhance);
    resetBtn.addEventListener("click", resetToOriginal);
    applyAdjustBtn.addEventListener("click", applyAdjustments);
    clearAdjustBtn.addEventListener("click", resetSlidersOnly);

    downloadBtn.addEventListener("click", downloadFinal);

    // Initialize status
    setStatus("Waiting for image…", "");
  </script>
</body>
</html>