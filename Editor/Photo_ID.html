<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI ID / Passport Photo Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- TensorFlow.js + BodyPix (for AI background removal) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>

  <style>
    :root {
      --bg: #0b1020;
      --card: #141b2f;
      --accent: #ffb84d;
      --accent-strong: #ff9f1c;
      --border: #26324d;
      --text: #f5f7ff;
      --soft: #a7b3d9;
      --danger: #ff4d6a;
      --success: #5bd38a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #222a4a 0, #050814 55%, #02030a 100%);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 16px;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 1.6rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--soft);
      margin-bottom: 18px;
    }

    .shell {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .panel {
      background: var(--card);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px;
      flex: 1 1 260px;
      min-width: 0;
    }

    .panel h2 {
      font-size: 1rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    button,
    select,
    input[type="number"],
    input[type="file"] {
      font: inherit;
      border-radius: 7px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      background: #1d2740;
      color: var(--text);
      outline: none;
    }

    button {
      cursor: pointer;
      border-color: transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1b1020;
      font-weight: 600;
      white-space: nowrap;
    }

    button.secondary {
      background: #1d2740;
      color: var(--soft);
      border-color: var(--border);
      font-weight: 500;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    video,
    canvas {
      width: 100%;
      max-height: 380px;
      border-radius: 8px;
      background: #000;
      border: 1px solid #212a46;
    }

    label {
      font-size: 0.82rem;
      color: var(--soft);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--soft);
      margin-top: 4px;
    }

    .sizes-list {
      display: grid;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--soft);
      margin-top: 6px;
    }

    .sizes-list span.label {
      font-weight: 600;
      color: var(--accent);
    }

    .status {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--soft);
    }

    .status span.ok {
      color: var(--success);
      font-weight: 600;
    }

    .status span.err {
      color: var(--danger);
      font-weight: 600;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .slider-row span {
      flex: 0 0 80px;
      font-size: 0.8rem;
      color: var(--soft);
    }

    .slider-row input[type="range"] {
      flex: 1;
    }

    @media (max-width: 900px) {
      .shell { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>AI ID / Passport Photo Maker</h1>
    <div class="subtitle">
      Take or upload a photo &mdash; AI keeps you, makes the background pure white, enhances, then exports in ID sizes.
    </div>

    <div class="shell">
      <!-- LEFT: CAMERA / UPLOAD -->
      <div class="panel">
        <h2>Source <span class="tag">Camera / Upload</span></h2>

        <div class="controls-row">
          <button id="startCameraBtn">Start Camera</button>
          <button id="captureBtn" disabled>Capture Photo</button>
        </div>

        <video id="video" autoplay playsinline></video>

        <div class="controls-row" style="margin-top:8px;">
          <label for="fileInput">Or upload a photo:</label>
          <input type="file" id="fileInput" accept="image/*" />
        </div>

        <div class="hint">
          Use a clear frontal face, good lighting. Background can be messy &mdash; AI will clean it.
        </div>
      </div>

      <!-- CENTER: EDITOR -->
      <div class="panel">
        <h2>Editor <span class="tag">AI White Background</span></h2>

        <canvas id="editCanvas" width="480" height="640"></canvas>

        <div class="hint" id="aiStatusHint">
          AI model loading… please wait a moment.
        </div>

        <div style="margin-top:10px;">
          <div class="controls-row">
            <button id="quickEnhanceBtn" class="secondary">Quick Enhance</button>
            <button id="resetBtn" class="secondary">Reset to Original</button>
          </div>

          <div class="slider-row">
            <span>Brightness</span>
            <input type="range" id="brightnessSlider" min="-80" max="80" value="0" />
          </div>
          <div class="slider-row">
            <span>Contrast</span>
            <input type="range" id="contrastSlider" min="-80" max="80" value="0" />
          </div>

          <div class="controls-row" style="margin-top:6px;">
            <button id="applyAdjustBtn" class="secondary">Apply Adjustments</button>
            <button id="clearAdjustBtn" class="secondary">Clear Sliders</button>
          </div>

          <div class="hint">
            AI automatically makes the background white. Use <b>Quick Enhance</b> or sliders to polish the photo.
          </div>
        </div>
      </div>

      <!-- RIGHT: SIZES / EXPORT -->
      <div class="panel">
        <h2>Output <span class="tag">Sizes & Export</span></h2>

        <div class="controls-row">
          <label for="sizePreset">Size preset:</label>
          <select id="sizePreset">
            <option value="original">Same as current canvas</option>
            <option value="passport">Passport 35×45 mm (~413×531px @ 300 dpi)</option>
            <option value="us2x2">US 2×2 inch (600×600px @ 300 dpi)</option>
            <option value="inch1x1">1×1 inch (300×300px)</option>
            <option value="custom">Custom (pixels)</option>
          </select>
        </div>

        <div class="controls-row" id="customSizeRow" style="display:none;">
          <label>Custom (px):</label>
          <input type="number" id="customWidth" placeholder="Width" min="50" max="3000" style="width:90px;">
          <input type="number" id="customHeight" placeholder="Height" min="50" max="3000" style="width:90px;">
        </div>

        <div class="sizes-list">
          <span class="label">Common sizes (300 dpi):</span>
          <span>• Passport 35×45 mm → ~413×531 px</span>
          <span>• 2×2 in (US visa/ID) → 600×600 px</span>
          <span>• 1×1 in → 300×300 px</span>
        </div>

        <div class="controls-row" style="margin-top:14px;">
          <button id="downloadBtn">Download Final JPEG</button>
        </div>

        <div class="status" id="statusMsg">
          Waiting for AI model to load…
        </div>

        <div class="hint" style="margin-top:10px;">
          Export uses a “cover” fit: your edited photo fills the chosen size, centered (some cropping may occur).
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM
    const video = document.getElementById("video");
    const startCameraBtn = document.getElementById("startCameraBtn");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");
    const canvas = document.getElementById("editCanvas");
    const ctx = canvas.getContext("2d");

    const quickEnhanceBtn = document.getElementById("quickEnhanceBtn");
    const resetBtn = document.getElementById("resetBtn");
    const brightnessSlider = document.getElementById("brightnessSlider");
    const contrastSlider = document.getElementById("contrastSlider");
    const applyAdjustBtn = document.getElementById("applyAdjustBtn");
    const clearAdjustBtn = document.getElementById("clearAdjustBtn");

    const aiStatusHint = document.getElementById("aiStatusHint");
    const sizePreset = document.getElementById("sizePreset");
    const customSizeRow = document.getElementById("customSizeRow");
    const customWidth = document.getElementById("customWidth");
    const customHeight = document.getElementById("customHeight");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusMsg = document.getElementById("statusMsg");

    // State
    let stream = null;
    let hasImage = false;
    let originalImageData = null;
    let originalWidth = canvas.width;
    let originalHeight = canvas.height;
    let bodyPixModel = null;
    let aiReady = false;

    // ---- STATUS UI ----
    function setStatus(message, type) {
      if (!statusMsg) return;
      if (type === "ok") {
        statusMsg.innerHTML = `<span class="ok">✔</span> ${message}`;
      } else if (type === "err") {
        statusMsg.innerHTML = `<span class="err">⚠</span> ${message}`;
      } else {
        statusMsg.textContent = message;
      }
    }

    // ---- AI MODEL LOADING ----
    async function loadBodyPixModel() {
      try {
        aiStatusHint.textContent = "Loading AI model (BodyPix)…";
        bodyPixModel = await bodyPix.load({
          architecture: "MobileNetV1",
          outputStride: 16,
          multiplier: 0.75,
          quantBytes: 2
        });
        aiReady = true;
        aiStatusHint.textContent = "AI ready. Every new photo will auto-get white background.";
        setStatus("AI model loaded. Capture or upload a photo.", "ok");
      } catch (e) {
        console.error(e);
        aiStatusHint.textContent = "Failed to load AI model. Check internet connection.";
        setStatus("AI model failed to load. Background will not be auto-removed.", "err");
      }
    }

    // ---- CAMERA ----
    async function startCamera() {
      try {
        if (stream) return;
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
        video.srcObject = stream;
        captureBtn.disabled = false;
        setStatus("Camera ready. Click Capture Photo.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Cannot access camera. Check permissions or use file upload.", "err");
      }
    }

    function capturePhoto() {
      if (!video.videoWidth || !video.videoHeight) {
        setStatus("Camera not ready. Try again in a moment.", "err");
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      onNewImage();
    }

    // ---- FILE UPLOAD ----
    function handleFileUpload(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
          const maxSide = 900;
          let w = img.width;
          let h = img.height;
          const scale = Math.min(maxSide / w, maxSide / h, 1);
          w = Math.round(w * scale);
          h = Math.round(h * scale);
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          onNewImage();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    // ---- WHEN NEW IMAGE ARRIVES ----
    async function onNewImage() {
      hasImage = true;
      originalWidth = canvas.width;
      originalHeight = canvas.height;
      originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      resetSlidersOnly();

      if (aiReady && bodyPixModel) {
        setStatus("Running AI background removal…", "");
        await applyAIWhiteBackground();
        setStatus("Background set to white using AI. You can now enhance and export.", "ok");
      } else {
        setStatus("AI not ready. Image loaded without background change.", "err");
      }
    }

    // ---- AI WHITE BACKGROUND ----
    async function applyAIWhiteBackground() {
      // Use an offscreen canvas so BodyPix can read it
      const off = document.createElement("canvas");
      off.width = canvas.width;
      off.height = canvas.height;
      const offCtx = off.getContext("2d");
      offCtx.drawImage(canvas, 0, 0);

      // Segment person
      const segmentation = await bodyPixModel.segmentPerson(off, {
        internalResolution: "medium",
        segmentationThreshold: 0.7
      });

      const mask = segmentation.data; // Uint8Array of 0/1 values (1 = person)
      const srcImageData = offCtx.getImageData(0, 0, off.width, off.height);
      const src = srcImageData.data;

      for (let i = 0; i < mask.length; i++) {
        const isPerson = mask[i] === 1;
        const idx = i * 4;
        if (!isPerson) {
          // non-person → pure white
          src[idx] = 255;     // R
          src[idx + 1] = 255; // G
          src[idx + 2] = 255; // B
        }
      }

      ctx.putImageData(srcImageData, 0, 0);

      // Update "original" to the AI cleaned version so reset goes back to white background
      originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }

    // ---- ENHANCEMENTS ----
    function resetToOriginal() {
      if (!hasImage || !originalImageData) return;
      canvas.width = originalWidth;
      canvas.height = originalHeight;
      ctx.putImageData(originalImageData, 0, 0);
      resetSlidersOnly();
      setStatus("Reset to AI-cleaned original (white background).", "ok");
    }

    function resetSlidersOnly() {
      brightnessSlider.value = 0;
      contrastSlider.value = 0;
    }

    function applyQuickEnhance() {
      if (!hasImage) {
        setStatus("No image to enhance. Capture or upload first.", "err");
        return;
      }
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      const brightnessOffset = 10;
      const contrastFactor = 1.07;

      for (let i = 0; i < data.length; i += 4) {
        for (let c = 0; c < 3; c++) {
          let v = data[i + c];
          v = v * contrastFactor + brightnessOffset;
          if (v < 0) v = 0;
          if (v > 255) v = 255;
          data[i + c] = v;
        }
      }

      ctx.putImageData(imageData, 0, 0);
      setStatus("Quick Enhance applied.", "ok");
    }

    function applyAdjustments() {
      if (!hasImage) {
        setStatus("No image to adjust. Capture or upload first.", "err");
        return;
      }
      const b = parseInt(brightnessSlider.value, 10) || 0;
      const c = parseInt(contrastSlider.value, 10) || 0;

      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      const brightnessOffset = b;
      const contrastFactor = 1 + c / 100;

      for (let i = 0; i < data.length; i += 4) {
        for (let ch = 0; ch < 3; ch++) {
          let v = data[i + ch];
          v = v * contrastFactor + brightnessOffset;
          if (v < 0) v = 0;
          if (v > 255) v = 255;
          data[i + ch] = v;
        }
      }

      ctx.putImageData(imageData, 0, 0);
      setStatus("Adjustments applied.", "ok");
    }

    // ---- SIZE PRESET / EXPORT ----
    sizePreset.addEventListener("change", () => {
      if (sizePreset.value === "custom") {
        customSizeRow.style.display = "flex";
      } else {
        customSizeRow.style.display = "none";
      }
    });

    function downloadFinal() {
      if (!hasImage) {
        setStatus("No image to download. Capture or upload first.", "err");
        return;
      }

      let targetW, targetH;
      switch (sizePreset.value) {
        case "passport":
          targetW = 413;
          targetH = 531;
          break;
        case "us2x2":
          targetW = 600;
          targetH = 600;
          break;
        case "inch1x1":
          targetW = 300;
          targetH = 300;
          break;
        case "custom":
          targetW = parseInt(customWidth.value, 10);
          targetH = parseInt(customHeight.value, 10);
          if (!targetW || !targetH || targetW <= 0 || targetH <= 0) {
            setStatus("Enter valid custom width/height.", "err");
            return;
          }
          break;
        case "original":
        default:
          targetW = canvas.width;
          targetH = canvas.height;
          break;
      }

      const out = document.createElement("canvas");
      out.width = targetW;
      out.height = targetH;
      const outCtx = out.getContext("2d");

      // fill with white
      outCtx.fillStyle = "#ffffff";
      outCtx.fillRect(0, 0, targetW, targetH);

      const srcW = canvas.width;
      const srcH = canvas.height;
      const scale = Math.max(targetW / srcW, targetH / srcH);
      const drawW = srcW * scale;
      const drawH = srcH * scale;
      const dx = (targetW - drawW) / 2;
      const dy = (targetH - drawH) / 2;

      outCtx.drawImage(canvas, dx, dy, drawW, drawH);

      const dataURL = out.toDataURL("image/jpeg", 0.95);
      const link = document.createElement("a");
      link.href = dataURL;
      link.download = "id_photo_" + sizePreset.value + ".jpg";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      setStatus("JPEG downloaded. Save it to Photos / Gallery and print at 300 dpi.", "ok");
    }

    // ---- EVENTS ----
    startCameraBtn.addEventListener("click", startCamera);
    captureBtn.addEventListener("click", capturePhoto);
    fileInput.addEventListener("change", handleFileUpload);

    quickEnhanceBtn.addEventListener("click", applyQuickEnhance);
    resetBtn.addEventListener("click", resetToOriginal);
    applyAdjustBtn.addEventListener("click", applyAdjustments);
    clearAdjustBtn.addEventListener("click", () => {
      resetSlidersOnly();
      setStatus("Sliders cleared. No extra adjustments applied yet.", "");
    });

    downloadBtn.addEventListener("click", downloadFinal);

    // Load AI model on start
    setStatus("Waiting for AI model to load…", "");
    loadBodyPixModel();
  </script>
</body>
</html>