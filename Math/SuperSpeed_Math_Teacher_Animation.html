<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Math Tinik Super Speed + Arithmetic Teacher</title>
<style>
/* === Base UI (kept from your main) === */
body{margin:0;padding:0;text-align:center;font-family:"Comic Sans MS",sans-serif;
background:linear-gradient(180deg,#fff7e0,#ffe0b2);color:#333;overflow-x:hidden}
h1{color:#ff7a00;font-size:2.3em;margin:16px 0 8px}
select,button,input{font-size:1rem;padding:8px 14px;margin:4px;border:none;border-radius:8px}
button{background:#ff9900;color:#fff;cursor:pointer}
button:hover{background:#ff7a00}
#soundBtn { background:#ff9900; color:#fff; border:none; }
#soundBtn:hover { background:#ff7a00; }
#timerbar{height:25px;width:80%;margin:8px auto;background:#ffe4b5;border-radius:15px;overflow:hidden}
#bar{height:100%;width:100%;background:#ff9900;transition:width 1s linear}
#question{font-size:2em;margin:24px 0 10px;min-height:1.5em}
#answer{font-size:1.3em;width:110px;text-align:center}
#feedback{font-size:1.2em;min-height:28px;margin:6px}
.good{color:green;font-weight:700}.bad{color:red;font-weight:700}
#score{margin:6px 0 10px;font-weight:700}
.score-green{color:#15803d}.score-orange{color:#b45309}.score-red{color:#b91c1c}
#overlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,.97);align-items:center;justify-content:flex-start;flex-direction:column;overflow-y:auto;padding:40px 10px;font-size:1.6em;color:#ff7a00;z-index:9999;animation:fadein .5s}
@keyframes fadein{from{opacity:0}to{opacity:1}}
table{border-collapse:collapse;margin:10px auto;font-size:.95rem;background:#fff}
th,td{border:1px solid #ddd;padding:6px 8px}th{background:#fff7ea}
#homeTip{position:fixed;bottom:0;left:0;right:0;background:#ffebcc;padding:10px;font-size:.9rem;color:#333;display:none}
#ready{display:none;position:fixed;inset:0;background:rgba(255,153,0,.95);color:#fff;font-size:3em;font-weight:bold;align-items:center;justify-content:center;z-index:10000}
.solubox{background:#fff8e1;border:2px solid #ff9900;border-radius:10px;padding:10px;margin:10px auto;width:92%;text-align:left;font-family:"Courier New",monospace}
.solubox h3{margin:0 0 6px 0;color:#b45309;font-size:1.1em}
.precalc{display:inline-block;font-family:"Courier New",monospace;white-space:pre;text-align:right;line-height:1.25em;font-size:1.2em;margin:6px 0 0 12px}
@media (max-width:600px){.solubox{width:98%}.precalc{font-size:1.1em}}
#whiteboardWrap{width:96%;max-width:1200px;margin:12px auto 6px auto;text-align:left}
#whiteboardTitle{color:#b45309;font-size:1.05em;margin:0 0 6px 4px}
#whiteboardBox{background:#fffef7;border:2px solid #ff9900;border-radius:12px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
#whiteboardCanvas{display:block;width:100%;height:260px;background:#fff;border:1px dashed #ffb84d;border-radius:8px;cursor:crosshair;touch-action:none}
#whiteboardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
#score{color:#15803d;font-weight:bold;font-size:1.05em;margin-right:6px}
#wbToolbar{display:flex;gap:8px;align-items:center;justify-content:flex-start;margin-top:8px;flex-wrap:wrap}
#wbClear{background:#ffc107;color:#333}
#wbUndo{background:#ffd54f;color:#333}
#wbColor,#wbSize{padding:6px 10px;border:1px solid #ffcc80;border-radius:8px}

/* === Arithmetic Teacher Modal === */
#teacherBtn { background:#ff9900; color:#fff; border:none; }
#teacherBtn:hover { background:#ff7a00; }
#teacherBtn[disabled]{opacity:.5;cursor:not-allowed}
#teacherModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:12000;align-items:center;justify-content:center}
#teacherPanel{
  width:min(1200px,96vw);height:min(92vh,900px);background:#fffef9;border:3px solid #ff9900;border-radius:14px;
  box-shadow:0 8px 40px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden
}
#teacherHead{
  background:#ffe6bf;border-bottom:2px solid #ffb84d;display:flex;align-items:center;justify-content:space-between;padding:10px 12px
}
#teacherHead b{color:#b45309}
#teacherClose{background:#ff7043}
#teacherBody{flex:1;overflow:auto;padding:12px}
#twrapper{display:flex;gap:24px;justify-content:center;align-items:flex-start;flex-wrap:wrap;margin:6px auto 4px}
.tbox{background:#fff;border:2px solid #ff9900;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,.1);padding:12px}
#tdiagram{min-width:420px;text-align:left;font-family:"Courier New",monospace}
#tdiagram b{display:block;margin-bottom:6px}
#tdiagram pre{font-size:1.08rem;line-height:1.28em;margin:8px 0 0;white-space:pre}
#tnotes{min-width:360px;max-width:560px;text-align:left}
#tnotes b{display:block;margin-bottom:6px}
.step{margin:6px 0}
.opHdr{margin:6px 0 4px 0;color:#b45309}
.badge{display:inline-block;background:#ffd490;color:#7a3e00;border:1px solid #ff9900;border-radius:6px;padding:2px 6px;font-size:.78rem;margin-left:6px}
.red{color:#e63946;font-weight:bold}.blue{color:#0077cc;font-weight:bold}.green{color:#008800;font-weight:bold}
#teacherControls{margin:6px 8px 2px 8px}

/* Make overlay buttons always clickable */
#overlay button{position:relative;z-index:10001}
</style>
</head>
<body>
<h1>üßÆ Math Tinik Super Speed</h1>

<div id="controls">
  <!-- Teacher button to the LEFT of Start -->
  <button id="teacherBtn" title="Available only in Practice (No time)" disabled>üë©‚Äçüè´ Teacher</button>
  <button id="scoreReportBtn" title="View score history">üìò Score Report</button>
  <button id="soundBtn" onclick="toggleSound()">üîä Sound: ON</button>
  Time:
  <select id="timeSel">
    <option value="60">1 min</option>
    <option value="120">2 min</option>
    <option value="180">3 min</option>
    <option value="240">4 min</option>
    <option value="300">5 min</option>
    <option value="600">10 min</option>
    <option value="1800">30 min</option>
    <option value="0">Practice</option>
  </select>
  Operation:
  <select id="opSel">
    <option value="mixed">Mixed</option>
    <option value="+">Addition (+)</option>
    <option value="-">Subtraction (‚àí)</option>
    <option value="√ó">Multiplication (√ó)</option>
    <option value="√∑">Division (√∑)</option>
    <option value="fractions">Fractions</option>
    <option value="decimals">Decimals</option>
    <option value="algebra">Algebra</option>
  </select>
  Level:
  <select id="lvlSel">
    <option value="easy">Easy</option>
    <option value="avg">Average</option>
    <option value="hard">Difficult</option>
  </select>
  <button id="startBtn" onclick="startGame()">Start ‚ñ∂</button>
  <button id="pauseBtn" onclick="togglePause()" style="display:none">‚è∏ Pause</button>
  <button id="endBtn" onclick="endGame()" style="display:none">‚èπ End Game</button>
</div>

<div id="timerbar"><div id="bar"></div></div>
<div id="timer"></div>
<div id="question"></div>
<input id="answer" type="text" disabled onkeydown="if(event.key==='Enter')checkAns()">
<br>
<button id="nextBtn" onclick="nextQ()" style="display:none;margin-right:6px;">Next ‚ñ∂</button>
<button id="submitBtn" disabled onclick="checkAns()">Submit</button>
<div id="feedback"></div>


<div id="whiteboardWrap">
  <div id="whiteboardHeader">
    <div id="whiteboardTitle">üñä Whiteboard</div>
    <div id="score"></div>
  </div>
  <div id="whiteboardBox">
    <canvas id="whiteboardCanvas"></canvas>
    <div id="wbToolbar">
      <button id="wbUndo">‚Ü∂ Undo</button>
      <button id="wbEraser">ü©π Eraser</button>
      <button id="wbClear">üßπ Clear</button>
      <label>Color <input id="wbColor" type="color" value="#222222"></label>
      <label>Size
        <select id="wbSize"><option>2</option><option selected>3</option><option>4</option><option>6</option><option>8</option><option>12</option></select>
      </label>
    </div>
  </div>
</div>

<div id="solutionBox"></div>
<div id="summary"></div>

<div id="overlay">
  <div id="endmsg">‚è∞ Time‚Äôs Up!</div>
  <div id="final"></div>
  <div id="resultsTable"></div>
  <button id="playAgainBtn" onclick="playAgain()">‚ñ∂ Play Again</button>
  <button id="homeBtn" onclick="goHome()">üè† Home Screen</button>
</div>

<div id="ready">Get Ready!</div>
<div id="homeTip">Add this game to your Home Screen for offline play!<br>
<i>iPhone: Share ‚Üí Add to Home Screen ‚Ä¢ Android: ‚ãÆ Menu ‚Üí Add to Home Screen</i></div>

<!-- ========== Arithmetic Teacher MODAL (PowerPoint-style) ========== -->
<div id="teacherModal">
  <div id="teacherPanel">
    <div id="teacherHead">
      <b>üßÆ Arithmetic Teacher</b>
      <button id="teacherClose">Close ‚úñ</button>
    </div>

    <div id="teacherBody">
      <div id="teacherControls">
        Number 1: <input id="tn1" value="23544" size="12">
        <select id="topSel">
          <option value="+">+</option>
          <option value="-">‚àí</option>
          <option value="√ó">√ó</option>
          <option value="√∑">√∑</option>
        </select>
        Number 2: <input id="tn2" value="12345" size="12">
        <button id="tsolve">Show Solution</button>

        <!-- New step-by-step mode controls -->
        <label style="margin-left:10px">
          <input type="checkbox" id="tstepMode"> Step-by-Step
        </label>
        <button id="tstepPrev" disabled>‚óÄ Prev</button>
        <button id="tstepNext" disabled>Next ‚ñ∂</button>
        <button id="tstepRestart" disabled>‚ü≤ Restart</button>

        <span class="badge" id="tstatus"></span>
      </div>

      <div id="twrapper">
        <div id="tdiagram" class="tbox">
          <b>Work Area</b>
          <pre id="tdiag"></pre>
        </div>
        <div id="tnotes" class="tbox">
          <b>Step-by-Step Instructions</b>
          <div id="tsteps"></div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
/* === Sounds === */
function ding(){if(!soundOn)return;const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.type="triangle";o.frequency.value=880;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.15,c.currentTime);o.start();o.stop(c.currentTime+0.15);}
function buzz(){if(!soundOn)return;const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.type="square";o.frequency.value=150;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.2,c.currentTime);o.start();o.stop(c.currentTime+0.25);}
function clap(){if(!soundOn)return;const c=new(window.AudioContext||window.webkitAudioContext)();for(let i=0;i<8;i++){const o=c.createOscillator(),g=c.createGain();o.type="square";o.frequency.value=120+Math.random()*80;o.connect(g);g.connect(c.destination);g.gain.setValueAtTime(0.05,c.currentTime+i*0.05);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.05+i*0.05);o.start(c.currentTime+i*0.05);o.stop(c.currentTime+0.08+i*0.05);}}
let soundOn=localStorage.getItem("sound")!=="off";
function toggleSound(){soundOn=!soundOn;localStorage.setItem("sound",soundOn?"on":"off");document.getElementById("soundBtn").textContent=soundOn?"üîä Sound: ON":"üîá Sound: OFF";}
window.addEventListener("load",()=>{document.getElementById("soundBtn").textContent=soundOn?"üîä Sound: ON":"üîá Sound: OFF";});

/* === State === */
let qList=[],cur=0,score=0,total=0,timer=0,tInt=null,answers=[],startTime=0,paused=false;
let currentOp="mixed",currentLvl="easy";

/* Tips + Last Score (kept) */
if(!localStorage.getItem("tipShown")){document.getElementById("homeTip").style.display="block";setTimeout(()=>{document.getElementById("homeTip").style.display="none";localStorage.setItem("tipShown","1");},10000);}
if(localStorage.getItem("lastScore")){const ls=JSON.parse(localStorage.getItem("lastScore"));document.getElementById("summary").innerHTML="üìä Last session: <strong>"+ls.score+" out of "+ls.total+"</strong> ("+ls.percent+"%)";}

/* === Random + Generator (kept) === */
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function genQuestions(opSel,lvlSel,n=120){const set=new Set();let tries=0;
while(set.size<n&&tries<3000){tries++;let op=(opSel==="mixed")?["+","-","√ó","√∑"][rand(0,3)]:opSel;let a,b,expr;const one=()=>rand(1,9);const two=()=>rand(10,99);
if(["+","-","√ó","√∑"].includes(op)){if(op==="+"||op==="-"){if(lvlSel==="easy"){a=one();b=one();}else if(lvlSel==="avg"){a=two();b=one();}else{a=two();b=two();}if(op==="-"&&b>a){[a,b]=[b,a];}expr=a+" "+op+" "+b;}
else if(op==="√ó"){if(lvlSel==="easy"){a=one();b=one();}else if(lvlSel==="avg"){a=two();b=one();}else{a=two();b=two();}expr=a+" √ó "+b;}
else{if(lvlSel==="easy"){b=one();const q=rand(1,12);a=b*q;expr=a+" √∑ "+b;}else if(lvlSel==="avg"){b=one();const q=rand(10,99);a=b*q;expr=a+" √∑ "+b;}else{b=rand(10,99);const q=rand(4,20);a=b*q;expr=a+" √∑ "+b;}}set.add(expr);}
else if(op==="fractions"){const num=()=>rand(1,8),den=()=>rand(1,8);const A=num()+"/"+den(),B=num()+"/"+den();const sym=["+","-","√ó","√∑"][rand(0,3)];set.add(A+" "+sym+" "+B);}
else if(op==="decimals"){const f=()=>parseFloat((Math.random()*9).toFixed(1));set.add(f()+" "+["+","-","√ó","√∑"][rand(0,3)]+" "+f());}
else if(op==="algebra"){if(lvlSel==="easy"){const x=rand(1,12);if(Math.random()<0.5){const c=rand(1,9),s=x+c;set.add("x + "+c+" = "+s);}else{const c=rand(1,9),s=x-c;if(s>=0)set.add("x - "+c+" = "+s);else set.add("x + "+(-s)+" = "+x);}}
else if(lvlSel==="avg"){const a=rand(2,9),x=rand(1,12),s=a*x;set.add(a+"x = "+s);}
else{const a=rand(2,9),x=rand(1,12);if(Math.random()<0.5){const c=rand(1,9),s=a*x+c;set.add(a+"x + "+c+" = "+s);}else{const c=rand(1,9),s=a*x-c;if(s>0)set.add(a+"x - "+c+" = "+s);else set.add(a+"x + "+c+" = "+(a*x+c));}}}}
qList=[...set].map(q=>({q:q,ans:evaluate(q)}));}

/* === Evaluator (kept) === */
function evaluate(expr){expr=expr.trim();
if(expr.includes("x")){const parts=expr.split("=");const left=parts[0].trim();const R=parseFloat(parts[1]);if(left.includes("x +")){const c=parseFloat(left.split("+")[1]);return R-c;}
if(left.includes("x -")){const c=parseFloat(left.split("-")[1]);return R+c;}
if(left.includes("x")&&left.includes("+")===false&&left.includes("-")===false){const a=parseFloat(left.split("x")[0])||1;return R/a;}
if(left.includes("x +")||left.includes("x -")){const a=parseFloat(left.split("x")[0])||1;if(left.includes("+")){const c=parseFloat(left.split("+")[1]);return(R-c)/a;}const c=parseFloat(left.split("-")[1]);return(R+c)/a;}return 0;}
if(expr.includes("/")){const conv=t=>t.includes("/")?(parseFloat(t.split("/")[0])/parseFloat(t.split("/")[1])):parseFloat(t);const [A,op,B]=expr.split(" ");const a=conv(A),b=conv(B);switch(op){case"+":return a+b;case"-":return a-b;case"√ó":return a*b;case"√∑":return a/b;}}
return eval(expr.replace(/√ó/g,"*").replace(/√∑/g,"/"));}

/* === Game Flow (kept) === */
function startGame(){currentOp=document.getElementById("opSel").value;currentLvl=document.getElementById("lvlSel").value;genQuestions(currentOp,currentLvl);
score=0;cur=0;answers=[];paused=false;total=parseInt(document.getElementById("timeSel").value,10);
document.getElementById("answer").disabled=false;document.getElementById("submitBtn").disabled=false;
document.getElementById("overlay").style.display="none";document.getElementById("pauseBtn").style.display="inline";
document.getElementById("endBtn").style.display="inline";document.getElementById("startBtn").style.display="none";
document.getElementById("summary").innerHTML="";document.getElementById("solutionBox").innerHTML="";
showWhiteboard();clearWhiteboard();showReady();
updateTeacherButton(); // enable/disable Teacher based on Practice
}
function showReady(){const r=document.getElementById("ready");r.style.display="flex";setTimeout(()=>{r.style.display="none";beginRound();},800);}
function beginRound(){nextQ();startTime=Date.now();clearInterval(tInt);timer=total;updateBar();
if(total>0){tInt=setInterval(()=>{if(!paused){timer--;updateBar();}if(timer<=0){clearInterval(tInt);endGame();}},1000);}
else{document.getElementById("timer").innerText="‚àû No limit";}}
function togglePause(){if(total===0)return;paused=!paused;document.getElementById("pauseBtn").textContent=paused?"‚ñ∂ Resume":"‚è∏ Pause";}
function updateBar(){if(total<=0)return;document.getElementById("timer").innerText="‚è± "+timer+" s";const perc=Math.max(0,(timer/total)*100),bar=document.getElementById("bar");bar.style.width=perc+"%";bar.style.background="hsl("+(20+perc*1.2)+",100%,50%)";}
function nextQ(){if(cur>=qList.length){genQuestions(currentOp,currentLvl);cur=0;}const q=qList[cur++];document.getElementById("nextBtn").style.display="none";
document.getElementById("question").innerText=q.q;
document.getElementById("answer").value="";document.getElementById("feedback").innerText="";
document.getElementById("solutionBox").innerHTML="";document.getElementById("answer").focus();clearWhiteboard();}

/* === Answer Handling (kept) === */
function parseAnswer(val){if(val.includes("/")){const parts=val.split("/");const n=parseFloat(parts[0]),d=parseFloat(parts[1]);if(!isNaN(n)&&!isNaN(d)&&d!==0)return n/d;}
const f=parseFloat(val);return isNaN(f)?null:f;}
function checkAns(){if(paused)return;const q=qList[cur-1],val=document.getElementById("answer").value.trim();if(!val)return;
const user=parseAnswer(val);if(user===null){document.getElementById("feedback").innerHTML="‚ùì Enter a valid number";return;}
const correct=Math.abs(user-q.ans)<0.01;const noLimit=document.getElementById("timeSel").value==="0";const fb=document.getElementById("feedback");
if(correct){fb.innerHTML="‚úÖ Correct!";ding();score++;document.getElementById("score").innerText="Score: "+score;nextQ();}
else{fb.innerHTML="‚ùå "+q.q+" = "+(Number.isInteger(q.ans)?q.ans:q.ans.toFixed(2));buzz();if(noLimit)showSolution(q);else nextQ();}
const elapsed=((Date.now()-startTime)/1000).toFixed(1);
answers.push({q:q.q,user:val,correct:(Number.isInteger(q.ans)?q.ans:q.ans.toFixed(2)),op:q.q.split(" ")[1],time:elapsed,score:score,result:correct?"Right":"Wrong"});
document.getElementById("nextBtn").style.display="inline";
}

/* === Solution Display with Fraction Steps (kept) === */
function showSolution(q) {
  const expr = q.q.trim();
  const ans = q.ans;
  let html = '<div class="solubox"><h3>üëâ Solution</h3>';

  // üßÆ Fraction Operations
  if (expr.includes('/')) {
    const [A, op, B] = expr.split(' ');
    const [aN, aD] = A.split('/').map(Number),
          [bN, bD] = B.split('/').map(Number);
    const lcd = (aD * bD) / gcd(aD, bD);
    const An = aN * (lcd / aD),
          Bn = bN * (lcd / bD);
    let resultN, resultD = lcd;

    if (op === '+') resultN = An + Bn;
    else if (op === '-') resultN = An - Bn;
    else if (op === '√ó') { resultN = aN * bN; resultD = aD * bD; }
    else if (op === '√∑') { resultN = aN * bD; resultD = aD * bN; }

    const g = gcd(resultN, resultD);
    const simpN = resultN / g, simpD = resultD / g;
    const mixInt = Math.floor(simpN / simpD),
          mixRem = Math.abs(simpN % simpD);

    html += `<pre class='precalc'>
${A} ${op} ${B}
‚Üí LCD = ${lcd}
‚Üí Convert: ${A} = ${An}/${lcd}, ${B} = ${Bn}/${lcd}
‚Üí ${op === '+' ? 'Add' : op === '-' ? 'Subtract' : op === '√ó' ? 'Multiply' : 'Divide'}:
   ${An} ${op} ${Bn} = ${resultN}/${resultD}
‚Üí Simplify: ${resultN}/${resultD} = ${simpN}/${simpD}
${Math.abs(simpN) >= simpD ? `‚Üí Mixed = ${mixInt} ${mixRem}/${simpD}` : ''}
‚Üí Final ‚âà ${ans.toFixed(2)}
</pre>`;
  }

  // üî† Algebraic Equations (Enhanced)
  else if (expr.includes('x')) {
    html += "<pre class='precalc'>";
    html += "Step 1: " + expr + "\n";

    const parts = expr.split('=');
    const left = parts[0].trim();
    const right = parseFloat(parts[1]);
    let steps = "";

    if (left.includes('x +')) {
      const c = parseFloat(left.split('+')[1]);
      const a = parseFloat(left.split('x')[0]) || 1;
      const A = right - c;
      const x = A / a;
      steps += `Subtract ${c} from both sides ‚Üí ${a}x = ${A}\n`;
      steps += `Divide both sides by ${a} ‚Üí x = ${x}`;
    }

    else if (left.includes('x -')) {
      const c = parseFloat(left.split('-')[1]);
      const a = parseFloat(left.split('x')[0]) || 1;
      const A = right + c;
      const x = A / a;
      steps += `Add ${c} to both sides ‚Üí ${a}x = ${A}\n`;
      steps += `Divide both sides by ${a} ‚Üí x = ${x}`;
    }

    else if (left.includes('x') && !left.includes('+') && !left.includes('-')) {
      const a = parseFloat(left.replace('x', '')) || 1;
      const x = right / a;
      steps += `Divide both sides by ${a} ‚Üí x = ${x}`;
    }

    html += steps + "\n";
    html += `Answer: x = ${ans}`;
    html += "</pre>";
  }

  // ‚ûï‚ûñ‚úñÔ∏è‚ûó Regular arithmetic / decimals
  else {
    html += expr + ' = <b>' + ans + '</b>';
  }

  html += '<div class="center"><button onclick="nextQ()">Next ‚ñ∂</button></div></div>';
  document.getElementById('solutionBox').innerHTML = html;
}

// GCD helper (unchanged)
function gcd(a, b) { return b ? gcd(b, a % b) : Math.abs(a); }


/* === End Game etc (kept + overlay buttons ensured clickable) === */
function endGame(){document.getElementById("answer").disabled=true;document.getElementById("submitBtn").disabled=true;
document.getElementById("pauseBtn").style.display="none";document.getElementById("endBtn").style.display="none";clearInterval(tInt);
const totalQs=answers.length||1,percent=Math.round((score/totalQs)*100);
let color="score-red";if(percent>=80)color="score-green";else if(percent>=50)color="score-orange";
const msgs=['üåü Great job!','üî• You‚Äôre on fire!','üëè Keep going!','üéâ Awesome work!','üèÖ Super speed!','üí™ Fantastic!'];
const overlay=document.getElementById("overlay");overlay.style.display="flex";
document.getElementById("endmsg").innerText=msgs[Math.floor(Math.random()*msgs.length)];
document.getElementById("final").innerHTML='<span class="'+color+'">'+score+' out of '+totalQs+' ('+percent+'%)</span>';
showResultsTable();confetti();saveLast(percent,totalQs);clap();}
function showResultsTable(){let out="<table><tr><th>Q</th><th>Your</th><th>Correct</th><th>Op</th><th>Result</th></tr>";
for(const a of answers){out+="<tr><td>"+a.q+"</td><td>"+a.user+"</td><td>"+a.correct+"</td><td>"+a.op+"</td><td class='"+(a.result==="Right"?"good":"bad")+"'>"+a.result+"</td></tr>";}
out+="</table>";document.getElementById("resultsTable").innerHTML=out;}
function playAgain(){document.getElementById("overlay").style.display="none";startGame();}
function goHome(){clearInterval(tInt);paused=false;document.getElementById("overlay").style.display="none";
document.getElementById("startBtn").style.display="inline";document.getElementById("pauseBtn").style.display="none";document.getElementById("endBtn").style.display="none";
document.getElementById("answer").disabled=true;document.getElementById("submitBtn").disabled=true;document.getElementById("question").innerText="";
document.getElementById("timer").innerText="";document.getElementById("score").innerText="";document.getElementById("feedback").innerText="";
document.getElementById("bar").style.width="100%";document.getElementById("resultsTable").innerHTML="";
document.getElementById("final").innerHTML="";document.getElementById("endmsg").innerText="‚è∞ Time‚Äôs Up!";
window.scrollTo({top:0,behavior:"smooth"});setTimeout(()=>document.getElementById("startBtn").focus(),300);}
function saveLast(percent,totalQs){localStorage.setItem("lastScore",JSON.stringify({score:score,total:totalQs,percent:percent}));}

/* === Confetti (kept) === */
function confetti(){const dur=1500,end=Date.now()+dur;(function frame(){const colors=["#ffcc00","#ff6600","#ff3300","#ff9999","#ffff66"];
const p=document.createElement("div");p.style.position="fixed";p.style.top="-10px";p.style.left=(Math.random()*100)+"%";
p.style.width="8px";p.style.height="8px";p.style.background=colors[Math.floor(Math.random()*colors.length)];
p.style.borderRadius="50%";p.style.zIndex="10000";document.body.appendChild(p);
const fall=Math.random()*90+10,move=Math.random()*60-30,rot=Math.random()*360;
p.animate([{transform:"translate(0,0) rotate(0deg)"},{transform:"translate("+move+"vw,"+fall+"vh) rotate("+rot+"deg)"}],
{duration:dur,easing:"ease-out"});setTimeout(()=>p.remove(),dur);if(Date.now()<end)requestAnimationFrame(frame);})();}

/* === Whiteboard (kept) === */
const wb={canvas:null,ctx:null,dpr:1,drawing:false,strokeColor:'#222222',strokeWidth:3,lastX:0,lastY:0,history:[]};
function showWhiteboard(){document.getElementById('whiteboardWrap').style.display='block';}
function syncWhiteboardSize(){const c=wb.canvas;if(!c)return;const cssWidth=c.clientWidth,cssHeight=c.clientHeight;
const dpr=window.devicePixelRatio||1;wb.dpr=dpr;if(c.width!==Math.round(cssWidth*dpr)||c.height!==Math.round(cssHeight*dpr)){
c.width=Math.round(cssWidth*dpr);c.height=Math.round(cssHeight*dpr);wb.ctx.setTransform(dpr,0,0,dpr,0,0);clearWhiteboard();}}
function getCanvasPos(evt){const rect=wb.canvas.getBoundingClientRect();const clientX=(evt.touches?evt.touches[0].clientX:evt.clientX);
const clientY=(evt.touches?evt.touches[0].clientY:evt.clientY);const x=clientX-rect.left,y=clientY-rect.top;return{x,y};}
function wbBegin(evt){evt.preventDefault();const p=getCanvasPos(evt);wb.drawing=true;wb.ctx.beginPath();wb.ctx.moveTo(p.x,p.y);wb.lastX=p.x;wb.lastY=p.y;}
function wbMove(evt){if(!wb.drawing)return;evt.preventDefault();const p=getCanvasPos(evt);wb.ctx.lineWidth=wb.strokeWidth;wb.ctx.lineCap='round';
wb.ctx.lineJoin='round';wb.ctx.strokeStyle=wb.strokeColor;wb.ctx.lineTo(p.x,p.y);wb.ctx.stroke();wb.lastX=p.x;wb.lastY=p.y;}
function wbEnd(evt){if(!wb.drawing)return;wb.drawing=false;try{wb.history.push(wb.canvas.toDataURL('image/png'));if(wb.history.length>50)wb.history.shift();}catch(e){}}
function clearWhiteboard(){if(!wb.ctx)return;wb.ctx.clearRect(0,0,wb.canvas.width,wb.canvas.height);wb.history=[];}
function undoWhiteboard(){if(wb.history.length===0)return;wb.history.pop();const prev=wb.history[wb.history.length-1];if(!prev){clearWhiteboard();return;}
const img=new Image();img.onload=()=>{wb.ctx.clearRect(0,0,wb.canvas.width,wb.canvas.height);wb.ctx.drawImage(img,0,0,wb.canvas.width/wb.dpr,wb.canvas.height/wb.dpr);};img.src=prev;}
function initWhiteboard(){wb.canvas=document.getElementById('whiteboardCanvas');if(!wb.canvas)return;wb.ctx=wb.canvas.getContext('2d');
syncWhiteboardSize();wb.canvas.addEventListener('mousedown',wbBegin,{passive:false});wb.canvas.addEventListener('mousemove',wbMove,{passive:false});
window.addEventListener('mouseup',wbEnd,{passive:false});wb.canvas.addEventListener('touchstart',wbBegin,{passive:false});
wb.canvas.addEventListener('touchmove',wbMove,{passive:false});wb.canvas.addEventListener('touchend',wbEnd,{passive:false});
wb.canvas.addEventListener('touchcancel',wbEnd,{passive:false});document.getElementById('wbClear').addEventListener('click',clearWhiteboard);
// ERASER TOOL
let wbIsEraser = false;

document.getElementById('wbEraser').addEventListener('click', ()=>{
    wbIsEraser = true;
    wb.strokeColor = "#ffffff";   // white erase
    wb.strokeWidth = 18;          // big eraser size
});
document.getElementById('wbUndo').addEventListener('click',undoWhiteboard);
// Color picker ‚Üí return to pen mode
document.getElementById('wbColor').addEventListener('input', e=>{
    wbIsEraser = false;
    wb.strokeColor = e.target.value;
    wb.strokeWidth = 3;   // reset to default size when switching back to pen
    document.getElementById('wbSize').value = "3";  // update dropdown UI
});

// Size picker ‚Üí stay pen mode (unless eraser is manually selected)
document.getElementById('wbSize').addEventListener('change', e=>{
    if (!wbIsEraser) {
        wb.strokeWidth = parseInt(e.target.value) || 3;
    }
});
document.getElementById('wbSize').addEventListener('change',e=>{wb.strokeWidth=parseInt(e.target.value)||3;});
window.addEventListener('resize',syncWhiteboardSize);window.addEventListener('orientationchange',()=>setTimeout(syncWhiteboardSize,250));}
window.addEventListener('load',()=>{initWhiteboard();showWhiteboard();});

/* =========================
   Arithmetic Teacher (full logic)
   ========================= */
function t_trimZeros(s){return (''+s).replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'').replace(/\.$/,'');}
function t_decCount(x){const p=(''+x).split('.');return p.length===2?p[1].length:0;}
function t_padLeft(s,n,ch=' '){s=''+s;while(s.length<n)s=ch+s;return s;}
function t_normalizeDecimals(a,b){const da=t_decCount(a),db=t_decCount(b),k=Math.max(da,db),f=10**k;return{A:Math.round(Number(a)*f),B:Math.round(Number(b)*f),k};}
function t_normalizeMul(a,b){const da=t_decCount(a),db=t_decCount(b);return{A:(''+a).replace('.',''),B:(''+b).replace('.',''),shift:da+db};}
function t_alignForDiagram(a,b,sign){
  const [ai,adRaw='']=String(a).split('.');const[bi,bdRaw='']=String(b).split('.');
  const maxI=Math.max(ai.length,bi.length),maxD=Math.max(adRaw.length,bdRaw.length);
  const ad=maxD?'.'+adRaw.padEnd(maxD,'0'):'';const bd=maxD?'.'+bdRaw.padEnd(maxD,'0'):'';
  const aLine=ai.padStart(maxI,' ')+ad, bLine=bi.padStart(maxI,' ')+bd; const width=Math.max(aLine.length,bLine.length)+2;
  return {width, top:aLine.padStart(width), mid:(sign+bLine).padStart(width), line:'‚Äî'.repeat(width)};
}
/* Addition */
function t_addSteps(a, b) {
  const steps = [];
  const frames = [];
  const A = String(a), B = String(b);

  const [aInt, aDec = ""] = A.split(".");
  const [bInt, bDec = ""] = B.split(".");
  const decLen = Math.max(aDec.length, bDec.length);
  const AFull = aInt + aDec.padEnd(decLen, "0");
  const BFull = bInt + bDec.padEnd(decLen, "0");

  const maxLen = Math.max(AFull.length, BFull.length);
  const AArr = AFull.padStart(maxLen, "0").split("").map(Number);
  const BArr = BFull.padStart(maxLen, "0").split("").map(Number);

  let carry = 0;
  const resArr = [];
  const carrySteps = [];
  steps.push("Addition<br><span class='rule'>carry rule</span>");
  steps.push("Column-by-column addition from right to left");

  for (let i = maxLen - 1; i >= 0; i--) {
    const sum = AArr[i] + BArr[i] + carry;
    const write = sum % 10;
    carry = Math.floor(sum / 10);
    resArr.unshift(write);
    carrySteps.push(`Column ${maxLen - i}: ${AArr[i]} + ${BArr[i]} + carry ‚Üí ${sum} ‚Üí carry ${carry}, write ${write}.`);
    steps.push(carrySteps[carrySteps.length - 1]);
    frames.push(`${A}\n+${B}\n${" ".repeat(maxLen - i)}${resArr.join("")}`);
  }

  if (carry > 0) {
    resArr.unshift(carry);
    steps.push(`Leftover carry ${carry} ‚Üí write at left.`);
  }

  const intRes = resArr.join("");
  const result = decLen ? `${intRes.slice(0, -decLen)}.${intRes.slice(-decLen)}` : intRes;
  const diagram = `${A}\n+${B}\n${"".padStart(Math.max(A.length, B.length), "_")}\n${result}`;
  steps.push(`<b>Answer = ${result}</b>`);

  // Sync frame count with step count
  while (frames.length < steps.length) frames.push(diagram);

  return { diagram, steps, frames };
}

/* Subtraction */
function t_subSteps(a, b) {
  const steps = [];
  const frames = [];
  const A = String(a), B = String(b);

  const [aInt, aDec = ""] = A.split(".");
  const [bInt, bDec = ""] = B.split(".");
  const decLen = Math.max(aDec.length, bDec.length);
  const AFull = aInt + aDec.padEnd(decLen, "0");
  const BFull = bInt + bDec.padEnd(decLen, "0");

  let swap = false;
  let top = AFull, bottom = BFull;
  if (Number(AFull) < Number(BFull)) {
    swap = true;
    top = BFull;
    bottom = AFull;
  }

  const maxLen = Math.max(top.length, bottom.length);
  const AArr = top.padStart(maxLen, "0").split("").map(Number);
  const BArr = bottom.padStart(maxLen, "0").split("").map(Number);
  let borrow = 0;
  const resArr = [];

  steps.push("Subtraction<br><span class='rule'>borrow rule</span>");
  steps.push("Column-by-column subtraction from right to left");

  for (let i = maxLen - 1; i >= 0; i--) {
    let topDigit = AArr[i] - borrow;
    const botDigit = BArr[i];
    if (topDigit < botDigit) {
      topDigit += 10;
      borrow = 1;
      steps.push(`Column ${maxLen - i}: need borrow ‚Üí (${AArr[i]} becomes ${topDigit}), subtract ${botDigit}, write ${topDigit - botDigit}.`);
    } else {
      borrow = 0;
      steps.push(`Column ${maxLen - i}: ${AArr[i]} - ${botDigit} ‚Üí no borrow ‚Üí write ${topDigit - botDigit}.`);
    }
    resArr.unshift(topDigit - botDigit);
    frames.push(`${A}\n-${B}\n${" ".repeat(maxLen - i)}${resArr.join("")}`);
  }

  const intRes = resArr.join("").replace(/^0+/, "") || "0";
  const result = decLen ? `${intRes.slice(0, -decLen)}.${intRes.slice(-decLen)}` : intRes;
  const final = swap && result !== "0" ? "-" + result : result;

  const diagram = `${A}\n-${B}\n${"".padStart(Math.max(A.length, B.length), "_")}\n${final}`;
  steps.push(`<b>Answer = ${final}</b>`);

  // Sync frame count with step count
  while (frames.length < steps.length) frames.push(diagram);

  return { diagram, steps, frames };
}

/* Multiplication */
function t_mulSteps(a,b){
  const steps=[];
  steps.push(`<div class="opHdr"><b>Multiplication</b><span class="badge">carry rule</span></div>`);
  const n=t_normalizeMul(a,b); const A=n.A,B=n.B,shift=n.shift;
  const aD=A.split('').map(Number),bD=B.split('').map(Number); const partials=[];
  for(let i=bD.length-1,pos=0;i>=0;i--,pos++){
    const bd=bD[i]; let carry=0,row=''; steps.push(`<b>Multiplying by ${bd}</b>`);
    for(let j=aD.length-1;j>=0;j--){
      const ad=aD[j], prod=ad*bd+carry, d=prod%10, nc=Math.floor(prod/10);
      steps.push(`${ad} √ó ${bd} + carry ${carry} = ${prod} ‚Üí <span class='red'>carry ${nc}</span>, <span class='green'>write ${d}</span>.`);
      row=d+row; carry=nc;
    }
    if(carry){row=carry+row;steps.push(`<span class='red'>Leftover carry ${carry}</span> ‚Üí write at the left.`);}
    row+='0'.repeat(pos); partials.push(row); steps.push(`<i>Partial product: ${row}</i>`);
  }
  function addInt(x,y){let i=x.length-1,j=y.length-1,c=0,res='';while(i>=0||j>=0||c){const s=(+x[i--]||0)+(+y[j--]||0)+c;res=(s%10)+res;c=Math.floor(s/10);}return res.replace(/^0+(?=\d)/,'');}
  let sum='0'; for(const p of partials) sum=addInt(sum,p);
  let res=sum; if(shift>0){if(res.length<=shift)res='0.'+'0'.repeat(shift-res.length)+res;else res=res.slice(0,-shift)+'.'+res.slice(-shift);}
  const w=Math.max(String(a).length,String(b).length,String(res).length)+2;
  let diag=t_padLeft(a,w)+"\n"+t_padLeft('√ó'+b,w)+"\n"+t_padLeft('',w,'‚Äî')+"\n";
  if(partials.length>1){for(const p of partials)diag+=t_padLeft(p,w)+"\n";diag+=t_padLeft('',w,'‚Äî')+"\n";}
  diag+=t_padLeft(res,w);
  steps.push(`Add partial products ‚Üí ${sum}, place decimal ${shift} place(s) ‚Üí <span class='green'>${t_trimZeros(res)}</span>.`);
  steps.push(`<b>Answer = ${t_trimZeros(res)}</b>`); return {diagram:diag,steps};
}
/* Division (enhanced with color steps) */
function t_divSteps(a,b){
  const steps=[];
  if(b===0)return{diagram:'',steps:['‚ùå Cannot divide by 0.']};
  const db=t_decCount(b), factor=10**db, Aint=Math.round(a*factor), B=Math.round(b*factor);
  if(db>0)steps.push(`Normalize: move decimal ${db} place(s) ‚Üí divisor <span class='blue'>${b}‚Üí${B}</span>, dividend <span class='blue'>${a}‚Üí${Aint}</span>`);
  else steps.push(`Divisor is already an integer; <span class='blue'>no normalization</span> needed.`);
  const dividendStr=String(Aint), divisorStr=String(B); const base=divisorStr.length+3;
  const digits=dividendStr.split('').map(Number);
  let used=0, carry=0, q='', lines=[]; let dec=false, decCnt=0, MAX_DEC=4;
  function colFor(len){return base+(used-len);}
  while(used<digits.length||(carry>0&&decCnt<MAX_DEC)){
    if(used<digits.length){carry=carry*10+digits[used];used++;}
    else{if(!dec){q+='.';dec=true;steps.push('<span class="blue">No more digits ‚Üí add decimal point</span> and append zeros.');}
         if(decCnt>=MAX_DEC)break;carry*=10;decCnt++;used++;}
    if(carry<B){ if(q[q.length-1]!='.')q+='0'; lines.push(' '.repeat(colFor(String(carry).length))+String(carry)); continue; }
    const qd=Math.floor(carry/B), sub=qd*B, rem=carry-sub;
    const curr=String(carry), subS=String(sub), remS=String(rem);
    lines.push(' '.repeat(colFor(curr.length))+curr);
    lines.push(' '.repeat(colFor(subS.length))+'-'+subS);
    lines.push(' '.repeat(colFor(subS.length))+'‚Äî'.repeat(subS.length));
    lines.push(' '.repeat(colFor(remS.length))+remS);
    steps.push(`Divide: <span class='green'>${carry}</span> √∑ <span class='green'>${B}</span> = <b>${qd}</b>.`);
    steps.push(`Multiply: <span class='green'>${qd}</span> √ó <span class='green'>${B}</span> = <b>${sub}</b>.`);
    steps.push(`Subtract: <span class='green'>${carry}</span> ‚àí <span class='red'>${sub}</span> = <b>${rem}</b>.`);
    q+=String(qd);carry=rem;
  }
  const qShown=t_trimZeros(Number(a/b).toFixed(4));
  const header1=' '.repeat(base+dividendStr.length-String(qShown).length)+qShown;
  const header2=' '.repeat(base-1)+'¬Ø'+'¬Ø'.repeat(dividendStr.length);
  const header3=`${divisorStr} ) ${dividendStr}`;
  const diagram=[header1,header2,header3,...lines].join('\n');
  steps.push(`<b>Answer = ${qShown}</b>`); return{diagram,steps};
}
function t_solve(){
  const n1=document.getElementById('tn1').value.trim(), n2=document.getElementById('tn2').value.trim(), op=document.getElementById('topSel').value;
  if(!n1||!n2){alert('Enter both numbers');return;}
  const a=Number(n1), b=Number(n2); if(isNaN(a)||isNaN(b)){alert('Enter valid numbers');return;}
  let res;
  if(op==='+')res=t_addSteps(n1,n2);
  else if(op==='‚àí'||op==='-')res=t_subSteps(n1,n2);
  else if(op==='√ó')res=t_mulSteps(n1,n2);
  else res=t_divSteps(a,b);
  document.getElementById('tdiag').textContent=res.diagram;
  document.getElementById('tsteps').innerHTML=res.steps.map(s=>`<div class="step">${s}</div>`).join('');
}

// ===============================
// Step-by-step engine (modal only)
// ===============================
const t_state = {
  frames: [],   // array of diagram strings (one per step)
  steps:  [],   // array of HTML step strings (one per step)
  idx:    -1    // current step index
};

function t_renderFrame() {
  // Show current frame (diagram) and steps up to idx
  const frame = (t_state.idx >= 0 && t_state.idx < t_state.frames.length)
                ? t_state.frames[t_state.idx]
                : (t_state.frames[0] || '');

  document.getElementById('tdiag').textContent = frame;

  const partialSteps = t_state.steps.slice(0, Math.max(0, t_state.idx + 1))
        .map(s => `<div class="step">${s}</div>`).join('');
  document.getElementById('tsteps').innerHTML = partialSteps || '';
}

function t_enableStepControls(enable) {
  document.getElementById('tstepPrev').disabled    = !enable;
  document.getElementById('tstepNext').disabled    = !enable;
  document.getElementById('tstepRestart').disabled = !enable;
}

function t_restartSteps() {
  if (!t_state.frames.length) return;
  t_state.idx = 0;
  t_renderFrame();
}

function t_prevStep() {
  if (!t_state.frames.length) return;
  t_state.idx = Math.max(0, t_state.idx - 1);
  t_renderFrame();
}

function t_nextStep() {
  if (!t_state.frames.length) return;
  t_state.idx = Math.min(t_state.frames.length - 1, t_state.idx + 1);
  t_renderFrame();
}

// Hook buttons
document.getElementById('tstepPrev').addEventListener('click', t_prevStep);
document.getElementById('tstepNext').addEventListener('click', t_nextStep);
document.getElementById('tstepRestart').addEventListener('click', t_restartSteps);

// ===============================
// Helpers reused from your Teacher
// ===============================
function t_trimZeros(s){return (''+s).replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'').replace(/\.$/,'');}
function t_decCount(x){const p=(''+x).split('.');return p.length===2?p[1].length:0;}
function t_padLeft(s,n,ch=' '){s=''+s;while(s.length<n)s=ch+s;return s;}
function t_normalizeDecimals(a,b){const da=t_decCount(a),db=t_decCount(b),k=Math.max(da,db),f=10**k;return{A:Math.round(Number(a)*f),B:Math.round(Number(b)*f),k};}
function t_normalizeMul(a,b){const da=t_decCount(a),db=t_decCount(b);return{A:(''+a).replace('.',''),B:(''+b).replace('.',''),shift:da+db};}
function t_alignForDiagram(a,b,sign){
  const [ai,adRaw='']=String(a).split('.');const[bi,bdRaw='']=String(b).split('.');
  const maxI=Math.max(ai.length,bi.length),maxD=Math.max(adRaw.length,bdRaw.length);
  const ad=maxD?'.'+adRaw.padEnd(maxD,'0'):'';const bd=maxD?'.'+bdRaw.padEnd(maxD,'0'):'';
  const aLine=ai.padStart(maxI,' ')+ad, bLine=bi.padStart(maxI,' ')+bd; const width=Math.max(aLine.length,bLine.length)+2;
  return {width, top:aLine.padStart(width), mid:(sign+bLine).padStart(width), line:'‚Äî'.repeat(width)};
}

// ===================================================
// UPGRADED Teacher solvers to also return step frames
//   each returns {diagram, steps, frames}
// ===================================================

<!-- REPLACE from here:  ‚ñº‚ñº‚ñº  -->
/* ---- Addition (per-column frames; starts with header only) ---- */
function t_addSteps(a,b){
  const frames=[], steps=[];
  const n=t_normalizeDecimals(a,b); let A=n.A,B=n.B,k=n.k;
  const sA=(''+A).split('').reverse(), sB=(''+B).split('').reverse();
  let carry=0,resArr=[];
  const disp=t_alignForDiagram(a,b,'+');
  const header=`${disp.top}\n${disp.mid}\n${disp.line}\n`;
  frames.push(header); // step 0: operands only

  function showPartial(){
    let intRes=resArr.slice().reverse().join('');
    let res=(k===0)?intRes:(intRes.length>k?intRes.slice(0,-k)+'.'+intRes.slice(-k):'0.'+intRes.padStart(k,'0'));
    frames.push(header + t_padLeft(res||'0',disp.width));
  }

  steps.push(`<div class="opHdr"><b>Addition</b><span class="badge">carry rule</span></div>`);
  for(let i=0;i<Math.max(sA.length,sB.length);i++){
    const da=+sA[i]||0, db=+sB[i]||0, sum=da+db+carry;
    const digit=sum%10, newCarry=Math.floor(sum/10);
    steps.push(`Column ${i+1}: ${da} + ${db}${carry?` + carry <span class='red'>${carry}</span>`:''} = ${sum} ‚Üí <span class='red'>carry ${newCarry}</span>, <span class='green'>write ${digit}</span>.`);
    resArr.push(digit); carry=newCarry; showPartial();
  }
  if(carry){steps.push(`<span class='red'>Final carry ${carry}</span> ‚Üí write at the leftmost column.`); resArr.push(carry); showPartial();}

  const intRes=resArr.reverse().join('');
  const res=(k===0)?intRes:(intRes.length>k?intRes.slice(0,-k)+'.'+intRes.slice(-k):'0.'+intRes.padStart(k,'0'));
  const diagram=header + t_padLeft(res,disp.width);
  // ensure final Answer appears in both modes
  const finalFrame = `${disp.top}\n${disp.mid}\n${disp.line}\n${t_padLeft(res, disp.width)}`;
  frames.push(finalFrame);
  steps.push(`<b>Answer = ${t_trimZeros(res)}</b>`);
  return { diagram, steps, frames };

}

/* ---- Subtraction (per-column frames; header only on step 0) ---- */
function t_subSteps(a,b){
  const frames=[], steps=[];
  const n=t_normalizeDecimals(a,b); let A=n.A,B=n.B,k=n.k, swap=false;
  if(A<B){[A,B]=[B,A];swap=true;steps.push(`<span class='blue'>Since ${a} < ${b}, swap operands</span>; result will be negative.`);}
  const sA=(''+A).split('').reverse(), sB=(''+B).split('').reverse();
  let borrow=0,resArr=[];
  const disp=t_alignForDiagram(a,b,'‚àí');
  const header=`${disp.top}\n${disp.mid}\n${disp.line}\n`;
  frames.push(header); // step 0

  function showPartial(){
    let intRes=resArr.slice().reverse().join('').replace(/^0+(?=\d|$)/,'')||'0';
    let res=(k===0)?intRes:(intRes.length>k?intRes.slice(0,-k)+'.'+intRes.slice(-k):'0.'+intRes.padStart(k,'0'));
    if(swap && res!=='0') res='-'+res;
    frames.push(header + t_padLeft(res,disp.width));
  }

  steps.unshift(`<div class="opHdr"><b>Subtraction</b><span class="badge">borrow rule</span></div>`);
  for(let i=0;i<Math.max(sA.length,sB.length);i++){
    let da=+sA[i]||0, db=+sB[i]||0; da-=borrow;
    if(da<db){
      steps.push(`Column ${i+1}: ${da+borrow} < ${db} ‚Üí <span class='blue'>borrow 1</span> ‚Üí ${da+10} ‚àí ${db} = <span class='green'>${da+10-db}</span>.`);
      resArr.push(da+10-db); borrow=1;
    }else{
      steps.push(`Column ${i+1}: ${da} ‚â• ${db} ‚Üí <span class='blue'>no borrow</span> ‚Üí ${da} ‚àí ${db} = <span class='green'>${da-db}</span>.`);
      resArr.push(da-db); borrow=0;
    }
    showPartial();
  }
  while(resArr.length>1 && resArr[resArr.length-1]===0)resArr.pop();
  let intRes=resArr.reverse().join('')||'0';
  let res=(k===0)?intRes:(intRes.length>k?intRes.slice(0,-k)+'.'+intRes.slice(-k):'0.'+intRes.padStart(k,'0'));
  if(swap && res!=='0')res='-'+res;

  const diagram=header + t_padLeft(res,disp.width);
  // ensure final Answer appears in both modes
  const finalFrame = `${disp.top}\n${disp.mid}\n${disp.line}\n${t_padLeft(res, disp.width)}`;
  frames.push(finalFrame);
  steps.push(`<b>Answer = ${t_trimZeros(res)}</b>`);
  return { diagram, steps, frames };

}

/* ---- Multiplication (strict 1:1 step-frame sync) ---- */
function t_mulSteps(a,b){
  const frames=[];          // what shows in Work Area, one per click
  const stepsSlim=[];       // exactly one caption per frame (kept in sync)

  // Title badge (shown in one-shot mode; in step mode we prepend it to first step)
  const opBadge = `<div class="opHdr"><b>Multiplication</b><span class="badge">carry rule</span></div>`;

  // normalize for decimals
  const n = t_normalizeMul(a,b);
  const A = n.A, B = n.B, shift = n.shift;

  const aD = A.split('').map(Number);
  const bD = B.split('').map(Number);

  const w = Math.max(String(a).length, String(b).length) + 3;
  const header = t_padLeft(a,w) + "\n" + t_padLeft('√ó'+b,w) + "\n" + t_padLeft('',w,'‚Äî') + "\n";

  // frame 0: show operands only
  frames.push(header);
  stepsSlim.push(opBadge + `Ready to multiply digit by digit.`);

  const partials = [];

  // helper to push a frame + exactly one step line
  function pushFrame(partialsView, stepLine){
    const block = partialsView.length ? partialsView.map(p => t_padLeft(p,w)).join("\n") + "\n" : "";
    frames.push(header + block);
    stepsSlim.push(stepLine);
  }

  for (let i = bD.length - 1, pos = 0; i >= 0; i--, pos++) {
    const bd = bD[i];
    let carry = 0, row = '';
    let firstDigitOfThisMultiplier = true;

    for (let j = aD.length - 1; j >= 0; j--) {
      const ad = aD[j];
      const prod = ad * bd + carry;
      const d = prod % 10;
      const nc = Math.floor(prod / 10);
      row = d + row;

      const stepLine =
        (firstDigitOfThisMultiplier ? `<b>Multiplying by ${bd}</b><br>` : "") +
        `${ad} √ó ${bd} + carry ${carry} = ${prod} ‚Üí <span class='red'>carry ${nc}</span>, <span class='green'>write ${d}</span>.`;

      // show work area up to current digit (with positional zeros previewed)
      const temp = [...partials, row.padEnd(row.length + pos, '0')];
      pushFrame(temp, stepLine);

      carry = nc;
      firstDigitOfThisMultiplier = false;
    }

    if (carry) {
      row = carry + row;
      const temp = [...partials, row.padEnd(row.length + pos, '0')];
      pushFrame(temp, `<span class='red'>Leftover carry ${carry}</span> ‚Üí write at the left.`);
    }

    // finalize this partial (append positional zeros)
    row += '0'.repeat(pos);
    partials.push(row);
    pushFrame([...partials], `<i>Partial product ready: ${row}</i>`);
  }

  // sum the partials (integer add)
  function addInt(x,y){
    let i=x.length-1, j=y.length-1, c=0, res='';
    while(i>=0 || j>=0 || c){
      const s=(+x[i--]||0)+(+y[j--]||0)+c;
      res=(s%10)+res; c=Math.floor(s/10);
    }
    return res.replace(/^0+(?=\d)/,'');
  }
  let sum='0'; for (const p of partials) sum = addInt(sum,p);

  // apply decimal shift
  let res = sum;
  if (shift > 0) {
    if (res.length <= shift) res = '0.' + '0'.repeat(shift - res.length) + res;
    else res = res.slice(0,-shift) + '.' + res.slice(-shift);
  }

  // final frame (full layout with separator and result)
  const finalDiagram =
    header +
    partials.map(p => t_padLeft(p,w)).join("\n") + "\n" +
    t_padLeft('',w,'‚Äî') + "\n" +
    t_padLeft(res,w);

  frames.push(finalDiagram);
  stepsSlim.push(`Add partial products ‚Üí ${sum}, place decimal ${shift} place(s) ‚Üí <span class='green'>${t_trimZeros(res)}</span>.`);

  // return: one-shot diagram + full narrative for non-step mode
  const oneShotSteps = [
    opBadge,
    ...stepsSlim.slice(1), // avoid duplicating the initial "Ready‚Ä¶" text in one-shot
    `<b>Answer = ${t_trimZeros(res)}</b>`
  ];
  return { diagram: finalDiagram, steps: oneShotSteps, frames };
}


// right-align token so its last digit lands at column `col`
function place(col, s){
  s = String(s);
  return ' '.repeat(Math.max(0, col - s.length + 1)) + s;
}

/* ---- Division (synced frames, aligned, color enhanced) ---- */
function t_divSteps(a, b) {
  const steps = [], frames = [];
  if (b === 0)
    return { diagram: '', steps: ['‚ùå Cannot divide by 0.'], frames: [] };

  // normalize decimals
  const db = t_decCount(b), factor = 10 ** db;
  const Aint = Math.round(Number(a) * factor);
  const B = Math.round(Number(b) * factor);

  if (db > 0)
    steps.push(
      `Normalize: move decimal <span class="blue">${db}</span> place(s) ‚Üí divisor <span class="blue">${b}‚Üí${B}</span>, dividend <span class="blue">${a}‚Üí${Aint}</span>.`
    );
  else
    steps.push(
      `Divisor is already an integer; <span class="blue">no normalization needed</span>.`
    );

  const dividendStr = String(Aint);
  const divisorStr = String(B);
  const base = divisorStr.length + 3;

  const digits = dividendStr.split('').map(Number);
  let carry = 0, q = '';
  const lines = [];

  const header2 = ' '.repeat(base - 1) + '¬Ø' + '¬Ø'.repeat(dividendStr.length);
  const header3 = `${divisorStr} ) ${dividendStr}`;

  const pushFrame = (text) => {
    const qPad = base + dividendStr.length - q.length;
    const header1 = ' '.repeat(Math.max(0, qPad)) + q;
    if (text) steps.push(text);
    frames.push([header1, header2, header3, ...lines].join('\n'));
  };

  // first empty frame (header only)
  pushFrame();

  for (let i = 0; i < digits.length; i++) {
    const d = digits[i];
    carry = carry * 10 + d;
    const col = base + i;
    lines.push(place(col, carry));

    if (carry < B) {
      pushFrame(
        `Bring down <span class="blue">${d}</span> ‚Üí current dividend <span class="green">${carry}</span> (too small to divide).`
      );
      continue;
    }

    const qd = Math.floor(carry / B);
    const sub = qd * B;
    const rem = carry - sub;
    q += String(qd);

    // each division block = one combined step + one frame
    lines.push(place(col, '-' + sub));
    lines.push(place(col, '‚Äî'.repeat(String(sub).length)));
    lines.push(place(col, rem));

    pushFrame(
      `Divide <span class="green">${carry}</span> √∑ <span class="green">${B}</span> = <b>${qd}</b>; `
      + `Multiply <span class="green">${qd}</span> √ó <span class="green">${B}</span> = <b>${sub}</b>; `
      + `Subtract <span class="green">${carry}</span> ‚àí <span class="red">${sub}</span> = <b>${rem}</b>.`
    );

    carry = rem;

    // If more digits remain but we hit a 0 remainder, quotient may still get zeros
    if (carry === 0 && i < digits.length - 1) {
      const remaining = digits.slice(i + 1).join('');
      if (remaining.match(/^0+$/)) {
        q += remaining;  // append remaining zeros to quotient
        lines.push(place(base + i + 1, remaining)); // show trailing zeros aligned
        pushFrame(`Bring down remaining zeros ‚Üí quotient extended to <b>${q}</b>.`);
        break;
      }
    }
   }


  const qPadFinal = base + dividendStr.length - q.length;
  const header1F = ' '.repeat(Math.max(0, qPadFinal)) + q;
  const diagram = [
    header1F,
    header2,
    header3,
    ...lines,
    '',
    `Quotient = ${q}, Remainder = ${carry}`,
  ].join('\n');

  steps.push(`<b>Answer ‚Üí Quotient = ${q}, Remainder = ${carry}</b>.`);
  return { diagram, steps, frames };
}


/* -- REPLACE up to here:  ‚ñ≤‚ñ≤‚ñ≤  */


// ===================================================
// t_solve() wrapper: one-shot vs step-by-step
// ===================================================
function t_solve(){
  const n1=document.getElementById('tn1').value.trim(),
        n2=document.getElementById('tn2').value.trim(),
        op=document.getElementById('topSel').value,
        stepMode=document.getElementById('tstepMode').checked;

  if(!n1||!n2){alert('Enter both numbers');return;}
  const a=Number(n1), b=Number(n2); if(isNaN(a)||isNaN(b)){alert('Enter valid numbers');return;}

  let res;
  if(op==='+')      res=t_addSteps(n1,n2);
  else if(op==='‚àí' || op==='-') res=t_subSteps(n1,n2);
  else if(op==='√ó') res=t_mulSteps(n1,n2);
  else              res=t_divSteps(a,b);

  // normal (one-shot)
  if(!stepMode){
    document.getElementById('tdiag').textContent = res.diagram;
    document.getElementById('tsteps').innerHTML  = res.steps.map(s=>`<div class="step">${s}</div>`).join('');
    t_state.frames = []; t_state.steps = []; t_state.idx = -1;
    t_enableStepControls(false);
    return;
  }

  // step-by-step
  t_state.frames = res.frames && res.frames.length ? res.frames : [res.diagram];
  t_state.steps  = res.steps || [];
  t_state.idx    = 0;

  t_enableStepControls(true);
  t_renderFrame();
}

// re-run solve whenever toggling step mode (keeping current inputs)
document.getElementById('tstepMode').addEventListener('change', t_solve);


/* =========================
   Modal wiring + Practice gating + auto-copy current Q
   ========================= */
function updateTeacherButton(){
  const isPractice = document.getElementById('timeSel').value === '0';
  const btn = document.getElementById('teacherBtn');
  btn.disabled = !isPractice;
  btn.title = isPractice ? 'Open Arithmetic Teacher' : 'Available only in Practice (No time)';
}
document.getElementById('timeSel').addEventListener('change', updateTeacherButton);

/* === Arithmetic Teacher Button (fixed subtraction mapping) === */


document.getElementById('teacherBtn').addEventListener('click', () => {


  // Only in Practice (no time)
  if (document.getElementById('timeSel').value !== '0') return;

  const qEl = document.getElementById('question').innerText.trim();
  const tstatus = document.getElementById('tstatus');
  let filled = false;

  if (qEl) {
    // match: a op b  (allow decimals; accept + ‚àí ‚Äì ‚Äî - x X * √ó / : √∑)
    const m = qEl.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*([+\-‚àí‚Äì‚ÄîxX*√ó/:√∑])\s*([0-9]+(?:\.[0-9]+)?)\s*$/);
    if (m) {
      const opRaw = m[2];
      // Normalize display symbol
      const norm = {
        '+': '+',
        '-': '‚àí', '‚àí': '‚àí', '‚Äì': '‚àí', '‚Äî': '‚àí',
        'x': '√ó', 'X': '√ó', '*': '√ó', '√ó': '√ó',
        '/': '√∑', ':': '√∑', '√∑': '√∑'
      }[opRaw] || '√∑';

      // Map to the actual <select> value your modal uses
      // (your HTML uses value="-" for subtraction)
      const topSel = document.getElementById('topSel');
      let selValue = norm;                      // try using the normalized symbol first
      if (![...topSel.options].some(o => o.value === selValue)) {
        // fallback for subtraction: try plain hyphen if "‚àí" isn't a value
        if (norm === '‚àí' && [...topSel.options].some(o => o.value === '-')) {
          selValue = '-';
        }
      }

      // Fill fields
      document.getElementById('tn1').value = m[1];
      document.getElementById('topSel').value = selValue;
      document.getElementById('tn2').value = m[3];

      t_solve();
      tstatus.innerHTML = "Auto-filled from current question";
      filled = true;
    }
  }

  if (!filled) tstatus.innerHTML = "Manual mode ‚Äî enter numbers";

  document.getElementById('teacherModal').style.display = 'flex';
  // üß© Default "Step-by-Step" to unchecked every time modal opens
const stepChk = document.getElementById('tstepMode');
if (stepChk) {
  stepChk.checked = false;
}
// üß© Reset any leftover data to avoid [object Object] issue
if (typeof t_state !== "undefined") {
  t_state.frames = [];
  t_state.steps = [];
  t_state.idx = -1;
}
const diag = document.getElementById('tdiag');
const stepsBox = document.getElementById('tsteps');
if (diag) diag.textContent = '';
if (stepsBox) stepsBox.innerHTML = '';

});


document.getElementById('teacherClose').addEventListener('click', ()=>{document.getElementById('teacherModal').style.display='none';});
document.getElementById('tsolve').addEventListener('click', t_solve);
// Close modal on bg click
document.getElementById('teacherModal').addEventListener('click', (e)=>{
  if(e.target.id==='teacherModal'){document.getElementById('teacherModal').style.display='none';}
});


/* === FIXED PATCH: PowerPoint-style Step-by-Step (stable edition) === */
/*
  üîπ Fixes issue where only Step 1 is shown
  üîπ Keeps Teacher modal clickable
  üîπ Works with all operations (Add, Sub, Mul, Div)
  üîπ Does NOT break your original modal setup
*/

function rebuildStepFrames(res) {
  // Create gradual frames from full diagram and steps
  const lines = res.diagram.split("\n");
  const steps = res.steps || [];
  const frames = [];
  const per = Math.max(1, Math.floor(lines.length / Math.max(1, steps.length)));

  for (let i = 0; i < steps.length; i++) {
    const showLines = lines.slice(0, per * (i + 1)).join("\n");
    frames.push({ diagram: showLines, steps: steps.slice(0, i + 1) });
  }

  if (frames.length === 0) frames.push({ diagram: res.diagram, steps: res.steps });
  return frames;
}

// Replace t_solve to reuse your original logic and add slideshow support
const original_t_solve = t_solve;
t_solve = function() {
  const n1 = document.getElementById('tn1').value.trim();
  const n2 = document.getElementById('tn2').value.trim();
  const op = document.getElementById('topSel').value;
  const stepMode = document.getElementById('tstepMode').checked;

  if (!n1 || !n2) { alert('Enter both numbers'); return; }
  const a = Number(n1), b = Number(n2);
  if (isNaN(a) || isNaN(b)) { alert('Enter valid numbers'); return; }

  // Call existing functions
  let res;
  if (op === '+') res = t_addSteps(n1,n2);
  else if (op === '‚àí' || op === '-') res = t_subSteps(n1,n2);
  else if (op === '√ó') res = t_mulSteps(n1,n2);
  else res = t_divSteps(a,b);

  if (!stepMode) {
    // normal instant mode
    document.getElementById('tdiag').textContent = res.diagram;
    document.getElementById('tsteps').innerHTML = res.steps.map(s => `<div class="step">${s}</div>`).join('');
    t_enableStepControls(false);
    t_state.frames = [];
    return;
  }

  // step-by-step mode
  t_state.frames = rebuildStepFrames(res);
  t_state.steps = res.steps;
  t_state.idx = 0;

  t_enableStepControls(true);
  t_renderFrame();
};

/* === SCORE REPORT LOGGING === */
// when a game ends, append a record
function logScoreEntry() {
  const op = document.getElementById("opSel").value;
  const lvl = document.getElementById("lvlSel").value;
  const timeSel = document.getElementById("timeSel");
  const timeLabel = timeSel.options[timeSel.selectedIndex].text;
  const totalQs = answers.length || 1;
  const entry = {
    dt: new Date().toLocaleString(),
    time: timeLabel,
    op: op,
    lvl: lvl,
    score: `${score}/${totalQs}`
  };
  const log = JSON.parse(localStorage.getItem("scoreLog") || "[]");
  log.unshift(entry);              // newest first
  if (log.length > 200) log.pop(); // keep manageable history
  localStorage.setItem("scoreLog", JSON.stringify(log));
}
// hook into your existing endGame
const orig_endGame = endGame;
endGame = function() {
  orig_endGame(); logScoreEntry();
};

/* === SCORE REPORT MODAL === */
window.addEventListener("load", ()=>{
  document.getElementById("scoreReportBtn").addEventListener("click", showScoreReport);
  document.getElementById("scoreClose").addEventListener("click", ()=>{
    document.getElementById("scoreModal").style.display="none";
  });
});
function showScoreReport(){
  const tbody=document.querySelector("#scoreTable tbody");
  const log=JSON.parse(localStorage.getItem("scoreLog")||"[]");
  tbody.innerHTML = log.length
    ? log.map(r=>`<tr><td>${r.dt}</td><td>${r.time}</td><td>${r.op}</td><td>${r.lvl}</td><td>${r.score}</td></tr>`).join('')
    : `<tr><td colspan="5">No history yet</td></tr>`;
  document.getElementById("scoreModal").style.display="flex";
}

</script>
<!-- ===== Score Report Modal ===== -->
<div id="scoreModal" style="display:none;position:fixed;inset:0;
background:rgba(0,0,0,.45);z-index:14000;align-items:center;justify-content:center">
  <div style="width:min(800px,94vw);max-height:90vh;overflow:auto;
  background:#fffef9;border:3px solid #ff9900;border-radius:14px;
  box-shadow:0 8px 40px rgba(0,0,0,.35);padding:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <b style="color:#b45309;font-size:1.2em;">üìò Score Report</b>
      <button id="scoreClose" style="background:#ff7043;color:#fff;border:none;">‚úñ Close</button>
    </div>
    <table id="scoreTable">
      <thead>
        <tr><th>Date & Time</th><th>Time</th><th>Operation</th><th>Level</th><th>Score</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
</body>
</html>
