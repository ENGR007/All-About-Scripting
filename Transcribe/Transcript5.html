<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Live Recorder & Transcriber Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ===========================================
   GLOBAL VARIABLES & BASE STYLING
   =========================================== */
:root {
  --bg: #0b1020;
  --card-bg: #141b2f;
  --accent: #ffb84d;
  --accent-soft: rgba(255, 184, 77, 0.15);
  --accent-strong: #ff9f1c;
  --border: #26324d;
  --text: #f5f7ff;
  --text-soft: #a7b3d9;
  --danger: #ff4d6a;
  --success: #5bd38a;
  --muted-chip: #1f2942;
  --scroll-thumb: #36456a;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #1d2642 0, #050814 55%, #020309 100%);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

/* ===========================================
   APP CONTAINER
   =========================================== */
.app-shell {
  width: 100%;
  max-width: 1080px;
  margin: 24px;
  background: linear-gradient(145deg, rgba(10, 14, 31, 0.95), rgba(7, 9, 20, 0.98));
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.04);
  box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.02);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  backdrop-filter: blur(20px);
}

/* ===========================================
   HEADER
   =========================================== */
.app-header {
  padding: 18px 22px 14px 22px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  background: radial-gradient(circle at left, rgba(255, 184, 77, 0.13), transparent 60%);
}

.app-title-area {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.app-title {
  font-size: 20px;
  font-weight: 650;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 8px;
}

.title-pill {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.18);
  background: rgba(4, 9, 24, 0.8);
  color: var(--text-soft);
}

.app-subtitle {
  font-size: 12px;
  color: var(--text-soft);
}

.app-badge {
  padding: 4px 10px;
  border-radius: 999px;
  background: var(--accent-soft);
  color: var(--accent-strong);
  font-size: 11px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid rgba(255, 184, 77, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* ===========================================
   BODY LAYOUT (2 COLUMNS)
   =========================================== */
.app-body {
  display: grid;
  grid-template-columns: minmax(0, 2.3fr) minmax(0, 2fr);
  gap: 16px;
  padding: 16px 18px 20px 18px;
}

@media (max-width: 1100px) {
  .app-body {
    grid-template-columns: minmax(0, 1fr);
  }
}

/* ===========================================
   CARDS
   =========================================== */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 14px 14px 12px 14px;
  border: 1px solid var(--border);
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 8px;
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.05em;
  color: var(--text);
}

.card-subtitle {
  font-size: 11px;
  color: var(--text-soft);
}

/* ===========================================
   INPUT FIELDS
   =========================================== */
.field-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

label {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--text-soft);
}

input[type="text"] {
  background: #0b1020;
  border-radius: 10px;
  border: 1px solid var(--border);
  padding: 6px 9px;
  font-size: 13px;
  color: var(--text);
}

textarea {
  width: 100%;
  resize: vertical;
  min-height: 360px;
  max-height: 700px;
  background: #050814;
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 10px;
  font-size: 13px;
  color: var(--text);
  line-height: 1.4;
  font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, monospace;
}

textarea:focus {
  border-color: var(--accent-strong);
  box-shadow: 0 0 0 1px rgba(255, 184, 77, 0.5);
}

/* ===========================================
   BUTTONS
   =========================================== */
button {
  border-radius: 999px;
  border: 1px solid transparent;
  padding: 7px 14px;
  font-size: 12px;
  cursor: pointer;
  background: var(--muted-chip);
  color: var(--text);
}

button:disabled {
  opacity: 0.35;
}

button:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.5);
}

.btn-primary {
  background: var(--accent-strong);
  color: #15100a;
  border-color: rgba(255, 184, 77, 0.9);
}

.btn-danger {
  background: rgba(255, 77, 106, 0.2);
  border-color: rgba(255, 77, 106, 0.7);
  color: var(--danger);
}

.btn-ghost {
  background: transparent;
  border-color: var(--border);
}

/* ===========================================
   SESSION LIST
   =========================================== */
.sessions-list {
  overflow-y: auto;
  max-height: 370px;
  padding-right: 4px;
}

.sessions-list::-webkit-scrollbar {
  width: 6px;
}

.sessions-list::-webkit-scrollbar-thumb {
  background: var(--scroll-thumb);
  border-radius: 999px;
}

/* ===========================================
   FULLSCREEN WHEN RECORDING
   =========================================== */
body.recording-mode .app-body {
  display: block !important;
  grid-template-columns: 1fr !important;
}

body.recording-mode .card {
  width: 100% !important;
  max-width: none !important;
  border-radius: 0 !important;
  min-height: 100vh !important;
}

body.recording-mode section.card:first-of-type {
  height: 100vh !important;
  overflow-y: auto !important;
}

body.recording-mode #transcriptArea {
  height: 75vh !important;
  min-height: 75vh !important;
  max-height: 75vh !important;
}

body.recording-mode section.card:nth-of-type(2) {
  display: none !important;
}

/* ===========================================
   AUDIO SCRUBBING FIX
   =========================================== */
audio {
  width: 100% !important;
  touch-action: manipulation !important;
  pointer-events: auto !important;
  position: relative !important;
  z-index: 10;
}
</style>
</head>

<body>
<div class="app-shell">

<header class="app-header">
  <div class="app-title-area">
    <div class="app-title">
      LIVE NOTEBOOK
      <span class="title-pill">Recorder + Transcriber</span>
    </div>
    <div class="app-subtitle">
      Record high-quality audio, see live text, save sessions, and export/import locally.
    </div>
  </div>
  <div class="app-badge">‚óè Live <span>Browser-only</span></div>
</header>

<main class="app-body">
<!-- LEFT PANEL -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Live Capture</div>
      <div class="card-subtitle">Microphone + speech-to-text</div>
    </div>
    <div class="chip-row">
      <span id="speechSupportChip" class="chip">Speech API‚Ä¶</span>
      <span id="audioSupportChip" class="chip">Audio‚Ä¶</span>
    </div>
  </div>

  <div class="field-group">
    <label>Session name</label>
    <input id="sessionName" type="text" placeholder="Optional ‚Äî leave empty for timestamp" />
  </div>

  <div class="field-group">
    <label>Controls</label>
    <div class="row">
      <button id="startBtn" class="btn-primary">‚ñ∂ Start</button>
      <button id="stopBtn" class="btn-danger" disabled>‚ñ† Stop</button>
      <button id="saveSessionBtn" class="btn-ghost" disabled>üíæ Save</button>
    </div>
    <span id="statusText">Idle. Click Start.</span>
    <div><span id="recordTimer" class="hint">Recording time: 00:00</span></div>
  </div>

  <div class="field-group">
    <label>Live transcript</label>
    <textarea id="transcriptArea"></textarea>
  </div>

  <div class="field-group">
    <label>Current audio preview</label>
    <audio id="currentAudio" controls></audio>
  </div>

</section>

<!-- RIGHT PANEL -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Session Notebook</div>
      <div class="card-subtitle">Saved locally in browser</div>
    </div>
    <div><span id="sessionCount">0 sessions</span></div>
  </div>

  <div class="field-group">
    <label>Backup & restore</label>
    <div class="backup-row">
      <button id="exportBtn" class="btn-ghost">‚¨á Export JSON</button>
      <button id="clearAllBtn" class="btn-danger">üóë Clear All</button>
      <input id="importFile" type="file" accept="application/json"/>
    </div>
  </div>

  <div class="field-group">
    <label>Saved sessions</label>
    <div id="sessionsList" class="sessions-list"></div>
  </div>
</section>
</main>
</div>

<script>
/* ============================================================
   BASIC SETUP
   ============================================================ */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
const speechSupportChip = document.getElementById("speechSupportChip");
const audioSupportChip  = document.getElementById("audioSupportChip");

if (!SpeechRecognition) speechSupportChip.textContent = "Speech API: Not supported";
else {
  speechSupportChip.textContent = "Speech API: OK";
  speechSupportChip.classList.add("ok");
}

if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia)
  audioSupportChip.textContent = "Audio: Not supported";
else {
  audioSupportChip.textContent = "Audio: OK";
  audioSupportChip.classList.add("ok");
}

let recognition;
let recognizing = false;
let finalTranscript = "";
let interimTranscript = "";
let mediaRecorder = null;
let recordedChunks = [];
let currentAudioBlob = null;
let isRecording = false;
let recordTimerInterval = null;
let recordStartTime = null;
let lastDurationMs = 0;

/* Local storage + IndexedDB */
const STORAGE_KEY = "LiveNotebook_Sessions_v1";
const DB_NAME     = "LiveNotebookDB_v1";
const AUDIO_STORE = "audioBlobs";
let dbPromise = null;

function getDB(){
  if(!dbPromise){
    dbPromise = new Promise((resolve,reject)=>{
      const req = indexedDB.open(DB_NAME,1);
      req.onupgradeneeded = e=>{
        const db=e.target.result;
        if(!db.objectStoreNames.contains(AUDIO_STORE)){
          db.createObjectStore(AUDIO_STORE);
        }
      };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });
  }
  return dbPromise;
}

async function storeAudioBlob(id,blob){
  const db=await getDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(AUDIO_STORE,"readwrite");
    tx.objectStore(AUDIO_STORE).put(blob,id);
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  });
}
async function loadAudioBlob(id){
  const db=await getDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(AUDIO_STORE,"readonly");
    const req=tx.objectStore(AUDIO_STORE).get(id);
    req.onsuccess=()=>resolve(req.result||null);
    req.onerror=()=>reject(req.error);
  });
}
async function deleteAudioBlob(id){
  const db=await getDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(AUDIO_STORE,"readwrite");
    tx.objectStore(AUDIO_STORE).delete(id);
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  });
}

function loadSessions(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    return JSON.parse(raw);
  }catch(e){return [];}
}
function saveSessions(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

/* ============================================================
   HELPERS
   ============================================================ */
function nowForName(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,"0");
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())
    +"_"+pad(d.getHours())+"-"+pad(d.getMinutes())+"-"+pad(d.getSeconds());
}

function formatDateTime(dt){
  const d=new Date(dt);
  return d.toLocaleString();
}

function formatDuration(ms){
  const sec = Math.floor(ms/1000);
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  let t="";
  if(h>0) t+=h+"h ";
  if(m>0) t+=m+"m ";
  t+=s+"s";
  return t.trim();
}

function downloadBlob(blob,filename){
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadText(text,filename){
  const blob=new Blob([text],{type:"text/plain"});
  downloadBlob(blob,filename);
}

/* ============================================================
   RENDER SESSION LIST
   ============================================================ */
async function renderSessions(){
  const list=document.getElementById("sessionsList");
  const sessions=loadSessions();
  document.getElementById("sessionCount").textContent = sessions.length+" sessions";

  list.innerHTML="";
  if(!sessions.length){
    list.innerHTML="<div class='hint'>No sessions yet.</div>";
    return;
  }

  sessions.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  for(const s of sessions){
    const card=document.createElement("div");
    card.style.padding="10px";
    card.style.borderBottom="1px solid rgba(255,255,255,0.1)";

    const name=document.createElement("input");
    name.type="text";
    name.value=s.name;
    name.style.width="100%";
    name.style.marginBottom="6px";
    name.onchange=()=>{
      const arr=loadSessions();
      const i=arr.findIndex(x=>x.id===s.id);
      if(i>-1){
        arr[i].name=name.value.trim()||arr[i].name;
        saveSessions(arr);
        renderSessions();
      }
    };

    const meta=document.createElement("div");
    meta.style.fontSize="11px";
    meta.style.color="var(--text-soft)";
    const dur = s.durationMs ? " ‚Ä¢ "+formatDuration(s.durationMs) : "";
    meta.textContent = "Saved " + formatDateTime(s.createdAt) + dur;

    const row=document.createElement("div");
    row.style.display="flex";
    row.style.gap="6px";
    row.style.margin="6px 0";

    const play=document.createElement("button");
    play.className="btn-primary";
    play.textContent="‚ñ∂";
    play.onclick=async()=>{
      const blob=await loadAudioBlob(s.id);
      if(!blob){ alert("Missing audio."); return; }
      const url=URL.createObjectURL(blob);
      const audio=document.getElementById("currentAudio");
      audio.src=url;
      audio.play();
    };

    const dlA=document.createElement("button");
    dlA.className="btn-ghost";
    dlA.textContent="Audio";
    dlA.onclick=async()=>{
      const blob=await loadAudioBlob(s.id);
      if(!blob){alert("Missing audio.");return;}
      downloadBlob(blob, (s.name||"Session")+".webm");
    };

    const dlT=document.createElement("button");
    dlT.className="btn-ghost";
    dlT.textContent="Txt";
    dlT.onclick=()=>{
      downloadText(s.transcript || "", (s.name||"Session")+".txt");
    };

    const del=document.createElement("button");
    del.className="btn-danger";
    del.textContent="‚úï";
    del.onclick=async()=>{
      const arr=loadSessions().filter(x=>x.id!==s.id);
      saveSessions(arr);
      await deleteAudioBlob(s.id);
      renderSessions();
    };

    row.append(play,dlA,dlT,del);

    card.append(name,meta,row);
    list.append(card);
  }
}

/* ============================================================
   SPEECH RECOGNITION
   ============================================================ */
function initRecognition(){
  if(!SpeechRecognition) return;
  recognition=new SpeechRecognition();
  recognition.lang="en-US";
  recognition.interimResults=true;
  recognition.continuous=true;

  recognition.onresult=e=>{
    interimTranscript="";
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      const t=r[0].transcript.trim();
      if(r.isFinal){
        finalTranscript += (finalTranscript?" ":"") + t;
      } else {
        interimTranscript += t+" ";
      }
    }
    const ta=document.getElementById("transcriptArea");
    ta.value = finalTranscript + "\n\n" + interimTranscript;
    ta.scrollTop=ta.scrollHeight;
  };

  recognition.onend=()=>{
    if(isRecording){ try{recognition.start();}catch(e){} }
  };
}

initRecognition();

/* ============================================================
   AUDIO RECORDING
   ============================================================ */
async function startRecording(){
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  recordedChunks=[];
  mediaRecorder=new MediaRecorder(stream);

  mediaRecorder.ondataavailable=e=>{
    if(e.data.size>0) recordedChunks.push(e.data);
  };

  mediaRecorder.onstop=()=>{
    const blob=new Blob(recordedChunks,{type:"audio/webm"});
    currentAudioBlob = blob;

    const url = URL.createObjectURL(blob);
    document.getElementById("currentAudio").src=url;
    document.getElementById("saveSessionBtn").disabled=false;
  };

  mediaRecorder.start();  // CONTINUOUS FULL RECORDING (seekable)
}

/* ============================================================
   TIMER
   ============================================================ */
function startTimer(){
  recordStartTime = Date.now();
  const lbl=document.getElementById("recordTimer");
  recordTimerInterval=setInterval(()=>{
    const diff=Date.now()-recordStartTime;
    lbl.textContent="Recording time: "+formatDuration(diff);
  },500);
}

function stopTimer(){
  clearInterval(recordTimerInterval);
  recordTimerInterval=null;
}

/* ============================================================
   BUTTON HANDLERS
   ============================================================ */
document.getElementById("startBtn").onclick = async()=>{
  document.body.classList.add("recording-mode");
  finalTranscript=""; interimTranscript="";
  document.getElementById("transcriptArea").value="";
  recordedChunks=[];
  currentAudioBlob=null;

  isRecording=true;
  document.getElementById("startBtn").disabled=true;
  document.getElementById("stopBtn").disabled=false;
  document.getElementById("saveSessionBtn").disabled=true;

  await startRecording();
  if(recognition){try{recognition.start();}catch(e){}}

  startTimer();
};

document.getElementById("stopBtn").onclick = ()=>{
  document.body.classList.remove("recording-mode");
  isRecording=false;

  stopTimer();
  lastDurationMs = Date.now() - recordStartTime;

  if(mediaRecorder && mediaRecorder.state!=="inactive"){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
  }

  if(recognition && recognizing){
    try{recognition.stop();}catch(e){}
  }

  document.getElementById("startBtn").disabled=false;
  document.getElementById("stopBtn").disabled=true;
};

document.getElementById("saveSessionBtn").onclick = async()=>{
  if(!currentAudioBlob){ alert("No audio recorded."); return;}

  const name=document.getElementById("sessionName").value.trim() || "Session_"+nowForName();
  const createdAt=new Date().toISOString();

  const id = createdAt + "_" + Math.random().toString(36).slice(2);

  await storeAudioBlob(id,currentAudioBlob);

  const sessions=loadSessions();
  sessions.push({
    id,
    name,
    createdAt,
    transcript: finalTranscript,
    mimeType: currentAudioBlob.type,
    durationMs: lastDurationMs
  });
  saveSessions(sessions);
  renderSessions();
};

/* ============================================================
   EXPORT / IMPORT / CLEAR
   ============================================================ */
document.getElementById("exportBtn").onclick = async()=>{
  const out=[];
  const sessions=loadSessions();
  for(const s of sessions){
    const blob=await loadAudioBlob(s.id);
    let b64=null;
    if(blob){
      const r=new FileReader();
      b64 = await new Promise(res=>{
        r.onloadend=()=>res(r.result.split(",")[1]);
        r.readAsDataURL(blob);
      });
    }
    out.push({...s, audioBase64:b64});
  }
  downloadBlob(new Blob([JSON.stringify(out,null,2)],{type:"application/json"}),
               "LiveNotebookBackup_"+nowForName()+".json");
};

document.getElementById("clearAllBtn").onclick = async()=>{
  if(!confirm("Delete ALL saved sessions?")) return;
  localStorage.removeItem(STORAGE_KEY);
  const db=await getDB();
  const tx=db.transaction(AUDIO_STORE,"readwrite");
  tx.objectStore(AUDIO_STORE).clear();
  tx.oncomplete=()=>renderSessions();
};

document.getElementById("importFile").onchange = e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload = async()=>{
    const arr=JSON.parse(r.result);
    const cur=loadSessions();
    for(const item of arr){
      const id=item.id || (item.createdAt+"_"+Math.random().toString(36).slice(2));
      const session={
        id,
        name:item.name,
        createdAt:item.createdAt,
        transcript:item.transcript,
        mimeType:item.mimeType || "audio/webm",
        durationMs:item.durationMs||0
      };
      cur.push(session);

      if(item.audioBase64){
        const byte=atob(item.audioBase64);
        const buf=new Uint8Array(byte.length);
        for(let i=0;i<byte.length;i++) buf[i]=byte.charCodeAt(i);
        const blob=new Blob([buf],{type:session.mimeType});
        await storeAudioBlob(id,blob);
      }
    }
    saveSessions(cur);
    renderSessions();
  };
  r.readAsText(f);
  e.target.value="";
};

/* ============================================================
   INITIAL RENDER
   ============================================================ */
renderSessions();

</script>
</body>
</html>