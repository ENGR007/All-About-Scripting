<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Multi-Language Conversation Translator (Auto Voice Mode)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  :root {
    --bg:#020617; --card:#020617; --border:#1f2937;
    --accent:#0ea5e9; --accent-soft:rgba(56,189,248,0.15);
    --text:#e5e7eb; --muted:#9ca3af; --danger:#fecaca;
  }

  * { box-sizing:border-box; }

  body {
    margin:0; padding:14px;
    background:radial-gradient(circle at top,#1f2937,#020617 50%);
    font-family:system-ui,-apple-system,BlinkMacSystemFont;
    color:var(--text);
  }

  .app {
    max-width:900px; margin:auto;
    background:var(--card); padding:16px;
    border-radius:16px; border:1px solid var(--border);
    box-shadow:0 20px 45px rgba(0,0,0,0.6);
  }

  h1 { font-size:1.2rem; margin:0 0 6px; }
  .subtitle { font-size:.8rem; color:var(--muted); margin-bottom:10px; }

  textarea {
    width:100%; min-height:130px; padding:8px;
    background:#020617; color:var(--text);
    border-radius:10px; border:1px solid var(--border);
    font-size:.9rem; resize:vertical;
  }

  select {
    width:100%; padding:10px; margin-top:6px;
    background:#020617; color:var(--text);
    border-radius:8px; border:1px solid var(--border);
  }

  button {
    border:none; border-radius:999px;
    padding:12px; cursor:pointer;
    font-size:.9rem;
  }

  .btn-rec { background:#ef4444; color:white; width:100%; margin-top:8px; }
  .btn-stop { background:#475569; color:white; width:100%; margin-top:6px; }

  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media(max-width:720px){ .row { grid-template-columns:1fr; } }

  .btn-speaker {
    background:#111827;
    color:#e5e7eb;
    border:1px solid #1f2937;
    border-radius:12px;
  }
  .btn-speaker.active {
    border-color:#38bdf8;
    box-shadow:0 0 0 1px rgba(56,189,248,0.5);
  }

  .btn-copy  { background:#38bdf8; color:#0b1120; width:100%; }
  .btn-clear { background:#1e293b; color:white; width:100%; }
  .btn-speak { background:#10b981; color:white; width:100%; margin-top:8px; }
  .btn-save  { background:#22c55e; color:#052e16; width:100%; margin-top:8px; }

  .conv-box {
    margin-top:6px; padding:10px;
    background:#020617;
    border:1px solid var(--border);
    border-radius:12px;
    max-height:240px;
    overflow-y:auto;
    font-size:.8rem;
    white-space:pre-wrap;
  }

  .status { margin-top:10px; color:var(--muted); }
  .error { color:var(--danger); min-height:18px; }

</style>
</head>

<body>
<div class="app">

<h1>üåê Auto Voice Conversation Translator</h1>
<div class="subtitle">
  Fully automatic: voice input language switches based on speaker & selected language.
</div>

<button id="startSpeech" class="btn-rec">üé§ Start Speech</button>
<button id="stopSpeech" class="btn-stop">‚èπ Stop</button>

<div class="row" style="margin-top:8px;">
  <button id="btnYou" class="btn-speaker active">üó£ You Speaking</button>
  <button id="btnPartner" class="btn-speaker">üë§ Partner Speaking</button>
</div>

<label>Source language (You)</label>
<select id="sourceLang">
  <option value="en">English</option>
  <option value="tl">Filipino</option>
  <option value="zh-CN">Chinese</option>
  <option value="ja">Japanese</option>
  <option value="ko">Korean</option>
  <option value="th">Thai</option>
</select>

<label>Target language (Partner)</label>
<select id="targetLang">
  <option value="tl">Filipino</option>
  <option value="en">English</option>
  <option value="zh-CN">Chinese</option>
  <option value="ja">Japanese</option>
  <option value="ko">Korean</option>
  <option value="th">Thai</option>
</select>

<div class="row">
  <textarea id="sourceText" placeholder="Speak or type here‚Ä¶"></textarea>
  <textarea id="targetText" readonly placeholder="Translation here‚Ä¶"></textarea>
</div>

<div class="row">
  <button id="btnCopy" class="btn-copy">üìã Copy</button>
  <button id="btnClear" class="btn-clear">üßπ Clear</button>
</div>

<button id="btnSpeak" class="btn-speak">üîä Speak Translation</button>
<button id="btnSaveTranscript" class="btn-save">üíæ Save Transcript</button>

<div class="conv-title" style="margin-top:10px;">Conversation Transcript</div>
<div id="conversationBox" class="conv-box">No conversation yet.</div>

<div id="statusText" class="status">Status: Idle</div>
<div id="errorBox" class="error"></div>
</div>

<!-- Pinyin for Chinese -->
<script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.27.0/dist/index.js"></script>

<script>
/* ---------------- DOM ---------------- */
const startSpeechBtn = document.getElementById("startSpeech");
const stopSpeechBtn  = document.getElementById("stopSpeech");
const sourceText     = document.getElementById("sourceText");
const targetText     = document.getElementById("targetText");
const sourceLangSel  = document.getElementById("sourceLang");
const targetLangSel  = document.getElementById("targetLang");
const statusText     = document.getElementById("statusText");
const errorBox       = document.getElementById("errorBox");
const btnYou         = document.getElementById("btnYou");
const btnPartner     = document.getElementById("btnPartner");
const btnCopy        = document.getElementById("btnCopy");
const btnClear       = document.getElementById("btnClear");
const btnSpeak       = document.getElementById("btnSpeak");
const btnSaveTrans   = document.getElementById("btnSaveTranscript");
const conversationBox = document.getElementById("conversationBox");

let activeSpeaker = "you";
let transcriptEntries = [];

/* ---------------- SPEAKER BUTTONS ---------------- */
btnYou.onclick = () => { activeSpeaker="you"; updateUI(); updateRecognizerLanguage(); };
btnPartner.onclick = () => { activeSpeaker="partner"; updateUI(); updateRecognizerLanguage(); };

function updateUI(){
  btnYou.classList.toggle("active", activeSpeaker==="you");
  btnPartner.classList.toggle("active", activeSpeaker==="partner");
}

/* ---------------- SPEECH RECOGNITION ---------------- */
let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

if (SpeechRecognition){
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
} else {
  statusText.textContent = "Your browser doesn't support speech recognition.";
}

/* AUTOMATIC language switching for speech input */
function updateRecognizerLanguage(){
  if (!recognition) return;

  let sl;

  if (activeSpeaker==="you") sl = sourceLangSel.value;
  else sl = targetLangSel.value;

  const map = {
    "en": "en-US",
    "tl": "fil-PH",
    "zh-CN": "zh-CN",
    "ja": "ja-JP",
    "ko": "ko-KR",
    "th": "th-TH"
  };

  recognition.lang = map[sl] || "en-US";
}

sourceLangSel.onchange = updateRecognizerLanguage;
targetLangSel.onchange = updateRecognizerLanguage;

/* START / STOP */
startSpeechBtn.onclick = () => {
  updateRecognizerLanguage();
  recognition.start();
  statusText.textContent = "Listening‚Ä¶";
};

stopSpeechBtn.onclick = () => {
  recognition.stop();
  statusText.textContent = "Stopped.";
};

/* ON VOICE INPUT */
if (recognition){
  recognition.onresult = (ev)=>{
    let txt="";
    for (let i = ev.resultIndex; i < ev.results.length; i++){
      txt += ev.results[i][0].transcript;
    }
    txt = txt.trim();
    sourceText.value = txt;
    doTranslate();
  };
}

/* ---------------- GOOGLE TRANSLATE ---------------- */
async function gTransRaw(text, sl, tl, extra=""){
  const r = await fetch(
    "https://translate.googleapis.com/translate_a/single?client=gtx" +
    `&sl=${sl}&tl=${tl}&dt=t${extra}&q=` + encodeURIComponent(text)
  );
  return r.json();
}

function extText(d){
  if (!d || !d[0]) return "";
  return d[0].map(x=>x[0]).join("");
}

function extRoman(d){
  if (!d || !d[0]) return "";
  return d[0].map(x=>x[3]).filter(Boolean).join(" ");
}

/* ---------------- TRANSLATE ---------------- */
async function doTranslate(){
  const text = sourceText.value.trim();
  if (!text){ targetText.value=""; return; }

  let sl, tl;
  if (activeSpeaker==="you"){
    sl = sourceLangSel.value;
    tl = targetLangSel.value;
  } else {
    sl = targetLangSel.value;
    tl = sourceLangSel.value;
  }

  const tlLower = tl.toLowerCase();
  try {
    let script="", roman="", english="";

    if (tl==="en" || tl==="tl"){
      targetText.value = extText(await gTransRaw(text, sl, tl));
      appendTranscript(text, targetText.value, sl, tl);
      return;
    }

    if (tlLower.startsWith("zh")){
      script = extText(await gTransRaw(text, sl, tl));
      roman = window.pinyinPro.pinyin(script,{toneType:"mark"});
      english = extText(await gTransRaw(text, sl, "en"));
      targetText.value = `${script}\n${roman}\n${english}`;
    }

    else if (tlLower.startsWith("ja")){
      script = extText(await gTransRaw(text, sl, tl));
      let raw = await gTransRaw(script,"ja","ja","&dt=rm");
      roman = extRoman(raw);
      english = extText(await gTransRaw(text, sl, "en"));
      targetText.value = `${script}\n${roman}\n${english}`;
    }

    else if (tlLower.startsWith("ko") || tlLower.startsWith("th")){
      script = extText(await gTransRaw(text, sl, tl));
      let raw = await gTransRaw(script, tl, tl, "&dt=rm");
      roman = extRoman(raw);
      english = extText(await gTransRaw(text, sl, "en"));
      targetText.value = `${script}\n${roman}\n${english}`;
    }

    else {
      script = extText(await gTransRaw(text, sl, tl));
      english = extText(await gTransRaw(text, sl, "en"));
      targetText.value = `${script}\n${english}`;
    }

    appendTranscript(text, targetText.value, sl, tl);

  } catch(e){
    errorBox.textContent = "Error: " + e.message;
  }
}

/* ---------------- TRANSCRIPT ---------------- */
function appendTranscript(src, out, sl, tl){
  const time = new Date().toLocaleTimeString();
  transcriptEntries.push(`[${time}] (${sl}‚Üí${tl})
Source: ${src}
Translation: ${out}`);

  conversationBox.textContent = transcriptEntries.join("\n\n");
}

/* ---------------- SPEAK TRANSLATION (female preferred) ---------------- */
btnSpeak.onclick = async ()=>{
  let txt = targetText.value.trim();
  if (!txt) return;

  let lines = txt.split("\n").filter(Boolean);
  let speakText = lines[0];
  let sl, tl;

  if (activeSpeaker==="you"){
    sl = sourceLangSel.value;
    tl = targetLangSel.value;
  } else {
    sl = targetLangSel.value;
    tl = sourceLangSel.value;
  }

  const map = {
    "en":"en-US","tl":"fil-PH","zh-CN":"zh-CN","ja":"ja-JP","ko":"ko-KR","th":"th-TH"
  };

  let lang = map[tl] || "en-US";

  await new Promise(res=>{
    if (speechSynthesis.getVoices().length) return res();
    speechSynthesis.onvoiceschanged=res;
  });

  let voices = speechSynthesis.getVoices();
  let female = voices.find(v =>
    v.lang===lang && (/female/i.test(v.name) || /Â•≥/i.test(v.name))
  );

  if (!female){
    female = voices.find(v =>
      v.lang===lang &&
      (/Google/.test(v.name) || /Samantha/.test(v.name) ||
       /Kyoko/.test(v.name) || /Mei-Jia/.test(v.name) )
    );
  }

  let voice = female || voices.find(v=>v.lang===lang) || voices[0];

  const utter = new SpeechSynthesisUtterance(speakText);
  utter.voice = voice;
  utter.lang  = lang;
  utter.pitch = 1;
  utter.rate  = 1;

  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
};

/* ---------------- COPY / CLEAR ---------------- */
btnCopy.onclick = () => navigator.clipboard.writeText(targetText.value.trim());
btnClear.onclick = ()=>{
  sourceText.value="";
  targetText.value="";
  errorBox.textContent="";
  statusText.textContent="Idle";
};
</script>

</body>
</html>