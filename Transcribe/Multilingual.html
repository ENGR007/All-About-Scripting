<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Multi-Language Conversation Translator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  :root {
    --bg:#020617; --card:#020617; --border:#1f2937;
    --accent:#0ea5e9; --accent-soft:rgba(56,189,248,0.15);
    --text:#e5e7eb; --muted:#9ca3af; --danger:#fecaca;
  }
  * { box-sizing:border-box; }
  body {
    margin:0; padding:14px;
    background:radial-gradient(circle at top,#1f2937,#020617 50%);
    font-family:system-ui,-apple-system,BlinkMacSystemFont;
    color:var(--text);
  }
  .app {
    max-width:900px; margin:auto; background:var(--card);
    padding:16px; border-radius:16px; border:1px solid var(--border);
    box-shadow:0 20px 45px rgba(0,0,0,0.6);
  }
  h1 { font-size:1.2rem; margin:0 0 6px; display:flex; gap:10px; }
  .subtitle { font-size:.8rem; margin-bottom:10px; color:var(--muted); }
  textarea {
    width:100%; min-height:130px; padding:8px;
    background:#020617; color:var(--text);
    border-radius:10px; border:1px solid var(--border);
  }
  select {
    width:100%; padding:10px; margin-top:6px;
    background:#020617; color:var(--text);
    border-radius:8px; border:1px solid var(--border);
  }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  .btn-speaker { flex:1; padding:10px; background:#111827; color:white; border-radius:12px; }
  .btn-speaker.active { border:1px solid #38bdf8; }
  button { border:none; border-radius:999px; padding:12px; cursor:pointer; font-size:.9rem; }
  .btn-rec { background:#ef4444; color:white; }
  .btn-stop { background:#475569; color:white; }
  .btn-copy { background:#38bdf8; color:#0b1120; }
  .btn-clear { background:#1e293b; color:white; }
  .btn-speak { background:#10b981; color:white; width:100%; margin-top:8px; }
  .btn-save { background:#22c55e; color:white; width:100%; margin-top:8px; }
  .conv-box {
    margin-top:10px; padding:10px;
    background:#020617; border:1px solid var(--border);
    border-radius:12px; max-height:240px; overflow-y:auto;
    font-size:.8rem; white-space:pre-wrap;
  }
  .status { margin-top:8px; color:var(--muted); font-size:.75rem; }
  .error { color:var(--danger); font-size:.78rem; min-height:16px; }
</style>
</head>

<body>
<div class="app">
  <h1>ğŸŒ Multi-Language Conversation Translator</h1>
  <div class="subtitle">Chinese now shows Characters + Pinyin (tone marks).</div>

  <button id="startSpeech" class="btn-rec">ğŸ¤ Start Speech</button>
  <button id="stopSpeech" class="btn-stop">â¹ Stop</button>

  <div class="row">
    <button id="btnYou" class="btn-speaker active">ğŸ—£ You Speaking</button>
    <button id="btnPartner" class="btn-speaker">ğŸ‘¤ Partner Speaking</button>
  </div>

  <label>Source language</label>
  <select id="sourceLang">
    <option value="en" selected>English</option>
    <option value="tl">Filipino</option>
    <option value="zh-CN">Chinese â†’ Pinyin</option>
    <option value="ja">Japanese â†’ English letters</option>
    <option value="ko">Korean â†’ English letters</option>
    <option value="th">Thai â†’ English letters</option>
  </select>

  <label>Target language</label>
  <select id="targetLang">
    <option value="tl" selected>Filipino</option>
    <option value="en">English</option>
    <option value="zh-CN">Chinese â†’ Pinyin</option>
    <option value="ja">Japanese â†’ English letters</option>
    <option value="ko">Korean â†’ English letters</option>
    <option value="th">Thai â†’ English letters</option>
  </select>

  <div class="row">
    <textarea id="sourceText"></textarea>
    <textarea id="targetText" readonly></textarea>
  </div>

  <div class="row">
    <button id="btnCopy" class="btn-copy">ğŸ“‹ Copy</button>
    <button id="btnClear" class="btn-clear">ğŸ§¹ Clear</button>
  </div>

  <button id="btnSpeak" class="btn-speak">ğŸ”Š Speak Translation</button>
  <button id="btnSaveTranscript" class="btn-save">ğŸ’¾ Save Transcript</button>

  <div class="conv-title">Conversation Transcript</div>
  <div id="conversationBox" class="conv-box">No conversation yet.</div>

  <div id="statusText" class="status">Status: Idle</div>
  <div id="errorBox" class="error"></div>
</div>

<!-- Load pinyin-pro as ES Module -->
<script type="module">
  import { pinyin } from "https://cdn.jsdelivr.net/npm/pinyin-pro@3.15.0/dist/pinyin-pro.esm.min.js";
  window.pinyinPro = { pinyin };
</script>

<script>
/* ---------------- DOM ---------------- */
const sourceText = document.getElementById("sourceText");
const targetText = document.getElementById("targetText");
const sourceLangSelect = document.getElementById("sourceLang");
const targetLangSelect = document.getElementById("targetLang");
const statusText = document.getElementById("statusText");
const errorBox = document.getElementById("errorBox");
const btnSpeak = document.getElementById("btnSpeak");
let activeSpeaker = "you";

/* ---------------- Language switching ---------------- */
document.getElementById("btnYou").onclick = () => activeSpeaker="you";
document.getElementById("btnPartner").onclick = () => activeSpeaker="partner";

/* ---------------- Google Translate API ---------------- */
async function googleTranslate(text, sl, tl){
  const url =
`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;
  const res = await fetch(url);
  const data = await res.json();
  return data[0].map(x => x[0]).join("");
}

/* ---------------- Main translation ---------------- */
async function doTranslate(){
  const text = sourceText.value.trim();
  if (!text) return;

  const sl = activeSpeaker==="you" ? sourceLangSelect.value : targetLangSelect.value;
  const tl = activeSpeaker==="you" ? targetLangSelect.value : sourceLangSelect.value;

  let out = await googleTranslate(text, sl, tl);

  // CHINESE â†’ add pinyin
  if (tl === "zh-CN"){
    const pinyin = window.pinyinPro.pinyin(out, {
      toneType:"tone",
      type:"string"
    });
    targetText.value = out + "\n" + pinyin;
    return;
  }

  // JAPANESE / KOREAN / THAI â†’ show script + English
  if (tl === "ja" || tl==="ko" || tl==="th"){
    const english = await googleTranslate(text, sl, "en");
    targetText.value = out + "\n" + english;
    return;
  }

  // Normal translation
  targetText.value = out;
}

sourceText.addEventListener("input", () => {
  setTimeout(doTranslate, 250);
});

/* ---------------- Speak translation ---------------- */
btnSpeak.onclick = () => {
  const txt = targetText.value.trim();
  if (!txt) return;

  const lines = txt.split("\n");
  const speakText = (lines.length>1) ? lines[1] : lines[0];

  const utter = new SpeechSynthesisUtterance(speakText);
  utter.lang = "en-US"; // universal fallback
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
};
</script>

</body>
</html>