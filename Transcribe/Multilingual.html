<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Multi-Language Conversation Translator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Pinyin library for proper tone-mark Pinyin -->
<script src="https://unpkg.com/pinyin-pro/dist/index.min.js"></script>

<style>
  :root {
    --bg:#020617; --card:#020617; --border:#1f2937;
    --accent:#0ea5e9; --accent-soft:rgba(56,189,248,0.15);
    --text:#e5e7eb; --muted:#9ca3af; --danger:#fecaca;
  }

  * { box-sizing:border-box; }

  body {
    margin:0; padding:14px;
    background:radial-gradient(circle at top,#1f2937,#020617 50%);
    font-family:system-ui,-apple-system,BlinkMacSystemFont;
    color:var(--text);
  }

  .app {
    max-width:900px; margin:auto;
    background:var(--card); padding:16px;
    border-radius:16px; border:1px solid var(--border);
    box-shadow:0 20px 45px rgba(0,0,0,0.6);
  }

  h1 { font-size:1.2rem; margin:0 0 6px; display:flex; gap:10px; }
  .subtitle { font-size:.8rem; color:var(--muted); margin-bottom:10px; }

  textarea {
    width:100%; min-height:130px; padding:8px;
    background:#020617; color:var(--text);
    border-radius:10px; border:1px solid var(--border);
    font-size:.9rem; resize:vertical;
  }
  textarea:focus {
    outline:none; border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent-soft);
  }

  select {
    width:100%; padding:10px; margin-top:6px;
    background:#020617; color:var(--text);
    border-radius:8px; border:1px solid var(--border);
    font-size:.9rem;
  }

  .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  @media(max-width:720px) { .row { grid-template-columns:1fr; } }

  button {
    border:none; border-radius:999px;
    padding:12px; cursor:pointer;
    font-size:.9rem; display:flex; justify-content:center; align-items:center;
  }

  .btn-rec { background:#ef4444; color:white; margin-top:8px; }
  .btn-stop { background:#475569; color:white; margin-top:6px; }

  .btn-speaker {
    flex:1; background:#111827; color:#e5e7eb;
    border:1px solid #1f2937;
    padding:10px; border-radius:12px;
  }
  .btn-speaker.active {
    border-color:#38bdf8;
    box-shadow:0 0 0 1px rgba(56,189,248,0.5);
  }

  .btn-copy { background:#38bdf8; color:#0b1120; }
  .btn-clear { background:#1e293b; color:white; }
  .btn-save { background:#22c55e; color:#052e16; }
  .btn-speak {
    background:#10b981;
    color:white;
    width:100%;
    margin-top:8px;
  }

  .status { margin-top:10px; font-size:.75rem; color:var(--muted); }
  .error { min-height:16px; color:var(--danger); font-size:.78rem; }

  .conv-title { font-size:.8rem; margin-top:12px; color:var(--muted); }

  .conv-box {
    margin-top:6px; padding:10px;
    background:#020617; border:1px solid var(--border);
    border-radius:12px; max-height:240px;
    overflow-y:auto; font-size:.8rem; white-space:pre-wrap;
  }
</style>
</head>

<body>
<div class="app">
  <h1>üåê Multi-Language Conversation Translator</h1>
  <div class="subtitle">
    English ‚Üî Filipino (default). Chinese shows characters + Pinyin (with tones). Japanese/Korean/Thai show script + English meaning.
  </div>

  <!-- Speech Controls -->
  <button id="startSpeech" class="btn-rec">üé§ Start Speech</button>
  <button id="stopSpeech" class="btn-stop">‚èπ Stop</button>

  <!-- Interpreter Mode -->
  <div class="row" style="margin-top:6px;">
    <button id="btnYou" class="btn-speaker active">üó£ You Speaking</button>
    <button id="btnPartner" class="btn-speaker">üë§ Partner Speaking</button>
  </div>

  <!-- Languages -->
  <label style="font-size:.8rem;margin-top:10px;display:block;">Source language (You)</label>
  <select id="sourceLang">
    <option value="en" selected>English</option>
    <option value="tl">Filipino</option>
    <option value="zh-CN">Chinese ‚Üí Pinyin</option>
    <option value="ja">Japanese ‚Üí English letters</option>
    <option value="ko">Korean ‚Üí English letters</option>
    <option value="th">Thai ‚Üí English letters</option>
  </select>

  <label style="font-size:.8rem;margin-top:10px;display:block;">Target language (Partner)</label>
  <select id="targetLang">
    <option value="tl" selected>Filipino</option>
    <option value="en">English</option>
    <option value="zh-CN">Chinese ‚Üí Pinyin</option>
    <option value="ja">Japanese ‚Üí English letters</option>
    <option value="ko">Korean ‚Üí English letters</option>
    <option value="th">Thai ‚Üí English letters</option>
  </select>

  <!-- Text Areas -->
  <div class="row">
    <textarea id="sourceText" placeholder="Speak or type here‚Ä¶"></textarea>
    <textarea id="targetText" readonly placeholder="Translation will appear‚Ä¶"></textarea>
  </div>

  <!-- Utility Buttons -->
  <div class="row">
    <button id="btnCopy" class="btn-copy">üìã Copy Translation</button>
    <button id="btnClear" class="btn-clear">üßπ Clear</button>
  </div>

  <!-- Speak Translated Text -->
  <button id="btnSpeak" class="btn-speak">üîä Speak Translation</button>

  <!-- Transcript Save -->
  <button id="btnSaveTranscript" class="btn-save" style="margin-top:10px;">üíæ Save Transcript</button>

  <!-- Conversation Transcript -->
  <div class="conv-title">Conversation Transcript</div>
  <div id="conversationBox" class="conv-box">No conversation yet.</div>

  <div id="statusText" class="status">Status: Idle</div>
  <div id="errorBox" class="error"></div>
</div>

<script>
/* ---------- DOM ---------- */
const startSpeechBtn = document.getElementById("startSpeech");
const stopSpeechBtn = document.getElementById("stopSpeech");
const sourceText = document.getElementById("sourceText");
const targetText = document.getElementById("targetText");
const sourceLangSelect = document.getElementById("sourceLang");
const targetLangSelect = document.getElementById("targetLang");
const statusText = document.getElementById("statusText");
const errorBox = document.getElementById("errorBox");
const btnCopy = document.getElementById("btnCopy");
const btnClear = document.getElementById("btnClear");
const btnSaveTranscript = document.getElementById("btnSaveTranscript");
const btnSpeak = document.getElementById("btnSpeak");
const conversationBox = document.getElementById("conversationBox");
const btnYou = document.getElementById("btnYou");
const btnPartner = document.getElementById("btnPartner");

/* ---------- State ---------- */
let activeSpeaker = "you";
let transcriptEntries = [];

/* Speaker selection */
function setActiveSpeaker(who){
  activeSpeaker = who;
  btnYou.classList.toggle("active", who === "you");
  btnPartner.classList.toggle("active", who === "partner");
}
btnYou.onclick = () => setActiveSpeaker("you");
btnPartner.onclick = () => setActiveSpeaker("partner");

/* ---------- Speech Recognition ---------- */
let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

if (SpeechRecognition){
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = "en-US";
} else {
  statusText.textContent = "Speech recognition not supported.";
}

startSpeechBtn.onclick = () => {
  if (!recognition) return;
  try { recognition.start(); } catch(e){}
  statusText.textContent = "Listening‚Ä¶";
};
stopSpeechBtn.onclick = () => {
  if (!recognition) return;
  recognition.stop();
  statusText.textContent = "Stopped.";
};

if (recognition){
  recognition.onresult = (event) => {
    let txt = "";
    for (let i = event.resultIndex; i < event.results.length; i++){
      txt += event.results[i][0].transcript;
    }
    sourceText.value = txt.trim();
    doTranslate(true);
  };
}

/* ---------- Typing: auto translate ---------- */
let debounceTimer=null;
sourceText.addEventListener("input", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => doTranslate(false), 350);
});

/* ---------- Dropdown auto refresh ---------- */
sourceLangSelect.addEventListener("change", autoRefreshTranslation);
targetLangSelect.addEventListener("change", autoRefreshTranslation);

function autoRefreshTranslation(){
  if (sourceText.value.trim().length > 0) {
    doTranslate(false);
  }
  if (recognition){
    try { recognition.stop(); } catch(e){}
    try { recognition.start(); } catch(e){}
  }
  statusText.textContent = "Language changed. Refreshed.";
}

/* ---------- Romanization helpers ---------- */
function toPinyin(text){
  if (window.pinyinPro && window.pinyinPro.pinyin){
    return window.pinyinPro.pinyin(text, {
      toneType: "tone",   // tone marks
      type: "string",
      nonZh: "spaced"
    });
  }
  return text;
}

/* ---------- Google Translate wrapper ---------- */
async function googleTranslate(text, sl, tl){
  const url =
    `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=` +
    encodeURIComponent(text);
  const res = await fetch(url);
  const data = await res.json();
  return data[0].map(a => a[0]).join("");
}

/* ---------- Main translation logic ---------- */
async function doTranslate(fromSpeech){
  const text = sourceText.value.trim();
  if (!text){ targetText.value=""; return; }

  let sl, tl;
  if (activeSpeaker === "you"){
    sl = sourceLangSelect.value;
    tl = targetLangSelect.value;
  } else {
    sl = targetLangSelect.value;
    tl = sourceLangSelect.value;
  }

  statusText.textContent = "Translating‚Ä¶";
  errorBox.textContent = "";

  try{
    let rawOut = "";
    let result  = "";

    if (tl === "en" || tl === "tl"){
      // Direct EN or TL
      result = await googleTranslate(text, sl, tl);
      targetText.value = result;
    }
    else if (tl === "zh-CN"){
      // Chinese: characters + Pinyin with tones
      rawOut = await googleTranslate(text, sl, "zh-CN");
      const pinyin = toPinyin(rawOut);
      result = rawOut + "\n" + pinyin;
      targetText.value = result;
    }
    else if (tl === "ja"){
      // Japanese: script + English meaning
      rawOut = await googleTranslate(text, sl, "ja");
      const english = await googleTranslate(text, sl, "en");
      result = rawOut + "\n" + english;
      targetText.value = result;
    }
    else if (tl === "ko"){
      // Korean: script + English meaning
      rawOut = await googleTranslate(text, sl, "ko");
      const english = await googleTranslate(text, sl, "en");
      result = rawOut + "\n" + english;
      targetText.value = result;
    }
    else if (tl === "th"){
      // Thai: script + English meaning
      rawOut = await googleTranslate(text, sl, "th");
      const english = await googleTranslate(text, sl, "en");
      result = rawOut + "\n" + english;
      targetText.value = result;
    }

    appendToTranscript({
      time: new Date(),
      speaker: activeSpeaker === "you" ? "You" : "Partner",
      srcLang: sl,
      tgtLang: tl,
      sourceText: text,
      translatedText: result
    });

    statusText.textContent = "Done.";
  }
  catch(e){
    console.error(e);
    errorBox.textContent = "Error: " + e.message;
    statusText.textContent = "Error.";
  }
}

/* ---------- Transcript handling ---------- */
function formatTime(d){
  return d.toLocaleTimeString([], {
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
}

function appendToTranscript(e){
  transcriptEntries.push(e);
  const txt = transcriptEntries.map(x => {
    return `[${formatTime(x.time)}] ${x.speaker} (${x.srcLang} ‚Üí ${x.tgtLang})
Source     : ${x.sourceText}
Translation: ${x.translatedText}`;
  }).join("\n\n");
  conversationBox.textContent = txt;
  conversationBox.scrollTop    = conversationBox.scrollHeight;
}

/* ---------- Save transcript ---------- */
btnSaveTranscript.onclick = () => {
  if (!transcriptEntries.length){
    errorBox.textContent = "No transcript yet.";
    return;
  }
  const out = transcriptEntries.map(x => {
    return `[${formatTime(x.time)}] ${x.speaker} (${x.srcLang} ‚Üí ${x.tgtLang})
Source     : ${x.sourceText}
Translation: ${x.translatedText}`;
  }).join("\n\n");

  const blob = new Blob([out], {type:"text/plain"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");

  const d  = new Date();
  const fn = `transcript_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}.txt`;

  a.href = url; a.download = fn;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

/* ---------- Speak translation ---------- */
btnSpeak.onclick = () => {
  let text = targetText.value.trim();
  if (!text){
    statusText.textContent = "Nothing to speak.";
    return;
  }

  // If there's a second line (pinyin / English), speak that
  let speakText = text;
  const lines = text.split("\n").map(l => l.trim()).filter(l => l.length>0);
  if (lines.length > 1){
    speakText = lines[lines.length - 1];
  }

  const utter = new SpeechSynthesisUtterance(speakText);

  let tl = activeSpeaker === "you" ? targetLangSelect.value : sourceLangSelect.value;

  if (tl === "en")      utter.lang = "en-US";
  else if (tl === "tl") utter.lang = "fil-PH";
  else if (tl === "zh-CN") utter.lang = "zh-CN";
  else if (tl === "ja") utter.lang = "ja-JP";
  else if (tl === "ko") utter.lang = "ko-KR";
  else if (tl === "th") utter.lang = "th-TH";
  else                 utter.lang = "en-US";

  utter.rate   = 1.0;
  utter.pitch  = 1.0;
  utter.volume = 1.0;

  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
  statusText.textContent = "Speaking translation‚Ä¶";
};

/* ---------- Copy & Clear ---------- */
btnCopy.onclick = async () => {
  const txt = targetText.value.trim();
  if (!txt) return;
  try {
    await navigator.clipboard.writeText(txt);
    statusText.textContent = "Copied!";
  } catch {
    statusText.textContent = "Copy failed.";
  }
};

btnClear.onclick = () => {
  sourceText.value = "";
  targetText.value = "";
  statusText.textContent = "Idle";
  errorBox.textContent = "";
};
</script>

</body>
</html>