<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Multi-Language Speech Translator (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* SAME STYLES â€” trimmed for brevity (keep your design) */
body { background:#050b18; color:#fff; font-family:system-ui; padding:16px; }
.app { max-width:900px; margin:auto; background:#0b1220; padding:16px; border-radius:16px; }
textarea, select { width:100%; margin-top:10px; padding:10px; border-radius:8px; background:#111a2c; color:white; border:1px solid #223; }
button { width:100%; padding:12px; margin-top:10px; border-radius:10px; border:none; font-size:16px; }
</style>
</head>

<body>

<div class="app">
  <h2>ğŸŒ Multi-Language Translator (Fixed)</h2>

  <button id="startSpeech" style="background:#ef4444;color:white;">ğŸ¤ Start Speech</button>
  <button id="stopSpeech" style="background:#475569;color:white;">â¹ Stop</button>

  <label>Source Language</label>
  <select id="sourceLang">
    <option value="en" selected>English</option>
    <option value="tl">Filipino</option>
    <option value="zh-CN">Chinese â†’ Pinyin</option>
    <option value="ja">Japanese â†’ Romaji</option>
    <option value="ko">Korean â†’ Romanization</option>
    <option value="th">Thai â†’ RTGS</option>
  </select>

  <label>Target Language</label>
  <select id="targetLang">
    <option value="tl" selected>Filipino</option>
    <option value="en">English</option>
    <option value="zh-CN">Chinese â†’ Pinyin</option>
    <option value="ja">Japanese â†’ Romaji</option>
    <option value="ko">Korean â†’ Romanization</option>
    <option value="th">Thai â†’ RTGS</option>
  </select>

  <textarea id="sourceText" placeholder="Speak or type hereâ€¦"></textarea>
  <textarea id="targetText" readonly placeholder="Translation appears hereâ€¦"></textarea>

  <button id="btnCopy" style="background:#38bdf8;">ğŸ“‹ Copy</button>
  <button id="btnClear" style="background:#333;">ğŸ§¹ Clear</button>

  <div id="statusText" style="margin-top:10px;color:#aaa;">Status: Idle</div>
  <div id="errorBox" style="color:#f88;margin-top:5px;"></div>
</div>

<script>
/* ---------------------- SPEECH ---------------------- */
let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = "en-US"; // work-around for iPhone Safari
}

document.getElementById("startSpeech").onclick = () => {
    recognition.start();
    statusText.textContent = "Status: Listeningâ€¦";
};
document.getElementById("stopSpeech").onclick = () => {
    recognition.stop();
    statusText.textContent = "Status: Stopped.";
};

recognition.onresult = (event) => {
    let text = "";
    for (let i = event.resultIndex; i < event.results.length; i++)
        text += event.results[i][0].transcript;

    sourceText.value = text.trim();
    doTranslate();
};

/* ---------------------- TYPE AUTO-TRANSLATE ---------------------- */
sourceText.addEventListener("input", () => {
    clearTimeout(window.debounce);
    window.debounce = setTimeout(doTranslate, 350);
});

/* ---------------------- ROMANIZATION ---------------------- */
function toPinyin(t){ return t.normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
function toRomaji(t){ return t.replace(/shi/g,"shi").replace(/tsu/g,"tsu"); }
function koreanRomanize(t){ return t.replace(/eo/g,"Å").replace(/eu/g,"Å­").replace(/ui/g,"Å­i"); }
function thaiRomanize(t){ return t.replace(/kh/g,"kh").replace(/ph/g,"ph").replace(/th/g,"th"); }

/* ---------------------- GOOGLE TRANSLATE ---------------------- */
async function googleTranslate(text, sl, tl) {
    const url =
      "https://translate.googleapis.com/translate_a/single?client=gtx" +
      `&sl=${sl}&tl=${tl}&dt=t&q=` + encodeURIComponent(text);

    const res = await fetch(url);
    const data = await res.json();
    return data[0].map(a => a[0]).join("");
}

/* ---------------------- FIXED TRANSLATION ENGINE ---------------------- */
async function doTranslate() {
    const text = sourceText.value.trim();
    if (!text) return;

    const sl = sourceLang.value;
    const tl = targetLang.value;

    statusText.textContent = "Translatingâ€¦";

    try {
        let translated = "";

        /* 1) Target is ENGLISH */
        if (tl === "en") {
            translated = await googleTranslate(text, sl, "en");
        }

        /* 2) Target is FILIPINO */
        else if (tl === "tl") {
            translated = await googleTranslate(text, sl, "tl");
        }

        /* 3) Chinese / Japanese / Korean / Thai â†’ ROMANIZED */
        else if (tl === "zh-CN") {
            let out = await googleTranslate(text, sl, "zh-CN");
            translated = toPinyin(out);
        }
        else if (tl === "ja") {
            let out = await googleTranslate(text, sl, "ja");
            translated = toRomaji(out);
        }
        else if (tl === "ko") {
            let out = await googleTranslate(text, sl, "ko");
            translated = koreanRomanize(out);
        }
        else if (tl === "th") {
            let out = await googleTranslate(text, sl, "th");
            translated = thaiRomanize(out);
        }

        targetText.value = translated;
        statusText.textContent = "Done.";

    } catch (e) {
        errorBox.textContent = "Error: " + e.message;
        statusText.textContent = "Error.";
    }
}

/* ---------------------- COPY / CLEAR ---------------------- */
btnCopy.onclick = async () => {
    if (!targetText.value) return;
    await navigator.clipboard.writeText(targetText.value);
    statusText.textContent = "Copied.";
};

btnClear.onclick = () => {
    sourceText.value = "";
    targetText.value = "";
    errorBox.textContent = "";
    statusText.textContent = "Idle";
};
</script>

</body>
</html>