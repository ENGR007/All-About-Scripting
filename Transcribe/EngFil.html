<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Filipino ‚Üî English Translator + Live Speech Input</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --border: #1f2937;
      --accent: #0ea5e9;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #fecaca;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 14px;
      background: radial-gradient(circle at top, #1f2937 0, #020617 50%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      color: var(--text);
    }
    .app {
      max-width: 900px; margin:auto;
      background: var(--card); padding: 16px;
      border-radius: 16px; border:1px solid var(--border);
      box-shadow: 0 20px 45px rgba(0,0,0,0.6);
    }
    h1 { font-size:1.2rem; display:flex; gap:8px; margin:0 0 6px; }
    .subtitle { font-size:.8rem; color:var(--muted); margin-bottom:10px; }
    textarea {
      width:100%; min-height:140px; padding:8px;
      background:#020617; color:var(--text);
      border-radius:10px; font-size:.9rem;
      border:1px solid var(--border);
    }
    textarea:focus { outline:none; border-color:var(--accent); }
    .row { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    @media(max-width:720px){ .row{grid-template-columns:1fr;} }

    button {
      border:none; border-radius:999px;
      padding:10px; cursor:pointer;
      font-size:.9rem; display:flex; justify-content:center;
    }
    .btn-rec { background:#ef4444; color:white; margin-top:12px; }
    .btn-stop { background:#475569; color:white; margin-top:6px; }
    .btn-copy { background:#38bdf8; color:#0b1120; }
    .btn-clear { background:#1e293b; color:white; }

    .swap-row { display:flex; justify-content:space-between; align-items:center; margin-top:10px; }
    .swap-btn {
      padding:6px 12px; border-radius:999px;
      background:#020617; border:1px solid var(--border); color:white;
    }

    .pill {
      padding:4px 10px; border-radius:999px;
      background:var(--accent-soft); border:1px solid #38bdf8;
      font-size:.75rem; color:#bae6fd;
    }
    .status { margin-top:10px; font-size:.75rem; color:var(--muted); }
    .error { color:var(--danger); font-size:.78rem; min-height:16px; }
  </style>
</head>

<body>
<div class="app">
  <h1>üåê Filipino ‚Üî English Translator</h1>
  <div class="subtitle">Supports typing + live speech input.</div>

  <button id="startSpeech" class="btn-rec">üé§ Start Speech</button>
  <button id="stopSpeech" class="btn-stop">‚èπ Stop</button>

  <div class="swap-row">
    <div class="pill">Mode: <span id="modeLabel">Filipino ‚Üí English</span></div>
    <button id="btnSwap" class="swap-btn">‚áÑ Swap</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <textarea id="sourceText" placeholder="Mag-type o magsalita ng Filipino dito‚Ä¶"></textarea>
    <textarea id="targetText" placeholder="Translation appears here‚Ä¶" readonly></textarea>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnCopy" class="btn-copy">üìã Copy</button>
    <button id="btnClear" class="btn-clear">üßπ Clear</button>
  </div>

  <div id="statusText" class="status">Status: Idle</div>
  <div id="errorBox" class="error"></div>
</div>

<script>
/* -------------------------------
   Speech Recognition (iPhone Safe)
-------------------------------- */
let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;

  // Required for iPhone Safari ‚Äî works for Filipino + English
  recognition.lang = "en-US";
}

/* -------------------------------
   Mode / Swap Logic
------------------------------- */
let modeFilToEng = true;
const src = document.getElementById("sourceText");
const tgt = document.getElementById("targetText");

function updateMode() {
  if (modeFilToEng) {
    document.getElementById("modeLabel").textContent = "Filipino ‚Üí English";
    src.placeholder = "Mag-type o magsalita ng Filipino dito‚Ä¶";
    tgt.placeholder = "English translation appears here‚Ä¶";
  } else {
    document.getElementById("modeLabel").textContent = "English ‚Üí Filipino";
    src.placeholder = "Type or speak English here‚Ä¶";
    tgt.placeholder = "Lalabas dito ang salin sa Filipino‚Ä¶";
  }
}
updateMode();

document.getElementById("btnSwap").onclick = () => {
  modeFilToEng = !modeFilToEng;
  const a = src.value, b = tgt.value;
  src.value = b;
  tgt.value = a;
  updateMode();
  doTranslate();
};

/* -------------------------------
   Speech Events
------------------------------- */
document.getElementById("startSpeech").onclick = () => {
  try { recognition.start(); } catch(e){}
  document.getElementById("statusText").innerText = "Status: Listening‚Ä¶";
};

document.getElementById("stopSpeech").onclick = () => {
  recognition.stop();
  document.getElementById("statusText").innerText = "Status: Stopped.";
};

recognition.onresult = (event) => {
  let text = "";
  for (let i = event.resultIndex; i < event.results.length; i++) {
    text += event.results[i][0].transcript;
  }
  src.value = text;
  doTranslate(); // ‚Üê SPEECH triggers translation
};

/* -------------------------------
   Typing Auto-Translate (FIXED)
------------------------------- */
let debounceTimer = null;
src.addEventListener("input", () => {
  if (debounceTimer) clearTimeout(debounceTimer);
  debounceTimer = setTimeout(doTranslate, 350); // smoother typing
});

/* -------------------------------
   Translation Engine
------------------------------- */
async function translateGoogle(text, sl, tl) {
  const url =
    "https://translate.googleapis.com/translate_a/single?client=gtx" +
    `&sl=${sl}&tl=${tl}&dt=t&q=` + encodeURIComponent(text);
  const res = await fetch(url);
  if (!res.ok) return "";
  const data = await res.json();
  return data[0].map(x => x[0]).join("");
}

async function translateMyMemory(text, sl, tl) {
  const url =
    "https://api.mymemory.translated.net/get?q=" +
    encodeURIComponent(text) + `&langpair=${sl}|${tl}`;
  const res = await fetch(url);
  if (!res.ok) return "";
  const data = await res.json();
  return data?.responseData?.translatedText || "";
}

async function doTranslate() {
  const text = src.value.trim();
  tgt.value = "";
  const status = document.getElementById("statusText");
  const errorBox = document.getElementById("errorBox");

  if (!text) {
    status.innerText = "Status: Idle";
    return;
  }

  status.innerText = "Status: Translating‚Ä¶";
  errorBox.textContent = "";

  const sl = modeFilToEng ? "tl" : "en";
  const tl = modeFilToEng ? "en" : "tl";

  try {
    let translated = await translateGoogle(text, sl, tl);
    if (!translated) translated = await translateMyMemory(text, sl, tl);

    tgt.value = translated;
    status.innerText = "Status: Done.";
  } catch (err) {
    tgt.value = "";
    status.innerText = "Status: Error.";
    errorBox.textContent = err.message;
  }
}

/* -------------------------------
   Buttons
------------------------------- */
document.getElementById("btnClear").onclick = () => {
  src.value = "";
  tgt.value = "";
};

document.getElementById("btnCopy").onclick = async () => {
  try {
    await navigator.clipboard.writeText(tgt.value);
    document.getElementById("statusText").innerText = "Status: Copied.";
  } catch {
    document.getElementById("statusText").innerText = "Status: Copy failed.";
  }
};
</script>
</body>
</html>