<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Notebook Recorder ‚Äî Fast Save Version</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ============================================================
   UI THEME
   ============================================================ */
:root {
    --bg: #0d1220;
    --card: #161b2e;
    --border: #252b40;
    --accent: #3f8cff;
    --accent-soft: rgba(63,140,255,0.14);
    --gold: #ffce47;
    --text: #eef2ff;
    --text-soft: #9aa4c7;
    --red: #e04c65;
    --green: #27e1a9;
}

body {
    background: var(--bg);
    color: var(--text);
    margin: 0;
    font-family: system-ui;
}

header {
    padding: 18px 22px;
    background: #141a33;
}
header h1 { margin: 0; color: var(--gold); }
header p { margin: 5px 0 0; color: var(--text-soft); }

.card {
    background: var(--card);
    margin: 20px auto;
    padding: 18px;
    border-radius: 14px;
    border: 1px solid var(--border);
    max-width: 900px;
}

.section-title {
    color: var(--gold);
    margin-bottom: 12px;
    font-size: .9rem;
    text-transform: uppercase;
}

.controls-row { display: flex; gap: 10px; flex-wrap: wrap; }

button {
    border: none;
    padding: 8px 16px;
    border-radius: 999px;
    cursor: pointer;
    background: var(--accent);
    color: white;
    font-size: .9rem;
}
button:disabled { opacity: .5; cursor: not-allowed; }
.stop-btn { background: var(--red); }

textarea {
    width: 100%;
    min-height: 180px;
    background: #0f1322;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    font-size: .9rem;
}

.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 6px 14px;
    border-radius: 999px;
    background: var(--accent-soft);
    color: var(--text-soft);
}
.status-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #555;
}
.status-dot.live {
    background: var(--green);
    box-shadow: 0 0 7px var(--green);
}

.file-item {
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.file-name { font-size: .85rem; }
.file-btns button { font-size: .75rem; margin-left: 6px; }
.rename-btn { background: #7b8bff; }
.delete-btn { background: var(--red); }
.play-btn { background: var(--green); }

</style>
</head>
<body>

<header>
    <h1>Notebook Recorder</h1>
    <p>Live transcription + fast saving</p>
</header>

<!-- CONTROLS -->
<div class="card">
    <div class="section-title">Controls</div>

    <div class="controls-row">
        <button id="chooseFolderBtn">üìÅ Choose Save Folder</button>
        <button id="startBtn">‚ñ∂ Start Recording</button>
        <button id="stopBtn" class="stop-btn" disabled>‚ñ† Stop</button>
    </div>

    <div class="status-pill">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Ready</span>
    </div>
</div>

<!-- TRANSCRIPTION -->
<div class="card">
    <div class="section-title">Live Transcription</div>
    <textarea id="transcript" readonly></textarea>
</div>

<!-- LIBRARY -->
<div class="card">
    <div class="section-title">Recordings Library</div>
    <div id="libraryList"></div>

    <div style="margin-top:14px;">
        <button id="exportBtn">‚¨á Export ZIP</button>
        <button id="importBtn">‚¨Ü Import ZIP</button>
        <input id="importFileInput" type="file" accept=".zip" style="display:none;">
    </div>
</div>

<audio id="audioPlayer" controls style="display:none;"></audio>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* ======================================================
   GLOBAL STATE
   ====================================================== */
let saveFolder = null;
let recognition = null;
let mediaRecorder = null;
let mediaChunks = [];
let liveTranscript = "";

/* Timestamp format */
function ts() {
    const d = new Date();
    const pad = n => n<10?"0"+n:n;
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} `
         + `${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`;
}

function setStatus(text, live=false){
    document.getElementById("statusText").textContent = text;
    document.getElementById("statusDot").classList.toggle("live", live);
}

/* ======================================================
   SELECT FOLDER
   ====================================================== */
document.getElementById("chooseFolderBtn").onclick = async () => {
    saveFolder = await window.showDirectoryPicker();
    alert("Folder selected!");
    refreshLibrary(); // initial
};

/* ======================================================
   START
   ====================================================== */
document.getElementById("startBtn").onclick = async () => {
    if (!saveFolder) return alert("Choose a save folder first.");

    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) return alert("SpeechRecognition not supported.");

    recognition = new window.SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = "en-US";

    liveTranscript = "";
    document.getElementById("transcript").value = "";

    recognition.onresult = (e) => {
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
            const res = e.results[i];
            if (res.isFinal) {
                liveTranscript += res[0].transcript + " ";
            } else {
                interim += res[0].transcript;
            }
        }
        document.getElementById("transcript").value =
            liveTranscript + "\n" + interim;
    };

    recognition.start();

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaChunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => mediaChunks.push(e.data);
    mediaRecorder.start();

    setStatus("Recording‚Ä¶", true);
    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
};

/* ======================================================
   STOP ‚Äî FAST SAVE VERSION
   ====================================================== */
document.getElementById("stopBtn").onclick = async () => {
    setStatus("Saving‚Ä¶");

    recognition.stop();
    mediaRecorder.stop();

    mediaRecorder.onstop = async () => {
        const blob = new Blob(mediaChunks, { type: "audio/webm" });

        // Ask for title (Option B)
        let name = prompt("Save Session As:", "");
        if (!name || !name.trim()) name = ts();
        name = name.replace(/[\\/:*?"<>|]/g, "-").trim();

        // Save AUDIO instantly
        const audioHandle = await saveFolder.getFileHandle(`${name}.webm`, { create: true });
        const wA = await audioHandle.createWritable();
        wA.write(blob).then(()=>wA.close());

        // Save TEXT instantly
        const txtHandle = await saveFolder.getFileHandle(`${name}.txt`, { create: true });
        const wT = await txtHandle.createWritable();
        wT.write(liveTranscript.trim()).then(()=>wT.close());

        setStatus("Saved ‚úî");
        
        // Background refresh ‚Äî non-blocking
        setTimeout(refreshLibrary, 50);
    };

    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
};

/* ======================================================
   LIBRARY ‚Äî NON BLOCKING
   ====================================================== */
async function refreshLibrary() {
    if (!saveFolder) return;

    const lib = document.getElementById("libraryList");
    lib.innerHTML = "Loading‚Ä¶";

    const items = [];
    for await (const entry of saveFolder.values()) {
        if (entry.kind === "file" && entry.name.endsWith(".webm")) {
            items.push(entry.name.replace(".webm", ""));
        }
    }
    items.sort();

    lib.innerHTML = "";
    for (const base of items) {
        const row = document.createElement("div");
        row.className = "file-item";
        row.innerHTML = `
            <div class="file-name">${base}</div>
            <div class="file-btns">
                <button class="play-btn">‚ñ∂</button>
                <button class="rename-btn">‚úè</button>
                <button class="delete-btn">üóë</button>
            </div>
        `;

        /* PLAY */
        row.querySelector(".play-btn").onclick = async () => {
            const audioHandle = await saveFolder.getFileHandle(base+".webm");
            const file = await audioHandle.getFile();
            const url = URL.createObjectURL(file);
            const player = document.getElementById("audioPlayer");
            player.src = url;
            player.style.display = "block";
            player.play();
        };

        /* RENAME */
        row.querySelector(".rename-btn").onclick = async () => {
            let newName = prompt("Rename:", base);
            if (!newName) return;
            newName = newName.replace(/[\\/:*?"<>|]/g,"-");

            const oldW = await saveFolder.getFileHandle(base+".webm");
            const oldT = await saveFolder.getFileHandle(base+".txt");

            const fileW = await oldW.getFile();
            const fileT = await oldT.getFile();

            // Delete old
            await saveFolder.removeEntry(base+".webm");
            await saveFolder.removeEntry(base+".txt");

            // Write new
            const wH = await saveFolder.getFileHandle(newName+".webm", {create:true});
            const wW = await wH.createWritable();
            await wW.write(await fileW.arrayBuffer());
            await wW.close();

            const tH = await saveFolder.getFileHandle(newName+".txt", {create:true});
            const wT = await tH.createWritable();
            await wT.write(await fileT.text());
            await wT.close();

            refreshLibrary();
        };

        /* DELETE */
        row.querySelector(".delete-btn").onclick = async () => {
            if (!confirm("Delete this recording?")) return;
            await saveFolder.removeEntry(base+".webm");
            await saveFolder.removeEntry(base+".txt");
            refreshLibrary();
        };

        lib.appendChild(row);
    }
}

/* ======================================================
   EXPORT ZIP
   ====================================================== */
document.getElementById("exportBtn").onclick = async () => {
    if (!saveFolder) return alert("Choose a folder first.");
    const zip = new JSZip();

    for await (const entry of saveFolder.values()) {
        if (entry.kind === "file") {
            const file = await entry.getFile();
            zip.file(entry.name, file);
        }
    }

    const blob = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "Notebook_Recordings.zip";
    a.click();
};

/* ======================================================
   IMPORT ZIP
   ====================================================== */
document.getElementById("importBtn").onclick = () => {
    document.getElementById("importFileInput").click();
};

document.getElementById("importFileInput").onchange = async (e) => {
    if (!saveFolder) return alert("Choose a folder first.");
    
    const file = e.target.files[0];
    const zip = await JSZip.loadAsync(file);

    for (const [name, entry] of Object.entries(zip.files)) {
        if (!entry.dir) {
            const blob = await entry.async("blob");
            const handle = await saveFolder.getFileHandle(name, { create: true });
            const w = await handle.createWritable();
            await w.write(blob);
            await w.close();
        }
    }

    alert("Import complete.");
    refreshLibrary();
};
</script>

</body>
</html>