<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Subtitle Auto Translator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: #000;
    color: #f9fafb;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    overflow: hidden;
  }

  /* Thin bar at the TOP, full width */
  .subtitle-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(15, 23, 42, 0.96);
    border-bottom: 1px solid #1f2937;
    padding: 6px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 10;
  }

  .controls {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
  }

  .btn-icon {
    border: none;
    background: #020617;
    color: #e5e7eb;
    border-radius: 999px;
    width: 30px;
    height: 30px;
    font-size: 15px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px solid #1f2937;
  }

  .btn-icon:hover {
    background: #0b1120;
  }

  .btn-icon.playing {
    background: #22c55e;
    color: #022c22;
    border-color: #4ade80;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: #4b5563;
  }

  .status-dot.listening {
    background: #22c55e;
    box-shadow: 0 0 0 4px rgba(34,197,94,0.35);
    animation: pulse 1.2s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
  }

  .subtitle-text {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
    flex-direction: column;
    align-items: center;   /* center horizontally */
    text-align: center;    /* center text */
    line-height: 1.2;
  }

  .line-en,
  .line-other {
    text-shadow: 0 0 4px rgba(0,0,0,0.9);
    white-space: nowrap;       /* keep one line */
    overflow: hidden;
    text-overflow: ellipsis;   /* cut with ... if too long */
  }

  .line-en {
    font-size: 15px;
    font-weight: 500;
  }

  .line-other {
    font-size: 14px;
    margin-top: 1px;
    opacity: 0.95;
  }

  /* Modal */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
  }

  .modal-backdrop.open {
    display: flex;
  }

  .modal {
    background: #020617;
    border-radius: 14px;
    border: 1px solid #1f2937;
    padding: 14px 16px;
    width: 320px;
    color: #e5e7eb;
    box-shadow: 0 20px 45px rgba(0,0,0,0.9);
  }

  .modal h2 {
    font-size: 14px;
    margin: 0 0 8px;
  }

  .modal p {
    font-size: 11px;
    margin: 0 0 8px;
    color: #9ca3af;
  }

  .modal label {
    font-size: 11px;
    margin-bottom: 4px;
    display: block;
    color: #d1d5db;
  }

  .modal select {
    width: 100%;
    background: #020617;
    color: #e5e7eb;
    border-radius: 8px;
    border: 1px solid #1f2937;
    padding: 6px 8px;
    font-size: 12px;
    margin-bottom: 8px;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 10px;
  }

  .btn-sm {
    border-radius: 999px;
    border: 1px solid #1f2937;
    padding: 4px 10px;
    font-size: 11px;
    cursor: pointer;
  }

  .btn-sm.primary {
    background: #0ea5e9;
    color: #0b1120;
    border-color: #38bdf8;
  }

  .btn-sm.secondary {
    background: #020617;
    color: #e5e7eb;
  }

  .error {
    position: fixed;
    left: 50%;
    top: 40px;
    transform: translateX(-50%);
    font-size: 11px;
    color: #fecaca;
    text-shadow: 0 0 4px rgba(0,0,0,0.8);
    max-width: 90vw;
    text-align: center;
  }

  @media (max-width: 480px) {
    .subtitle-bar {
      padding-inline: 6px;
    }
  }
</style>
</head>
<body>

<div class="subtitle-bar">
  <div class="controls">
    <button id="btnMenu" class="btn-icon" title="Settings">⋮</button>
    <button id="btnPlay" class="btn-icon" title="Start / Stop">▶</button>
    <div id="statusDot" class="status-dot"></div>
  </div>

  <div class="subtitle-text">
    <div id="lineEn" class="line-en">Tap ▶ and speak…</div>
    <div id="lineOther" class="line-other" style="display:none;"></div>
  </div>
</div>

<div id="errorBox" class="error"></div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-backdrop">
  <div class="modal">
    <h2>Subtitle Settings</h2>
    <p>Choose first (spoken) language and the translated second line.</p>

    <label for="spokenLang">First line language (spoken)</label>
    <select id="spokenLang">
      <option value="en" selected>English</option>
      <option value="zh-CN">Chinese</option>
      <option value="ja">Japanese</option>
      <option value="ko">Korean</option>
      <option value="th">Thai</option>
      <option value="tl">Filipino</option>
    </select>

    <label for="subtitleLang">Second line language</label>
    <select id="subtitleLang">
      <option value="none">None (first line only)</option>
      <option value="en">English</option>
      <option value="zh-CN" selected>Chinese</option>
      <option value="ja">Japanese</option>
      <option value="ko">Korean</option>
      <option value="th">Thai</option>
      <option value="tl">Filipino</option>
    </select>

    <label for="fontSizeSelect">Subtitle size</label>
    <select id="fontSizeSelect">
      <option value="medium" selected>Medium (default)</option>
      <option value="small">Small</option>
      <option value="large">Large</option>
      <option value="xlarge">Extra large</option>
    </select>

    <div class="modal-actions">
      <button id="btnCloseModal" class="btn-sm secondary">Close</button>
      <button id="btnSaveModal" class="btn-sm primary">Save</button>
    </div>
  </div>
</div>

<script>
  const btnMenu         = document.getElementById("btnMenu");
  const btnPlay         = document.getElementById("btnPlay");
  const statusDot       = document.getElementById("statusDot");
  const lineEn          = document.getElementById("lineEn");
  const lineOther       = document.getElementById("lineOther");
  const errorBox        = document.getElementById("errorBox");

  const settingsModal   = document.getElementById("settingsModal");
  const btnCloseModal   = document.getElementById("btnCloseModal");
  const btnSaveModal    = document.getElementById("btnSaveModal");
  const spokenLangSel   = document.getElementById("spokenLang");   // first-line language
  const subtitleLangSel = document.getElementById("subtitleLang"); // second-line language
  const fontSizeSelect  = document.getElementById("fontSizeSelect");

  let keepListening = false;
  let lastReqId = 0;

  function srLangCode(code){
    switch (code) {
      case "en":   return "en-US";
      case "zh-CN":return "zh-CN";
      case "ja":   return "ja-JP";
      case "ko":   return "ko-KR";
      case "th":   return "th-TH";
      case "tl":   return "fil-PH";
      default:     return "en-US";
    }
  }

  function showError(msg){
    errorBox.textContent = msg || "";
  }

  function setListeningUI(on){
    if (on){
      btnPlay.classList.add("playing");
      btnPlay.textContent = "⏸";
      statusDot.classList.add("listening");
    } else {
      btnPlay.classList.remove("playing");
      btnPlay.textContent = "▶";
      statusDot.classList.remove("listening");
    }
  }

  // Convert digits to Chinese numerals for any Chinese line
  function convertNumbersToChinese(str) {
    const map = {
      "0":"零","1":"一","2":"二","3":"三","4":"四",
      "5":"五","6":"六","7":"七","8":"八","9":"九"
    };
    return str.replace(/[0-9]/g, d => map[d] || d);
  }

  // Apply font size choice
  function applyFontSize(size){
    switch (size) {
      case "small":
        lineEn.style.fontSize = "13px";
        lineOther.style.fontSize = "12px";
        break;
      case "large":
        lineEn.style.fontSize = "18px";
        lineOther.style.fontSize = "17px";
        break;
      case "xlarge":
        lineEn.style.fontSize = "22px";
        lineOther.style.fontSize = "21px";
        break;
      case "medium":
      default:
        lineEn.style.fontSize = "15px";
        lineOther.style.fontSize = "14px";
        break;
    }
  }

  async function gTransRaw(text, sl, tl){
    const url =
      "https://translate.googleapis.com/translate_a/single?client=gtx" +
      `&sl=${encodeURIComponent(sl)}&tl=${encodeURIComponent(tl)}&dt=t&q=${encodeURIComponent(text)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Network error " + res.status);
    return res.json();
  }

  function extText(data){
    if (!data || !data[0]) return "";
    return data[0].map(seg => seg[0]).join("");
  }

  // Core translation: first line = spokenLang, second line = subtitleLang
  async function doTranslate(text, isLive = false){
    if (isLive && !keepListening) return;

    const trimmed = (text || "").trim();
    if (!trimmed){
      lineEn.textContent = "Tap ▶ and speak…";
      lineOther.style.display = "none";
      lineOther.textContent = "";
      return;
    }

    const firstLang  = spokenLangSel.value || "en";        // L1
    const secondLang = subtitleLangSel.value || "none";    // L2

    const currentReq = ++lastReqId;
    showError("");

    // First line: original in firstLang
    let firstText = trimmed;
    if (firstLang === "zh-CN") {
      firstText = convertNumbersToChinese(firstText);
    }
    lineEn.textContent = firstText;

    // No second line
    if (secondLang === "none") {
      lineOther.style.display = "none";
      lineOther.textContent = "";
      return;
    }

    try {
      let secondPromise;
      if (secondLang === firstLang) {
        // same language: show same text
        secondPromise = Promise.resolve(firstText);
      } else {
        secondPromise = gTransRaw(trimmed, firstLang, secondLang).then(extText);
      }

      secondPromise.then(secText => {
        if (currentReq !== lastReqId) return;

        if (!secText) {
          lineOther.style.display = "none";
          lineOther.textContent = "";
          return;
        }

        if (secondLang === "zh-CN") {
          secText = convertNumbersToChinese(secText);
        }

        lineOther.style.display = "block";
        lineOther.textContent = secText;
      }).catch(err => {
        if (currentReq !== lastReqId) return;
        lineOther.style.display = "none";
        lineOther.textContent = "";
        showError("2nd line error: " + err.message);
      });
    } catch (err){
      if (currentReq !== lastReqId) return;
      console.error(err);
      showError("Translation error: " + err.message);
    }
  }

  /* Speech recognition setup */
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  if (SpeechRecognition){
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
  } else {
    lineEn.textContent = "Speech recognition not supported.";
    showError("This browser does not support the Web Speech API.");
  }

  let liveFinalText = "";
  let liveInterimText = "";

  function updateRecognizerLang(){
    if (!recognition) return;
    // recognizer always follows FIRST language
    recognition.lang = srLangCode(spokenLangSel.value || "en");
  }

  function startListening(){
    if (!recognition || keepListening) return;
    keepListening = true;
    liveFinalText = "";
    liveInterimText = "";
    updateRecognizerLang();
    try { recognition.start(); } catch(e){}
    setListeningUI(true);
  }

  function stopListening(){
    if (!recognition) return;
    keepListening = false;
    try { recognition.stop(); } catch(e){}
    setListeningUI(false);
  }

  if (recognition){
    recognition.onresult = (event) => {
      // keep only the most recent phrase
      for (let i = event.resultIndex; i < event.results.length; i++){
        const res = event.results[i];
        const chunk = res[0].transcript;

        if (res.isFinal){
          liveFinalText = chunk;
          liveInterimText = "";
        } else {
          liveInterimText = chunk;
        }
      }

      const full = (liveInterimText || liveFinalText).trim();
      if (!full) return;

      doTranslate(full, true);
    };

    recognition.onerror = (e) => {
      console.error(e);
      setListeningUI(false);
      keepListening = false;

      if (e.error === "not-allowed" || e.error === "denied") {
        showError("Mic permission denied. Allow microphone access and reload.");
        lineEn.textContent = "Microphone access blocked.";
      } else if (e.error === "no-speech") {
        showError("No speech detected. Try speaking closer to the mic.");
      } else {
        showError("Speech error: " + e.error);
      }
    };

    recognition.onend = () => {
      if (keepListening){
        try { recognition.start(); } catch(e){}
      } else {
        setListeningUI(false);
      }
    };
  }

  /* UI events */
  btnPlay.addEventListener("click", () => {
    if (!recognition){
      showError("Speech recognition not supported in this browser.");
      return;
    }
    if (!keepListening){
      showError("");
      startListening();
    } else {
      stopListening();
    }
  });

  btnMenu.addEventListener("click", () => {
    settingsModal.classList.add("open");
  });

  btnCloseModal.addEventListener("click", () => {
    settingsModal.classList.remove("open");
  });

  btnSaveModal.addEventListener("click", () => {
    settingsModal.classList.remove("open");
    updateRecognizerLang();
    applyFontSize(fontSizeSelect.value);
  });

  settingsModal.addEventListener("click", (e) => {
    if (e.target === settingsModal){
      settingsModal.classList.remove("open");
    }
  });

  spokenLangSel.addEventListener("change", () => {
    updateRecognizerLang();
  });

  // Change font size immediately when dropdown changes
  fontSizeSelect.addEventListener("change", () => {
    applyFontSize(fontSizeSelect.value);
  });

  // init default font size & recognizer language
  applyFontSize("medium");
  updateRecognizerLang();
</script>
</body>
</html>