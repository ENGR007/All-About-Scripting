<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ultimate Real-Time Speech Translator (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { background:#eef2f7; font-family:Arial; padding:18px; }
.container {
  max-width:900px; margin:auto; background:white; padding:20px;
  border-radius:12px; box-shadow:0 3px 12px rgba(0,0,0,0.1);
}
button {
  width:100%; padding:12px; margin-top:10px; font-size:18px;
  border:none; border-radius:8px; color:white; background:#007bff;
}
button:active { opacity:0.6; }
textarea, select {
  width:100%; padding:10px; margin-top:10px; font-size:16px;
}
textarea { height:130px; }
.subtitles {
  background:black; color:#0f0; padding:10px; height:90px;
  border-radius:8px; margin-top:10px; overflow-y:auto;
}
</style>
</head>

<body>

<div class="container">
  <h2>ğŸŒ Ultimate Real-Time Speech Translator (Auto-Detect)</h2>

  <h3>Target Language</h3>
  <select id="targetLang">
    <option value="zh">Chinese ğŸ‡¨ğŸ‡³</option>
    <option value="en">English ğŸ‡ºğŸ‡¸</option>
    <option value="ja">Japanese ğŸ‡¯ğŸ‡µ</option>
    <option value="ko">Korean ğŸ‡°ğŸ‡·</option>
    <option value="tl">Filipino ğŸ‡µğŸ‡­</option>
    <option value="ms">Malay ğŸ‡²ğŸ‡¾</option>
    <option value="id">Indonesian ğŸ‡®ğŸ‡©</option>
    <option value="fr">French ğŸ‡«ğŸ‡·</option>
    <option value="es">Spanish ğŸ‡ªğŸ‡¸</option>
  </select>

  <button id="startBtn">Start Speaking ğŸ¤</button>
  <button id="stopBtn" style="background:#dc3545;">Stop</button>

  <h3>Your Speech</h3>
  <textarea id="spokenText" readonly></textarea>

  <h3>Translation</h3>
  <textarea id="translatedText" readonly></textarea>

  <h3>Live Subtitles</h3>
  <div class="subtitles" id="subtitles"></div>

  <p id="status" style="opacity:.7;">Status: Idle</p>
</div>

<script>
let recognition;

if ("webkitSpeechRecognition" in window)
  recognition = new webkitSpeechRecognition();
else if ("SpeechRecognition" in window)
  recognition = new SpeechRecognition();
else
  alert("Speech Recognition not supported");

recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = "en-US,zh-CN,ja-JP,ko-KR,tl-PH,ms-MY,id-ID,fr-FR,es-ES";

document.getElementById("startBtn").onclick = () => {
  recognition.start();
  document.getElementById("status").innerText = "Status: Listeningâ€¦";
};

document.getElementById("stopBtn").onclick = () => {
  recognition.stop();
  document.getElementById("status").innerText = "Status: Stopped";
};

// ğŸ”¥ Detect language using LibreTranslate
async function detectLanguage(text) {
  try {
    let res = await fetch("https://libretranslate.de/detect", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ q: text })
    });
    let data = await res.json();
    return data[0].language; // returns: en, zh, tl, ja, etc
  } catch {
    return "en";
  }
}

// ğŸ”¥ Translate using detected language
async function translate(text, from, to) {
  let url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`;

  let res = await fetch(url);
  let data = await res.json();
  return data.responseData.translatedText;
}

recognition.onresult = async (event) => {
  let text = "";
  for (let i = event.resultIndex; i < event.results.length; i++)
    text += event.results[i][0].transcript;

  document.getElementById("spokenText").value = text;
  document.getElementById("subtitles").innerHTML = text;

  if (text.trim() === "") return;

  let target = document.getElementById("targetLang").value;

  // 1ï¸âƒ£ Detect language
  let detected = await detectLanguage(text);

  // 2ï¸âƒ£ Translate
  let translated = await translate(text, detected, target);

  document.getElementById("translatedText").value = translated;

  // 3ï¸âƒ£ Speak translation
  speak(translated, target);
};

function speak(text, lang) {
  const synth = window.speechSynthesis;
  if (!synth) return;

  let utter = new SpeechSynthesisUtterance(text);
  utter.lang = lang;
  synth.speak(utter);
}

</script>
</body>
</html>